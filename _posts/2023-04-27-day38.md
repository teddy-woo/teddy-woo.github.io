---
date: 2023-04-27 00:00:00
layout: post
title: DevOps&#91;SECTION2&#93; <AWS ë°°í¬ ìë™í™”> DAY 1 LOG 
subtitle: '<AWS ë°°í¬ ìë™í™”> DAY 1'
description: <AWS ë°°í¬ ìë™í™”> DAY 1
image: /thumbnail/404.jpg
optimized_image: /thumbnail/404.jpg
category: í”„ë¡œì íŠ¸ íšŒê³ 
tags:
  - AWS
  - ECR
  - ìë™í™”
  - Docker
  - mongo DB
  - NoSql
  - HTTPS
  - HTTP
  - POSTMAN
  - íšŒê³ 
  - DevOps BootCamp
author: teddy-woo

---

# #í•™ìŠµ ëª©í‘œ

- WASë¥¼ Docker Imageë¡œ ë¹Œë“œí•˜ì—¬ ì»¨í…Œì´ë„ˆí™”
- ì»¨í…Œì´ë„ˆí™”í•œ WASë¥¼ Registryì— Push
- ê¸°ì¡´ì— ë°°í¬ëœ Docker Imageë¥¼ í™œìš©/ì‹¤í–‰
- mongoDB ê¸°ì¤€
- Docker Composeë¥¼ ì´ìš©í•´, WASì™€ DBë¥¼ í•œ ë²ˆì— ì‹¤í–‰
- WAS ì´ë¯¸ì§€ ë¹Œë“œ ë° push ìë™í™”ë¥¼ êµ¬í˜„
- ECR ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ëŠ” ë°©ë²•ì„ ë°°ì›ë‹ˆë‹¤

# #í•´ê²° ê³¼ì œ

ğŸ’¡ ë§ˆì¼ìŠ¤í†¤1Â -Â HelloÂ WorldÂ ì„œë²„Â ì»¨í…Œì´ë„ˆí™”

ğŸ’¡ ë§ˆì¼ìŠ¤í†¤2Â -Â docker-composeÂ ì‘ì„±

ğŸ’¡ ë§ˆì¼ìŠ¤í†¤3Â -Â ì´ë¯¸ì§€Â repositoryÂ pushÂ ìë™í™”

# #ê³¼ì œ í•­ëª©ë³„ ì§„í–‰ ìƒí™©

# **âœï¸Â Â ë§ˆì¼ìŠ¤í†¤1Â -Â HelloÂ WorldÂ ì„œë²„Â ì»¨í…Œì´ë„ˆí™”**

# Step 1 : ì—°ìŠµê³¼ì œ:Â HelloÂ WorldÂ ì„œë²„Â ì‘ì„±

1. fastify-cli ì„¤ì¹˜

```
$ npm i --global fastify-cli
```

2. fastify í”„ë¡œì íŠ¸ ìƒì„± í›„ npm install

```
$ fastify generate helloworld-was
$ npm install
```

3. ë¡œì»¬ì—ì„œ ì„œë²„ ê¸°ë™ í™•ì¸

```
$ npm run start
```

# Step 2 : ì‹¤ì „ê³¼ì œ: ì„œë²„ ì»¨í…Œì´ë„ˆí™”ì™€ ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¡œ push

1. Fastifyë¡œ ë§Œë“  Hello World ì„œë²„ë¥¼ ì»¨í…Œì´ë„ˆí™”í•˜ê¸° ìœ„í•´ Dockerfileì„ ì‘ì„±

```
# file name : ../Devops-04-S2-Team9/helloworld-was/Dockerfile

# ì‚¬ìš©í•  ì´ë¯¸ì§€ ì§€ì •
FROM node:18-alpine
ENV NODE_ENV=production

# ì´ë¯¸ì§€ ì•ˆì— ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œë¥¼ ë„£ê¸° ìœ„í•œ ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ê°€ëŠ¥í•œ ê²½ìš°(npm@5+) package.jsonê³¼ package-lock.jsonì„ ëª¨ë‘ ë³µì‚¬í•˜ê¸° ìœ„í•´ ì™€ì¼ë“œì¹´ë“œë¥¼ ì‚¬ìš©
COPY ["package.json", "package-lock.json*", "./"]

# ì´ ì´ë¯¸ì§€ì—ëŠ” ì´ë¯¸ Node.jsì™€ NPMì´ ì„¤ì¹˜ë˜ì–´ ìˆìœ¼ë¯€ë¡œ npm ë°”ì´ë„ˆë¦¬ë¡œ ì•±ì˜ ì˜ì¡´ì„±ì„ ì„¤ì¹˜í•˜ê¸°ë§Œ í•˜ë©´ ë¨
# ì•± ì˜ì¡´ì„± ì„¤ì¹˜
RUN npm install --production

# ë„ì»¤ ì´ë¯¸ì§€ ì•ˆì— ì•±ì˜ ì†ŒìŠ¤ ì½”ë“œë¥¼ ì¶”ê°€
COPY . .

# ì•±ì´ ë°”ì¸ë”© ë˜ì–´ ìˆëŠ” í¬íŠ¸ì™€ docker ë°ëª¬ ë§¤í•‘
#EXPOSE 3000

# ëŸ°íƒ€ì„ì„ ì •ì˜í•˜ëŠ” CMDë¡œ ì•± ì‹¤í–‰ ëª…ë ¹ì–´ë¥¼ ì •ì˜(ì„œë²„ë¥¼ êµ¬ë™í•˜ë„ë¡ node app.jsì„ ì‹¤í–‰í•˜ëŠ” ê¸°ë³¸ npm startì„ ì‚¬ìš©)
CMD npm start
```

2. tagëŠ” 1.0ìœ¼ë¡œ ì´ë¯¸ì§€ ë¹Œë“œ í›„, ë¡œì»¬ì—ì„œ ì‹¤í–‰í•´ ì„œë²„ê°€ ì˜ ì‘ë™ë˜ëŠ”ì§€ í™•ì¸

```
# ë¹Œë“œ
$ docker build --tag <ë ˆíŒŒì§€í† ë¦¬ëª…>/ì´ë¯¸ì§€ëª…:tag .

# ì´ë¯¸ì§€ê°€ ì˜ ë¹Œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
$ docker images

# -p ì˜µì…˜ì€ í˜¸ìŠ¤íŠ¸ í¬íŠ¸:ì»¨í…Œì´ë„ˆ í¬íŠ¸
# -d ì˜µì…˜ì€ background ì‹¤í–‰
$ docker run --name <ì»¨í…Œì´ë„ˆëª…> -p 3000:3000 -d <ë ˆíŒŒì§€í† ë¦¬ëª…>/ì´ë¯¸ì§€ëª…:tag

# ìš”ì²­ í™•ì¸
$ curl http://localhost:3000
```

3. AWSì˜ ì•¡ì„¸ìŠ¤ í‚¤ì™€ ì‹œí¬ë¦¿ì„ ì´ìš©í•´ CLIë¡œ ë¡œê·¸ì¸í•˜ê³ , ECRì— ì´ë¯¸ì§€ë¥¼ push

3-1. ECR í”„ë¼ì´ë¹— ë¦¬í¬ì§€í† ë¦¬ ìƒì„±

1. Amazon ECR ì½˜ì†”([https://console.aws.amazon.com/ecr/repositories](https://console.aws.amazon.com/ecr/repositories)) > íƒìƒ‰ ëª¨ìŒì—ì„œ ë¦¬í¬ì§€í† ë¦¬ë¥¼ ìƒì„±í•  ë¦¬ì „ì„ ì„ íƒ
2. íƒìƒ‰ ì°½ì—ì„œÂ **ë¦¬í¬ì§€í† ë¦¬**ë¥¼ ì„ íƒ
3. **ë¦¬í¬ì§€í† ë¦¬(Repositories)**Â í˜ì´ì§€ì—ì„œÂ **í”„ë¼ì´ë¹—(Private)**Â íƒ­ì„ ì„ íƒí•œ ë‹¤ìŒÂ **ë¦¬í¬ì§€í† ë¦¬ ìƒì„±(Create repository)**ì„ ì„ íƒ
4. **ê°€ì‹œì„± ì„¤ì •(Visibility settings)**ì—ì„œÂ **í”„ë¼ì´ë¹—(Private)**ì´ ì„ íƒë˜ì—ˆëŠ”ì§€ í™•ì¸
5. **ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„(Repository name)**ì— ë¦¬í¬ì§€í† ë¦¬ì˜ ê³ ìœ í•œ ì´ë¦„ì„ ì…ë ¥ (ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„ì€ ìì²´ì ìœ¼ë¡œ ì§€ì •í•  ìˆ˜ ìˆìœ¼ë©°(ì˜ˆ:Â nginx-web-app), ë¦¬í¬ì§€í† ë¦¬ë¥¼ ë²”ì£¼ë¡œ ê·¸ë£¹í™”í•˜ê¸° ìœ„í•´ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ì¶”ê°€ ê°€ëŠ¥)
6. **íƒœê·¸ ë¶ˆë³€ì„±(Tag immutability)**ì—ì„œ ë¦¬í¬ì§€í† ë¦¬ì˜ íƒœê·¸ ë³€ê²½ ê°€ëŠ¥ ì„¤ì •ì„ ì„ íƒ (ë³€ê²½ ë¶ˆê°€ëŠ¥ íƒœê·¸ë¡œ êµ¬ì„±ëœ ë¦¬í¬ì§€í† ë¦¬ëŠ” ì´ë¯¸ì§€ íƒœê·¸ë¥¼ ë®ì–´ì“°ëŠ” ê²ƒì„ ë°©ì§€í•´ ì¤Œ, ìì„¸í•œ ë‚´ìš©ì€Â [ì´ë¯¸ì§€ íƒœê·¸ ë³€ê²½ ê°€ëŠ¥ì„±](https://docs.aws.amazon.com/ko_kr/AmazonECR/latest/userguide/image-tag-mutability.html)Â ì„¹ì…˜ì„ ì°¸ì¡°)
7. **í‘¸ì‹œ ì‹œ ìŠ¤ìº”**ì˜ ê²½ìš° ê¸°ë³¸ ìŠ¤ìº”ì„ ìœ„í•´ ë¦¬í¬ì§€í† ë¦¬ ìˆ˜ì¤€ì—ì„œ ìŠ¤ìº” ì„¤ì •ì„ ì§€ì •í•  ìˆ˜ ìˆì§€ë§Œ í”„ë¼ì´ë¹— ë ˆì§€ìŠ¤íŠ¸ë¦¬ ìˆ˜ì¤€ì—ì„œ ìŠ¤ìº” êµ¬ì„±ì„ ì§€ì •í•˜ëŠ” ê²ƒ ê¶Œì¥(í”„ë¼ì´ë¹— ë ˆì§€ìŠ¤íŠ¸ë¦¬ì—ì„œ ìŠ¤ìº” ì„¤ì •ì„ ì§€ì •í•˜ë©´ ê³ ê¸‰ ìŠ¤ìº” ë˜ëŠ” ê¸°ë³¸ ìŠ¤ìº”ì„ ì‚¬ìš©í•˜ê³  í•„í„°ë¥¼ ì •ì˜í•˜ì—¬ ìŠ¤ìº”í•  ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì§€ì • ê°€ëŠ¥, ìì„¸í•œ ë‚´ìš©ì€Â [ì´ë¯¸ì§€ ìŠ¤ìº”](https://docs.aws.amazon.com/ko_kr/AmazonECR/latest/userguide/image-scanning.html)Â ì„¹ì…˜ì„ ì°¸ì¡°)
8. **KMS ì•”í˜¸í™”(KMS encryption)**ì˜ ê²½ìš°, AWS Key Management Serviceë¥¼ ì‚¬ìš©í•˜ì—¬ ë¦¬í¬ì§€í† ë¦¬ì— ìˆëŠ” ì´ë¯¸ì§€ì˜ ì•”í˜¸í™”ë¥¼ í™œì„±í™”í• ì§€ ì„ íƒ(ìì„¸í•œ ë‚´ìš©ì€Â [ì €ì¥ëœ ë°ì´í„° ì•”í˜¸í™”](https://docs.aws.amazon.com/ko_kr/AmazonECR/latest/userguide/encryption-at-rest.html)Â ì„¹ì…˜ì„ ì°¸ì¡°)
9. KMS ì•”í˜¸í™”ê°€ í™œì„±í™”ëœ ê²½ìš°Â **ê³ ê° ì•”í˜¸í™” ì„¤ì •(ê³ ê¸‰)(Customer encryption settings (advanced))**ì„ ì„ íƒí•˜ì—¬ ê³ ìœ ì˜ KMS í‚¤ë¥¼ ì„ íƒ (KMS í‚¤ê°€ í´ëŸ¬ìŠ¤í„°ì™€ ë™ì¼í•œ ë¦¬ì „ì— ìˆì–´ì•¼í•˜ë©°,Â **AWS KMS í‚¤ ìƒì„±(Create an key)**ì„ ì„ íƒí•˜ê³  AWS KMS ì½˜ì†”ë¡œ ì´ë™í•˜ì—¬ ê³ ìœ í•œ í‚¤ë¥¼ ìƒì„±)
10. **ë¦¬í¬ì§€í† ë¦¬ ìƒì„±(Create repository)**ì„ ì„ íƒ
11. (ì„ íƒ ì‚¬í•­) ìƒì„±í•œ ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì„ íƒí•˜ê³ Â **í‘¸ì‹œ ëª…ë ¹ ë³´ê¸°(View push commands)**ë¥¼ ì„ íƒí•˜ì—¬ ì´ë¯¸ì§€ë¥¼ ìƒˆ ë¦¬í¬ì§€í† ë¦¬ì— í‘¸ì‹œí•˜ëŠ” ë‹¨ê³„ í™•ì¸ ê°€ëŠ¥ (ë¦¬í¬ì§€í† ë¦¬ë¡œ ì´ë¯¸ì§€ë¥¼ í‘¸ì‹œí•˜ëŠ” ë°©ë²•ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€Â [ì´ë¯¸ì§€ í‘¸ì‹œ](https://docs.aws.amazon.com/ko_kr/AmazonECR/latest/userguide/image-push.html)Â ì„¹ì…˜ì„ ì°¸ì¡°)

3-2. ECR í”„ë¼ì´ë¹— ë¦¬í¬ì§€í† ë¦¬ì— DockerÂ ì´ë¯¸ì§€Â í‘¸ì‹œ

```
# AWS CLIë¥¼ ì´ìš©í•´ ECR ë ˆíŒŒì§€í† ë¦¬ì— ë¡œê·¸ì¸
$ aws ecr get-login-password --region <ECR REGION> | docker login --username AWS --password-stdin 123456789012.dkr.ecr.<ECR REGION>.amazonaws.com

# í•„ìš”ì‹œ AWS ì„¤ì •ê°’ ì„¤ì •
$ aws configure

# ë¡œê·¸ì¸ ì™„ë£Œ í›„ ì´ë¯¸ì§€ íƒœê·¸ë¥¼ ì¡°íšŒí•˜ê¸° ìœ„í•´ ë„ì»¤ ì´ë¯¸ì§€ ì¡°íšŒ
docker images

# í‘¸ì‹œí•  ì´ë¯¸ì§€ íƒœê·¸ì— íƒœê¹…
docker tag e9ae3c220b23 123456789012.dkr.ecr.<ECR REGION>.amazonaws.com/<ë ˆíŒŒì§€í† ë¦¬ëª…>:<íƒœê·¸>

# ECR ë ˆíŒŒì§€í† ë¦¬ë¡œ í‘¸ì‹œ
docker push 123456789012.dkr.ecr.<ECR REGION>.amazonaws.com/<ë ˆíŒŒì§€í† ë¦¬ëª…>:<íƒœê·¸>
```

3-3. ECR ì½˜ì†” > ë ˆíŒŒì§€í† ë¦¬ë¡œ ì ‘ê·¼í•´ì„œ ì •ìƒì ìœ¼ë¡œ pushë˜ì—ˆëŠ”ì§€ í™•ì¸

# **âœï¸Â ë§ˆì¼ìŠ¤í†¤2Â -Â docker-composeÂ ì‘ì„±**

# Step 1 : ì—°ìŠµê³¼ì œ:Â mongoDBÂ ë„ì»¤ë¡œÂ ì‹¤í–‰í•˜ê¸°

1. docker hubì— ë°°í¬ëœÂ [mongodb ì´ë¯¸ì§€](https://hub.docker.com/_/mongo)ë¥¼ ì´ìš©í•´ ì»¨í…Œì´ë„ˆ êµ¬ë™

- ì˜µì…˜ ë“± ìì„¸í•œ ë‚´ìš©ì€ docker hubì˜ mongo ì´ë¯¸ì§€ í˜ì´ì§€ì—ì„œ í™•ì¸ ê°€ëŠ¥

```
# ì´ë¯¸ì§€ê°€ ì—†ì„ ê²½ìš° ë ˆì§€ìŠ¤íŠ¸ë¦¬ì—ì„œ ìë™ìœ¼ë¡œ pull
$  docker run --name some-mongo -d mongo:latest

# port ì§€ì •í•´ mongodb ì»¨í…Œì´ë„ˆ êµ¬ë™
$  docker run --name some-mongo -p 27017:27017 -d mongo:latest

# ì´ˆê¸°í™” root userì™€ passwordë¥¼ ì§€ì •í•´ ì»¨í…Œì´ë„ˆ êµ¬ë™
$  docker run -d --name some-mongo -e MONGO_INITDB_ROOT_USERNAME=root -e MONGO_INITDB_ROOT_PASSWORD=secret -p 27017:27017 mongo:latest
```

2.Â [mongoDB compass](https://www.mongodb.com/ko-kr/products/compass)ë¥¼ ì´ìš©í•´ ì‹¤ì œ ì»¨í…Œì´ë„ˆì— ì ‘ì† ê°€ëŠ¥í•œì§€ í™•ì¸

3.Â [docker compose](https://docs.docker.com/compose/compose-file/05-services/)Â íŒŒì¼ì„ ì´ìš©í•´ ì»¨í…Œì´ë„ˆ ì‹¤í–‰

```scala
version: '3.1'

services:
  mongo: # ì„œë¹„ìŠ¤ëª… ì§€ì •
    image: mongo # ì‚¬ìš©í•  ì´ë¯¸ì§€ ì§€ì • (ì´ ê²½ìš° íƒœê·¸ë¥¼ ìƒëµí•˜ê³  latest ë²„ì „ìœ¼ë¡œ ì‚¬ìš©)
    ports: # host í¬íŠ¸ì™€ container í¬íŠ¸ë¥¼ ë§¤í•‘
      - "27017:27017"
    environment: # ì´ˆê¸° í™˜ê²½ ì„¤ì •
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: secret
    container_name: mongodb # ì»¨í…Œì´ë„ˆëª…ì„ ì§€ì •
```

# Step 2 : ì‹¤ì „ê³¼ì œ:Â ì„œë²„ì™€Â mongodbë¥¼Â í•œêº¼ë²ˆì—Â dockerÂ composeë¡œÂ ì‹¤í–‰í•˜ê¸°

1. ì›¹ ì„œë²„ ì½”ë“œë¥¼ ë³€ê²½í•˜ì—¬, mongodbì™€ì˜ ì ‘ì†ì„ í™•ì¸

1-1.Â [dotenv](https://www.npmjs.com/package/dotenv)Â ì„¤ì¹˜ í›„ .env íŒŒì¼ ìƒì„±í•´ DB ì—°ê²° ê´€ë ¨ ì •ë³´ ì„¤ì •

```
$npm i dotenv
```

```scala
# file name : ../Devops-04-S2-Team9/helloworld-was/.env

DB_HOSTNAME=mongo
DB_USERNAME=root
DB_PASSWORD=secret
DB_DATABASE=devops04
DB_PORT=27017
```

1-2. fasÂ [@fastify/mongodb](https://github.com/fastify/fastify-mongodb)Â ì„¤ì¹˜ í›„ plugins ë””ë ‰í† ë¦¬ í•˜ìœ„ì— DB ì—°ê²° registerë¥¼ ë“±ë¡í•˜ê¸° ìœ„í•´Â  mongodb.js ìƒì„±

```
$ npm i @fastify/mongodb
```

```jsx
// file name : ../Devops-04-S2-Team9/helloworld-was/plugins/mongodb.js

const fp = require('fastify-plugin')
const { DB_HOSTNAME, DB_USERNAME, DB_PASSWORD, DB_PORT, DB_DATABASE} = process.env

module.exports = fp(async function (fastify, opts) {

  fastify.register(require('@fastify/mongodb'), {
    // force to close the mongodb connection when app stopped
    // the default value is false
    forceClose: true,
    url: `mongodb://${DB_USERNAME}:${DB_PASSWORD}@${DB_HOSTNAME}:${DB_PORT}/?authMechanism=DEFAULT`
  })
})
```

1-3. ì›¹ ì„œë²„ì—ì„œ ì‹¤ì œë¡œ dbì— ì˜ ì—°ê²°ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•œ í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±

```jsx
// file name : ../Devops-04-S2-Team9/helloworld-was/routes/example/index.js

'use strict'

module.exports = async function (fastify, opts) {
  fastify.get('/', async function (request, reply) {
    console.log(`[INFO] Mongo DB Connection Try..`)
    const client = await fastify.mongo.client.connect();
    try {
      if (client !== null) {
        console.log(`[INFO] Mongo DB Connection Success!`)
        console.log(client)
        reply.code(200).send(`Mongo DB Connection Success!`)
      }
    } finally {
      client.close();
    }
  })
}
```

2. tag 1.1ë¡œ ì›¹ ì„œë²„ ì´ë¯¸ì§€ë¥¼ ìƒˆë¡­ê²Œ ë¹Œë“œ

```
# ë¹Œë“œ
$ docker build --tag <ë ˆíŒŒì§€í† ë¦¬ëª…>/helloworld:1.1 .

# ì´ë¯¸ì§€ê°€ ì˜ ë¹Œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
$ docker images
```

3. ì»¨í…Œì´ë„ˆí™” í•œ ì›¹ ì„œë²„ ì´ë¯¸ì§€ì™€, mongodbë¥¼ ë™ì‹œì— ì‹¤í–‰í•˜ê¸° ìœ„í•œ docker compose íŒŒì¼ ì‘ì„±

```scala
# file name : ../Devops-04-S2-Team9/docker-compose.yml
version: '3.1'

services:
  fastify:
    image: "<ë ˆíŒŒì§€í† ë¦¬ëª…>/helloworld:1.1"
    ports:
      - "3000:3000"
    container_name: server
    links:
      - mongo
    restart: on-failure # ì„œë²„ ê¸°ë™ ì‹¤íŒ¨ ì‹œ ì¬ê¸°ë™

  mongo:
    image: mongo
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: secret
    container_name: mongodb
```

4. docker compose up ëª…ë ¹ì–´ë¥¼ ì´ìš©í•´ ë‘ ì„œë²„ê°€ ì •ìƒì ìœ¼ë¡œ ê¸°ë™ë˜ëŠ”ì§€ í™•ì¸ ë° ë¸Œë¼ìš°ì €ì— ì ‘ì†í•´ ì—°ê²° í™•ì¸

```
$ docker compose up
```

5. docker compose down ëª…ë ¹ì–´ë¥¼ ì´ìš©í•´ ê¸°ë™ëœ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ

`$ docker compose down`

# **âœï¸Â ë§ˆì¼ìŠ¤í†¤3 - ì´ë¯¸ì§€ repository push ìë™í™”**

# Step 1 : ì‹¤ì „ê³¼ì œ:Â ë ˆì§€ìŠ¤íŠ¸ë¦¬Â pushÂ ìë™í™”

1. ë¹Œë“œ ìë™í™”ë¥¼ ìœ„í•œÂ [githubaction yaml íŒŒì¼](https://docs.github.com/ko/actions/publishing-packages/publishing-docker-images)Â ì‘ì„±

[
Docker ì´ë¯¸ì§€ ê²Œì‹œ - GitHub Docs
ì†Œê°œ ì´ ê°€ì´ë“œì—ì„œëŠ” Docker ë¹Œë“œë¥¼ ìˆ˜í–‰í•˜ëŠ” ì›Œí¬í”Œë¡œë¥¼ ë§Œë“  ë‹¤ìŒ, Docker ì´ë¯¸ì§€ë¥¼ Docker Hub ë˜ëŠ” GitHub Packagesì— ê²Œì‹œí•˜ëŠ” ë°©ë²•ì„ ë³´ì—¬ ì¤ë‹ˆë‹¤. ë‹¨ì¼ ì›Œí¬í”Œë¡œë¥¼ ì‚¬ìš©í•˜ì—¬ ë‹¨ì¼ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë˜ëŠ”
docs.github.com](https://docs.github.com/ko/actions/publishing-packages/publishing-docker-images)

2. GithubActionì„ í†µí•´ AWS ECRì— PUSHí•˜ê¸° ìœ„í•œ IAM ì—­í•  ìƒì„±

3. ì´ë¯¸ì§€ ë¹Œë“œ ë° AWS ECR í‘¸ì‹œ ìë™í™”ë¥¼ ìœ„í•œ GithubAction File ì‘ì„±

```scala
# file name : ../Devops-04-S2-Team9/.github/workflows/ecr-build-push.yml
name: build and push docker image to AWS ECR

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  role_arn: ${{ secrets.ECR_ROLE_ARN }}
  aws_region: "ap-northeast-2"
  repository: "ë ˆíŒŒì§€í† ë¦¬ëª…"
  aws_image_tag: ${{ github.sha }}
  image_name: "ì´ë¯¸ì§€ëª…"

jobs:
  build_and_push_ecs: # job ê³ ìœ  ì‹ë³„ì
    name: "# ECR ë¡œê·¸ì¸ í›„ ë„ì»¤ ì´ë¯¸ì§€ BUILD, ECRì— PUSH"
    runs-on: ubuntu-latest

    permissions:
      id-token: write   # This is required for requesting the JWT
      contents: read    # This is required for actions/checkout

    steps:
      - name: "1. github runnerì— ë ˆíŒŒì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ"
        uses: actions/checkout@v3

      # Before each of the following examples, make sure to include the following:
      - name: "2. AWS credential ì„¤ì •"
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-region: ${{ env.aws_region }}
          role-session-name: GitHubActions
          role-to-assume: ${{ env.role_arn }}

      # Login to Amazon ECR Private, then build and push a Docker image: (cf. public)
      - name: "3. AMAZON ECR ë¡œê·¸ì¸"
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: "4. ë„ì»¤ ì´ë¯¸ì§€ Build & AMAZON ECRì— ë„ì»¤ ì´ë¯¸ì§€ PUSH"
        run: |
          cd ./helloworld-was
          docker build -t ${{ steps.login-ecr.outputs.registry }}/${{ env.repository }}:${{ env.aws_image_tag }} .
          docker push ${{ steps.login-ecr.outputs.registry }}/${{ env.repository }}:${{ env.aws_image_tag }}
```

# #TROUBLE SHOOTING LOG

# ğŸ“ ë¬¸ì œ 1 : fastify ì»¨í…Œì´ë„ˆ êµ¬ë™ ì‹¤íŒ¨ (exited) (1)

- ì›ì¸ : Dockerfile cmdë¥¼ node app.jsë¡œ ì‘ì„±í–ˆê¸° ë•Œë¬¸
- í•´ê²° ë°©ì•ˆ : node ëª…ë ¹ì–´ë¥¼ npm run startë¡œ ë³€ê²½
- ì°¸ê³ 
    1. node ëª…ë ¹ì–´: ë‹¨ìˆœíˆ ìë°”ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì„œë²„ë¡œ êµ¬ë™í•˜ëŠ” ëª…ë ¹ì–´
    2. npm start: package.jsonì—ì˜ scriptsì—ì„œ startë¡œ ì‹¤í–‰í•˜ëŠ” ëª…ë ¹ì–´

# ğŸ“Â ë¬¸ì œ 2 : fastify ì»¨í…Œì´ë„ˆ êµ¬ë™ ì‹¤íŒ¨ (exited) (2)

- ì›ì¸ : fastify ë…¸ì¶œ í¬íŠ¸ì™€ container êµ¬ë™ ì‹œ 8000:8000í¬íŠ¸ë¡œ êµ¬ë™í•´ì„œ fastify ê¸°ë³¸ í¬íŠ¸ì¸ 3000í¬íŠ¸ì™€ ë¶ˆì¼ì¹˜
- í•´ê²° ë°©ì•ˆ : 3000í¬íŠ¸ë¡œ ì»¨í…Œì´ë„ˆ êµ¬ë™

# ğŸ“ ë¬¸ì œ 3 : fastify - mongo db ì—°ë™ ì‹œ ì„œë²„ timeout ì¢…ë£Œ

- ì›ì¸ : mongodbê°€ ë¡œë“œë˜ê¸° ì „ì— fastifyì—ì„œ ì°¸ì¡°í•˜ê¸° ë•Œë¬¸ì— ë°œìƒí•œ í˜„ìƒ
- í•´ê²° ë°©ì•ˆ : docker-compose.ymlì— restart ì§€ì‹œì–´ë¥¼ ì´ìš©í•´ ê¸°ë™ ì‹¤íŒ¨ì‹œ ì¬ì‹œë„í•˜ë„ë¡ ìˆ˜ì •

# ğŸ“ ë¬¸ì œ 4 : mongodb ì»¤ë„¥ì…˜ ì—°ê²° í™•ì¸

- ì›ì¸ : fastify.mongo ê°ì²´ ì‚¬ìš©ë²•ì´ ìƒì†Œ
- í•´ê²° ë°©ì•ˆ :Â [fastify mongo ê°ì²´ ë ˆí¼ëŸ°ìŠ¤](http://mongodb.github.io/node-mongodb-native/3.3/api/index.html)Â ì°¸ê³ 

# ğŸ“ ë¬¸ì œ 5 : ì•„ë§ˆì¡´ ECR IAM ROLE ìƒì„±

- ìƒí™© : access keyë¥¼ ì´ìš©í•˜ì§€ ì•Šê³  ECRì— ë¡œê·¸ì¸í•˜ê¸° ìœ„í•´ IAM ROLE ìƒì„±
- í•´ê²° ë°©ì•ˆ :Â [OpenID Connection](https://docs.github.com/ko/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect)ì„ ì´ìš©í•´ GitHub Actions ì›Œí¬í”Œë¡œê°€ ì•¡ì„¸ìŠ¤ í‚¤, ì‹œí¬ë¦¿ í‚¤ë¥¼ ë…¸ì¶œí•˜ì§€ ì•Šê³  AWS(Amazon Web Services)ì˜ ë¦¬ì†ŒìŠ¤ì— ì•¡ì„¸ìŠ¤ ê°€ëŠ¥
- í•´ê²° ê³¼ì •

1.Â [IAM ìê²© ì¦ëª… ê³µê¸‰ì ë¦¬ì†ŒìŠ¤ë¥¼ ìƒì„±](https://docs.github.com/ko/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services)

![https://blog.kakaocdn.net/dn/2mAFv/btsdi2512RZ/B0MzOft5l5iFMriNbkjbYK/img.png](https://blog.kakaocdn.net/dn/2mAFv/btsdi2512RZ/B0MzOft5l5iFMriNbkjbYK/img.png)

2. ì›¹Â ìê²©Â ì¦ëª…Â ë˜ëŠ”Â [OIDCë¥¼Â ìœ„í•œÂ ì—­í• Â ìƒì„±](https://docs.aws.amazon.com/ko_kr/IAM/latest/UserGuide/id_roles_create_for-idp_oidc.html)

![https://blog.kakaocdn.net/dn/C9iJ5/btsdlJSEoG1/9zhjPgGCnIjVvgiirVkkd1/img.png](https://blog.kakaocdn.net/dn/C9iJ5/btsdlJSEoG1/9zhjPgGCnIjVvgiirVkkd1/img.png)

1. íƒìƒ‰ ì°½ì—ì„œÂ **ì—­í• (Roles)**ì„ ì„ íƒí•œ í›„Â **ì—­í•  ìƒì„±(Create role)**ì„ ì„ íƒ
2. **ì›¹ ID(Web Identity)**Â ì—­í•  ìœ í˜•ì„ ì„ íƒ
3. **ìê²© ì¦ëª… ê³µê¸‰ì(Identity provider)**ì—ì„œ ì—­í• ì˜ IdPë¥¼ ì„ íƒ
4. **Audience**ì—ì„œ ì§€ì •í•œ ìê²©ì¦ëª… ê³µê¸‰ìì˜ ëŒ€ìƒ ì„ íƒ
5. ê¶Œí•œ ì •ì±…ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì •ì±…ì„ ì„ íƒí•˜ê±°ë‚˜Â **ì •ì±… ìƒì„±(Create policy)**ì„ ì„ íƒí•˜ì—¬ ìƒˆ ë¸Œë¼ìš°ì € íƒ­ì„ ì—´ê³  ì™„ì „íˆ ìƒˆë¡œìš´ ì •ì±…ì„ ìƒì„±í•  ìˆ˜ ìˆìŒ(ìì„¸í•œ ë‚´ìš©ì€Â [IAM ì •ì±… ìƒì„±](https://docs.aws.amazon.com/ko_kr/IAM/latest/UserGuide/access_policies_create-console.html#access_policies_create-start)Â ì„¹ì…˜ì„ ì°¸ì¡°)
    - ì›¹ ID ì‚¬ìš©ìì—ê²Œ ë¶€ì—¬í•˜ë ¤ëŠ” ê¶Œí•œ ì •ì±… ì˜†ì˜ í™•ì¸ë€ì„ ì„ íƒ ì›í•  ê²½ìš°, ì—¬ê¸°ì„œ ì •ì±…ì„ ì„ íƒí•˜ì§€ ì•Šê³  ë‚˜ì¤‘ì— ì •ì±…ì„ ë§Œë“¤ì–´ì„œ ì—­í• ì— ì—°ê²°í•  ìˆ˜ ìˆìŒ (ê¸°ë³¸ì ìœ¼ë¡œ ì—­í• ì€ ê¶Œí•œì´ ì—†ìŒ)
6. **ì—­í•  ì´ë¦„(Role name)**ì— ì—­í•  ì´ë¦„ì„ ì…ë ¥
    - ì—­í•  ì´ë¦„ì€ AWS ê³„ì • ë‚´ì—ì„œ ê³ ìœ í•´ì•¼í•˜ë©° ëŒ€ì†Œë¬¸ìë¥¼ êµ¬ë¶„í•˜ì§€ ì•ŠìŒ
    - ë‹¤ë¥¸ AWS ë¦¬ì†ŒìŠ¤ê°€ ì—­í• ì„ ì°¸ì¡°í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ì—­í• ì„ ìƒì„±í•œ í›„ì—ëŠ” ì—­í•  ì´ë¦„ì„ í¸ì§‘í•  ìˆ˜ ì—†ìŒ
7. ì—­í• ì— ëŒ€í•œ ì‚¬ìš© ì‚¬ë¡€ì™€ ê¶Œí•œì„ í¸ì§‘í•˜ë ¤ë©´Â **1ë‹¨ê³„: ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì—”í„°í‹° ì„ íƒ(Step 1: Select trusted entities)**Â ë˜ëŠ”Â **2ë‹¨ê³„: ê¶Œí•œ ì¶”ê°€(Step 2: Add permissions)**Â ì„¹ì…˜ì—ì„œÂ **í¸ì§‘(Edit)**ì„ ì„ íƒ
8. ì—­í• ì„ ê²€í† í•œ ë‹¤ìŒ [**Create role**]ì„ ì„ íƒ

3. GitHubÂ OIDCÂ IDÂ ì œê³µìì˜Â [ì—­í• ](https://docs.github.com/ko/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services)Â êµ¬ì„±

```jsx
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": { # OIDC Role ARN
                "Federated": "arn:aws:iam::123456123456:oidc-provider/token.actions.githubusercontent.com"
            },
            "Action": "sts:AssumeRoleWithWebIdentity",
            "Condition": {
                "StringLike": {
                    "token.actions.githubusercontent.com:sub": "repo:<GitHub ì¡°ì§ëª…>/<ë ˆíŒŒì§€í† ë¦¬ëª…>:*"
                },
                "StringEquals": {
                    "token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
                }
            }
        }
    ]
}
```

| í´ë ˆì„ | í´ë ˆì„ ìœ í˜• | ì„¤ëª… |
| --- | --- | --- |
| aud | ì‚¬ìš©ì | - ê¸°ë³¸ì ìœ¼ë¡œ ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì†Œìœ í•˜ëŠ” organization ê°™ì€ ë¦¬í¬ì§€í† ë¦¬ ì†Œìœ ìì˜ URL- ì‚¬ìš©ì ì§€ì •í•  ìˆ˜ ìˆëŠ” ìœ ì¼í•œ í´ë ˆì„ë„êµ¬ í‚¤íŠ¸ ëª…ë ¹-Â https://www.npmjs.com/package/@actions/core/v/1.6.0ì„ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ì ì§€ì • ëŒ€ìƒ ê·¸ë£¹ì„ ì„¤ì • ê°€ëŠ¥ |
| iss | ë°œê¸‰ì | -OIDC í† í° ë°œê¸‰ì:Â https://token.actions.githubusercontent.com/ |
| sub | ì œëª© | - í´ë¼ìš°ë“œ ê³µê¸‰ìê°€ ìœ íš¨ì„±ì„ ê²€ì‚¬í•  ì£¼ì²´ í´ë ˆì„ì„ ì •ì˜- ì´ ì„¤ì •ì€ ì•¡ì„¸ìŠ¤ í† í°ì´ ì˜ˆì¸¡ ê°€ëŠ¥í•œ ë°©ì‹ìœ¼ë¡œë§Œ í• ë‹¹ë˜ë„ë¡ í•˜ëŠ” ë° í•„ìˆ˜ |

4.Â [ECR ë¡œê·¸ì¸ì„ ìœ„í•œ ê¶Œí•œ](https://github.com/marketplace/actions/amazon-ecr-login-action-for-github-actions)Â ë¶€ì—¬

4-1.Â ECR Privateì— ë¡œê·¸ì¸í•˜ê¸° ìœ„í•œ ìµœì†Œ ê¶Œí•œ ì§‘í•©

```jsx
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "GetAuthorizationToken",
      "Effect": "Allow",
      "Action": [
        "ecr:GetAuthorizationToken"
      ],
      "Resource": "*"
    }
  ]
}
```

4-2.Â ECR í”„ë¼ì´ë¹— ë¦¬í¬ì§€í† ë¦¬ì—ì„œ ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•œ ìµœì†Œ ê¶Œí•œ

```jsx
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowPull",
      "Effect": "Allow",
      "Action": [
        "ecr:BatchGetImage",
        "ecr:GetDownloadUrlForLayer"
      ],
      "Resource": "arn:aws:ecr:<ë¦¬ì „>:<AWS ê³„ì • ID>:repository/<ë ˆíŒŒì§€í† ë¦¬ëª…>"
    }
  ]
}
```

4-3.Â ECR í”„ë¼ì´ë¹— ë¦¬í¬ì§€í† ë¦¬ì—ì„œ ì´ë¯¸ì§€ë¥¼ í‘¸ì‹œí•˜ê³  í’€ë§í•˜ê¸° ìœ„í•œ ìµœì†Œ ê¶Œí•œ

```jsx
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowPushPull",
      "Effect": "Allow",
      "Action": [
        "ecr:BatchGetImage",
        "ecr:BatchCheckLayerAvailability",
        "ecr:CompleteLayerUpload",
        "ecr:GetDownloadUrlForLayer",
        "ecr:InitiateLayerUpload",
        "ecr:PutImage",
        "ecr:UploadLayerPart"
      ],
      "Resource": "arn:aws:ecr:<ë¦¬ì „>:<AWS ê³„ì • ID>:repository/<ë ˆíŒŒì§€í† ë¦¬ëª…>"
    }
  ]
}
```

# #REFERENCES

[node.js ì—ì„œ Dockerfileì„ ì´ìš©í•´ ì´ë¯¸ì§€ë¥¼ ë§Œë“œëŠ” ë°©ë²•](https://docs.docker.com/language/nodejs/build-images/)
Â 


[ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•˜ê³  ìš”ì²­ì„ ë³´ë‚´ í™•ì¸í•˜ëŠ” ë°©ë²•](https://docs.docker.com/language/nodejs/run-containers/)



[ECRì— Docker ì´ë¯¸ì§€ë¥¼ í‘¸ì‹œí•˜ëŠ” ë°©ë²•](https://docs.aws.amazon.com/ko_kr/AmazonECR/latest/userguide/docker-push-ecr-image.html)



[https://docs.docker.com/compose/compose-file/](https://docs.docker.com/compose/compose-file/)



[https://hub.docker.com/_/mongo](https://hub.docker.com/_/mongo)


[https://github.com/fastify/fastify-mongodb](https://github.com/fastify/fastify-mongodb)


[https://stackoverflow.com/questions/31362021/npm-start-vs-node-app-js](https://stackoverflow.com/questions/31362021/npm-start-vs-node-app-js)



[https://browsenpm.org/](https://browsenpm.org/)



[https://velog.io/@jeongmin78/CICD-Github-Action-AWS-IAM-Role-%EC%9D%B4%EC%9A%A9%ED%95%B4-%EC%9D%B4%EB%AF%B8%EC%A7%80%EB%A5%BC-ECR%EC%97%90-%EC%98%AC%EB%A6%AC%EA%B8%B0-8n3fmmgn](https://velog.io/@jeongmin78/CICD-Github-Action-AWS-IAM-Role-%EC%9D%B4%EC%9A%A9%ED%95%B4-%EC%9D%B4%EB%AF%B8%EC%A7%80%EB%A5%BC-ECR%EC%97%90-%EC%98%AC%EB%A6%AC%EA%B8%B0-8n3fmmgn)



[https://docs.github.com/ko/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services](https://docs.github.com/ko/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services)



[https://docs.aws.amazon.com/ko_kr/IAM/latest/UserGuide/id_roles_create_for-idp_oidc.html](https://docs.aws.amazon.com/ko_kr/IAM/latest/UserGuide/id_roles_create_for-idp_oidc.html)

