---
date: 2023-05-02 00:00:00
layout: post
title: DevOps&#91;SECTION2&#93; <AWS ë°°í¬ ìë™í™”> DAY 4 LOG 
subtitle: '<AWS ë°°í¬ ìë™í™”> DAY 4'
description: <AWS ë°°í¬ ìë™í™”> DAY 4
image: /404.jpg
optimized_image: /404.jpg
category: í”„ë¡œì íŠ¸ íšŒê³ 
tags:
  - AWS
  - ECR
  - ìë™í™”
  - Docker
  - mongo DB
  - NoSql
  - HTTPS
  - HTTP
  - POSTMAN
  - íšŒê³ 
  - DevOps BootCamp
author: teddy-woo

---

# # í•™ìŠµ ëª©í‘œ

- í”„ë¡ íŠ¸ì—”ë“œì˜ ë°°í¬ë¥¼ ìë™í™”
- CDNì„ í†µí•´ í”„ë¡ íŠ¸ì—”ë“œë¥¼ ìºì‹±í•˜ê³ , HTTPSë¥¼ ì ìš©
- í”„ë¡ íŠ¸ì—”ë“œì™€ WASë¥¼ ì—°ê²°
- í”„ë¡ íŠ¸ì—”ë“œê°€ ì˜ ì‘ë™í•˜ê¸° ìœ„í•´ WASë¥¼ êµ¬í˜„

# # í•´ê²° ê³¼ì œ

ğŸ’¡ ë§ˆì¼ìŠ¤í†¤10 - ì„œë²„Â ì• í”Œë¦¬ì¼€ì´ì…˜Â CRUDÂ êµ¬í˜„

- [API ìš”êµ¬ì‚¬í•­](https://app.swaggerhub.com/apis-docs/cs-kimcoding/customer/1.1#/)ì— ë§ì¶° ì„œë²„ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‘ì„±
- ë°ì´í„°ë² ì´ìŠ¤ì— ì ‘ì†í•´, ì›í•˜ëŠ” ë°ì´í„°ê°€ ì˜ ë“¤ì–´ê°”ëŠ”ì§€ í™•ì¸
- í”„ë¡ íŠ¸ì—”ë“œê°€ ì˜ ì‘ë™í•˜ëŠ”ì§€ë„ ê°™ì´ í™•ì¸

# # ê³¼ì œ í•­ëª©ë³„ ì§„í–‰ ìƒí™©

# **âœï¸Â Â ë§ˆì¼ìŠ¤í†¤10Â -Â ì„œë²„Â ì• í”Œë¦¬ì¼€ì´ì…˜Â CRUDÂ êµ¬í˜„**

# Step 1 : mongoDBÂ ì´ˆê¸°Â ë°ì´í„°Â í™œìš©

1. ECSì— ë°°í¬í•œ mongoDBì— mongoDB Compassë¥¼ í†µí•´ ì ‘ì†

1-1. mongoDB compassì˜ new Connectionìœ¼ë¡œ AWS ECSì— ë°°í¬í•œ mongoDBì˜ NLBì™€ ì—°ê²°

![https://blog.kakaocdn.net/dn/bUE1CQ/btsdBOFeBMu/WVdiwjcSyUqFQNkpVFla8k/img.png](https://blog.kakaocdn.net/dn/bUE1CQ/btsdBOFeBMu/WVdiwjcSyUqFQNkpVFla8k/img.png)

![https://blog.kakaocdn.net/dn/ObCbJ/btsdhzJ2wvR/ZbXfH9VwVIkNyWbyxLgoH0/img.png](https://blog.kakaocdn.net/dn/ObCbJ/btsdhzJ2wvR/ZbXfH9VwVIkNyWbyxLgoH0/img.png)

2. mongoshë¥¼ ì—´ì–´ mongoDB ë°ì´í„°ë² ì´ìŠ¤ ìƒì„± í›„ ì „í™˜

![https://blog.kakaocdn.net/dn/bCd1AS/btsdlJZEpXF/VULEwsU1dNT42LbSF3K2s0/img.png](https://blog.kakaocdn.net/dn/bCd1AS/btsdlJZEpXF/VULEwsU1dNT42LbSF3K2s0/img.png)

![https://blog.kakaocdn.net/dn/2t65t/btsdxjFK6Mz/1d9qko1wwwtIZH4a5848b1/img.png](https://blog.kakaocdn.net/dn/2t65t/btsdxjFK6Mz/1d9qko1wwwtIZH4a5848b1/img.png)

3. ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•´ DB ì´ˆê¸° ë°ì´í„° êµ¬ì„±

3-1. DB Dataë¥¼ ê¸°ì…í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±

```jsx
db.createCollection('customer')
const customers = db.customer.insertMany([
  {"username":"ê¹€ê°œë°œ","address":"ë¶€ì‚°ê´‘ì—­ì‹œ ìˆ˜ì˜êµ¬ ë¯¼ë½ë¡œ 100ë²ˆê¸¸"},
  {"username":"ìµœìš´ì˜","address":"ì„œìš¸ì‹œ ë§ˆí¬êµ¬ ì–‘í™”ë¡œ 777"}
])

db.createCollection('restaurants')
const menu1 = ObjectId()
const menu2 = ObjectId()
const restaurants = db.restaurants.insertMany([
  {
    "name": "ìš©ë‹¤ë°©",
    "menu": [
      {
        "_id": ObjectId(),
        "name": "ì• í”Œ ì‹œë‚˜ëª¬ ì—ì´ë“œ",
        "price": 6500,
        "duration": 5
      },
      {
        "_id": ObjectId(),
        "name": "ì¹´í˜ëª¨ì¹´",
        "price": 6000,
        "duration": 5
      }
    ],
    "address": "ì„œìš¸ì‹œ ë§ˆí¬êµ¬ ì–‘í™”ë¡œ 1111",
    "rating": 4.5
  },
  {
    "name": "í”¼í”„",
    "menu": [
      {
        "_id": ObjectId(),
        "name": "ì—ìŠ¤í”„ë ˆì†Œ",
        "price": 2000,
        "duration": 5
      },
      {
        "_id": ObjectId(),
        "name": "ìŠ¤íŠ¸ë¼íŒŒì°¨í† ",
        "price": 2500,
        "duration": 5
      },
      {
        "_id": ObjectId(),
        "name": "í¬ë¡œí”Œ",
        "price": 3000,
        "duration": 10
      }
    ],
    "address": "ì„œìš¸ì‹œ ë§ˆí¬êµ¬ ì„±ë¯¸ì‚°ë¡œ 4444",
    "rating": 5
  },
  {
    "name": "ë™ë°±ì»¤í”¼",
    "menu": [
      {
        "_id": menu1,
        "name": "ë™ë°±ì»¤í”¼",
        "price": 4000,
        "duration": 10
      },
      {
        "_id": menu2,
        "name": "ì•„ì¸ìŠˆí˜ë„ˆ",
        "price": 4500,
        "duration": 10
      }
    ],
    "address": "ë¶€ì‚°ì‹œ ìˆ˜ì˜êµ¬ ì„¼í…€1ë¡œ 777",
    "rating": 4.8
  },
  {
    "name": "ë¯¸í¬ ëŒ€êµ¬íƒ•",
    "menu": [
      {
        "_id": ObjectId(),
        "name": "ëŒ€êµ¬íƒ•",
        "price": 10000,
        "duration": 20
      },
      {
        "_id": ObjectId(),
        "name": "ì•Œë§ì´",
        "price": 6000,
        "duration": 20
      }
    ],
    "address": "ë¶€ì‚°ì‹œ í•´ìš´ëŒ€êµ¬ ë¯¸í¬ë¡œ 61",
    "rating": 4.5
  }
])

db.createCollection('courier')
const couriers = db.courier.insertMany([
  {"courier":"ìµœë°°ë‹¬","location":"35.169161,129.132079","available":false},
  {"courier":"ë°•ë°°ì†¡","location":"37.550806,126.903781","available":true}
])

db.createCollection('order')
db.order.insertMany([
  {
    "deliveryInfo": {
      "status":"preparing",
      "assignedCourier":"ë°•ë°°ì†¡",
      "estimatedDeleveryTime":40
    },
    "consumer_id": customers.insertedIds[0],
    "restaurant": {
      "name": "ë™ë°±ì»¤í”¼",
      "address": "ë¶€ì‚°ì‹œ ìˆ˜ì˜êµ¬ ì„¼í…€1ë¡œ 777"
    },
    "orderedMenu":[
      {
        "name": "ë™ë°±ì»¤í”¼",
        "price": 4000,
        "quantity": 3
      },
      {
        "name": "ì•„ì¸ìŠˆí˜ë„ˆ",
        "price": 4500,
        "quantity": 2
      },
    ]
  }
])

db.createCollection('review')
db.review.insertMany([
  {
    "comment":"ì»¤í”¼ê°€ ì•„ì£¼ ì¼í’ˆì´ì˜ˆìš”.","rating":4.5,"reply":"ê³ ê°ë‹˜ ê°ì‚¬í•©ë‹ˆë‹¤. ë” ì¢‹ì€ ì»¤í”¼ë¡œ ë³´ë‹µí•˜ê² ìŠµë‹ˆë‹¤.",
    "consumer_id": customers.insertedIds[0]
  }
])
```

3-2. MongoDB Compassë¥¼ ì´ìš©í•´ ì •ìƒì ìœ¼ë¡œ DBê°€ ì…ë ¥ë˜ì—ˆëŠ”ì§€ í™•ì¸

![https://blog.kakaocdn.net/dn/dCUXyd/btsdBgaK0Z1/vUIyWugMK9Yzygweegziq1/img.png](https://blog.kakaocdn.net/dn/dCUXyd/btsdBgaK0Z1/vUIyWugMK9Yzygweegziq1/img.png)

# Step 2 :Â [node.jsë¥¼ ì´ìš©í•œ mongodb ê°œë°œ ë¬¸ì„œ](https://www.mongodb.com/docs/drivers/node/current/usage-examples/findOne/)ë¥¼ ì°¸ê³ í•´ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë°ì´í„°ë¥¼ ì¡°íšŒ ë° HTTP ìš”ì²­ì— ë”°ë¼ ì ì ˆí•œ ì‘ë‹µì„ ì œê³µ

0. Request JSON Schemas

![https://blog.kakaocdn.net/dn/J0aOT/btsdBeFdTOa/v2JcmkY632poz1bWwIBkRK/img.png](https://blog.kakaocdn.net/dn/J0aOT/btsdBeFdTOa/v2JcmkY632poz1bWwIBkRK/img.png)

1. GET /api/restaurants

1-1. ../routes/api/restaurants/index.js ì½”ë“œ

```jsx
'use strict'

module.exports = async function (fastify, opts) {
  fastify.get('/', async function (req, reply) {
      const database = this.mongo.client.db("baedal");
      const restaurants = database.collection("restaurants");
      const result = await restaurants.find({}).toArray();
      reply.code(200).send(result)
  })
}
```

1-2. request, parameters, responses (swaggerhub)

![https://blog.kakaocdn.net/dn/rhEqU/btsdGmvLubP/hb2B9qGk3LQOdZHA1TNo1K/img.png](https://blog.kakaocdn.net/dn/rhEqU/btsdGmvLubP/hb2B9qGk3LQOdZHA1TNo1K/img.png)

1-3. PostMan í…ŒìŠ¤íŠ¸ ê²°ê³¼

![https://blog.kakaocdn.net/dn/bFdDkk/btsdGAgnhXi/ApIDyKuwaqmSKO61a6wEz0/img.png](https://blog.kakaocdn.net/dn/bFdDkk/btsdGAgnhXi/ApIDyKuwaqmSKO61a6wEz0/img.png)

2. GET /api/orders

2-1. ../routes/api/orders/index.js ì½”ë“œ

```jsx
'use strict'
const { ObjectId } = require("@fastify/mongodb");

module.exports = async function (fastify, opts) {
  fastify.get('/', async function (req, reply) {
    const database = this.mongo.client.db("baedal");
    const orders = database.collection("order");
    const result = await orders.find({}).toArray();
    reply.code(200).send(result)
  })
  // ...í•˜ëµ ...//
}
```

2-2. request, parameters, responses (swaggerhub)

![https://blog.kakaocdn.net/dn/yWCmd/btsdxiuup1w/sPt60Yq7kg7GmFMp9xPsd1/img.png](https://blog.kakaocdn.net/dn/yWCmd/btsdxiuup1w/sPt60Yq7kg7GmFMp9xPsd1/img.png)

2-3. PostMan í…ŒìŠ¤íŠ¸ ê²°ê³¼

![https://blog.kakaocdn.net/dn/cmz3Pr/btsdtFpZhOH/iMPjkABbxO9mHPgmLZjcjk/img.png](https://blog.kakaocdn.net/dn/cmz3Pr/btsdtFpZhOH/iMPjkABbxO9mHPgmLZjcjk/img.png)

3. POST /api/restaurants

3-1. ../routes/api/restaurants/index.js ì½”ë“œ

```jsx
'use strict'
const { ObjectId } = require("@fastify/mongodb");

module.exports = async function (fastify, opts) {
  //... ìƒëµ ...//
  fastify.post('/', async function (req, reply) {
    const restaurants = this.mongo.client.db("baedal").collection("restaurants");
    const restaurant = await restaurants
                            .findOne({ _id: new ObjectId(req.body.restaurantId) }
                            , {projection: { _id: 1, name: 1, address: 1, menu: 1 },});

    const orders = this.mongo.client.db("baedal").collection("order");
    const order = {
      _id: new ObjectId(),
      "deliveryInfo": {
        "status":"PREPAIRING",
        "assignedCourier":"9íŒ€",
        "estimatedDeleveryTime":10
      },
      "consumer_id": new ObjectId(),
      "restaurant": restaurant,
      "orderedMenu":req.body.menu
    }

    const result = await orders.insertOne(order)
    order._id = result.insertedId;
    reply.code(200).send(order)
  })
  //... í•˜ëµ ...//
}
```

3-2. request, parameters, responses (swaggerhub)

![https://blog.kakaocdn.net/dn/cDAZb8/btsdFfcCntM/6jwcny36fAmLAOsfLktG4k/img.png](https://blog.kakaocdn.net/dn/cDAZb8/btsdFfcCntM/6jwcny36fAmLAOsfLktG4k/img.png)

3-3. PostMan í…ŒìŠ¤íŠ¸ ê²°ê³¼

![https://blog.kakaocdn.net/dn/IiRPH/btsdGnBsPW0/RapJ8wUgXpMKlW7Kbj9jG0/img.png](https://blog.kakaocdn.net/dn/IiRPH/btsdGnBsPW0/RapJ8wUgXpMKlW7Kbj9jG0/img.png)

4. GET /api/restaurants

4-1. ../routes/api/restaurants/index.js ì½”ë“œ

```jsx
'use strict'
const { ObjectId } = require("@fastify/mongodb");

module.exports = async function (fastify, opts) {
  // ...ìƒëµ ...//
  fastify.get('/:id', async function (request, reply) {
    try {
      const orderId = new ObjectId(request.params.id);

      const client = fastify.mongo.client
      const database = client.db("baedal")
      const order = database.collection("order")

      const query = { _id: orderId };

      const result = await order.findOne(query);

      if(result != null) {
        reply
          .code(200)
          .header('Content-type', 'application/json')
          .send(result)
      } else {
        reply
          .code(404)
          .header('Content-type', 'application/json')
          .send("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì£¼ë¬¸ì…ë‹ˆë‹¤.")
      }
    } catch {
      reply
        .code(500)
        .header('Content-type', 'application/json')
        .send("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
    }
  })
}
```

4-2. request, parameters, responses (swaggerhub)

![https://blog.kakaocdn.net/dn/czAMGO/btsdGAAHoIO/KhUgU4zOmzFmcOWEgmcKXK/img.png](https://blog.kakaocdn.net/dn/czAMGO/btsdGAAHoIO/KhUgU4zOmzFmcOWEgmcKXK/img.png)

4-3. PostMan í…ŒìŠ¤íŠ¸ ê²°ê³¼

![https://blog.kakaocdn.net/dn/cYyPX3/btsdsSptisN/EsD6fB1r27dnvkmsNBI5rk/img.png](https://blog.kakaocdn.net/dn/cYyPX3/btsdsSptisN/EsD6fB1r27dnvkmsNBI5rk/img.png)

# #TROUBLE SHOOTING LOG

# ğŸ“ ISSUE 1 : mongoDB ì°¸ì¡° ë¬¸ì œ

1. í˜„ìƒ

> MongoError: Use of expired sessions is not permitted , ....
> 

2. ì›ì¸

fasitfyì—ì„œ mongodbë¥¼ í”ŒëŸ¬ê·¸ì¸ìœ¼ë¡œ registerí•  ê²½ìš° mongodb ê°ì²´ë¥¼ singletonìœ¼ë¡œ ì‚¬ìš©í•˜ë©° ì°¸ì¡°í•˜ë¯€ë¡œ closeë¥¼ ìˆ˜í–‰í•˜ë©´ mongodbì™€ì˜ ì—°ê²°ì´ ì¢…ë£Œë˜ë¯€ë¡œ ë°œìƒí•˜ëŠ” í˜„ìƒ

3. í•´ê²° ë°©ë²•

ëª…ì‹œì ìœ¼ë¡œ close()í•˜ì§€ ì•ŠìŒ

# # REFERENCES

[https://www.mongodb.com/docs/drivers/node/current/usage-examples/findOne/](https://www.mongodb.com/docs/drivers/node/current/usage-examples/findOne/)


[https://stackoverflow.com/questions/59816298/how-to-fix-mongoerror-cannot-use-a-session-that-has-ended](https://stackoverflow.com/questions/59816298/how-to-fix-mongoerror-cannot-use-a-session-that-has-ended)

