---
date: 2023-05-11 00:00:00
layout: post
title: DevOps&#91;ì„œë²„ë¦¬ìŠ¤ ì• í”Œë¦¬ì¼€ì´ì…˜&#93; / [Sprint]
subtitle: '02. ì„œë²„ë¦¬ìŠ¤ ì• í”Œë¦¬ì¼€ì´ì…˜'
description: 02. ì„œë²„ë¦¬ìŠ¤ ì• í”Œë¦¬ì¼€ì´ì…˜
image: /thumbnail/msa.png
optimized_image: /thumbnail/msa.png
category: Sprint
tags:
  - MSA
  - ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤
  - AWS Lambda
  - API Gateway
  - Serverless Application Model
  - SAM
  - SAM CLI
  - DynamoDB
  - DevOps BootCamp
author: teddy-woo

---

# #í•™ìŠµ ëª©í‘œ

ì„œë²„ë¦¬ìŠ¤ ì‚¬ì§„ì²© ì„œë¹„ìŠ¤ : ì‚¬ì§„ ì—…ë¡œë“œ, ì¸ì¦ ê¸°ëŠ¥, ì¸ë„¤ì¼ ìƒì„± ê¸°ëŠ¥ì„ ì œê³µ

# #í•´ê²° ê³¼ì œ

ğŸ’¡ ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ë©´, ì›ë³¸ê³¼ ë³„ë„ë¡œ ì¸ë„¤ì¼ì„ ìƒì„±í•˜ê³ , ì´ë¥¼ ë³„ë„ì˜ ë²„í‚·ì— ì €ì¥

- ì¸ë„¤ì¼ ì´ë¯¸ì§€ëŠ” ê°€ë¡œ 200pxì˜ í¬ê¸°
- ì¸ë„¤ì¼ì„ ì €ì¥í•  ë³„ë„ì˜ ë²„í‚·ì€ ëŒë‹¤ í•¨ìˆ˜ì˜ í™˜ê²½ ì„¤ì •ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ì•¼ í•¨

ğŸ’¡ ê³¼ì œë¥¼Â ë‹¬ì„±í•˜ë©´,Â S3Â ì´ë²¤íŠ¸ê°€Â SQSë¡œÂ ì „ì†¡ë˜ê²ŒÂ ë§Œë“¤ê³ ,Â SQSë¡œë¶€í„°Â ì´ë²¤íŠ¸ë¥¼Â ë°›ì•„Â ëŒë‹¤ê°€Â ì‹¤í–‰í•˜ê²ŒÂ ë§Œë“¤ê¸°

ğŸ’¡ ì¸ë„¤ì¼Â ìƒì„±ì´Â ì™„ë£Œë˜ë©´,Â ë©”ì¼ë¡œÂ í•´ë‹¹Â ì¸ë„¤ì¼Â URLê³¼Â í•¨ê»˜Â ì „ì†¡ì´Â ë˜ê²ŒÂ ë§Œë“¤ê¸°

- AmazonÂ SNSë¥¼Â í™œìš©

ğŸ’¡ S3ì˜ Pre-signed URL ê¸°ëŠ¥ì„ ì´ìš©í•˜ì—¬, ì—…ë¡œë“œ ì „ìš© URLì„ íšë“í•˜ê³ , ì´ë¥¼ í†µí•´ ì´ë¯¸ì§€ë¥¼ S3 ì—…ë¡œë“œí•  ìˆ˜ ìˆê²Œ ë§Œë“¤ê¸°

# #ê³¼ì œ í•­ëª©ë³„ ì§„í–‰ ìƒí™©

## **âœï¸Â Â ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œ ì›ë³¸ê³¼ ë³„ë„ë¡œ ì¸ë„¤ì¼ì„ ìƒì„±í•˜ê³ , ì´ë¥¼ ë³„ë„ì˜ ë²„í‚·ì— ì €ì¥í•˜ê¸°**

# Step 1 : sam init ëª…ë ¹ì„ ì´ìš©í•´ Quick Start Templateìœ¼ë¡œë¶€í„° Standalone functionì„ í•˜ë‚˜ ìƒì„±

```
$ sam init

You can preselect a particular runtime or package type when using the `sam init` experience.
Call `sam init --help` to learn more.

Which template source would you like to use?
        1 - AWS Quick Start Templates
        2 - Custom Template Location
Choice: 1

Choose an AWS Quick Start application template
        1 - Hello World Example
        2 - Multi-step workflow
        3 - Serverless API
        4 - Scheduled task
        5 - Standalone function
        6 - Data processing
        7 - Hello World Example With Powertools
        8 - Infrastructure event management
        9 - Serverless Connector Hello World Example
        10 - Multi-step workflow with Connectors
        11 - Lambda Response Streaming
        12 - Lambda EFS example
        13 - DynamoDB Example
        14 - Machine Learning
Template: 5

Which runtime would you like to use?
        1 - dotnet6
        2 - dotnetcore3.1
        3 - nodejs18.x
        4 - nodejs16.x
        5 - nodejs14.x
        6 - nodejs12.x
Runtime: 4

Based on your selections, the only Package type available is Zip.
We will proceed to selecting the Package type as Zip.

Based on your selections, the only dependency manager available is npm.
We will proceed copying the template using npm.

Would you like to enable X-Ray tracing on the function(s) in your application?  [y/N]: n

Would you like to enable monitoring using CloudWatch Application Insights?
For more info, please view https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/cloudwatch-application-insights.html [y/N]: n

Project name [sam-app]: serverless-application

    -----------------------
    Generating application:
    -----------------------
    Name: serverless-application
    Runtime: nodejs16.x
    Architectures: x86_64
    Dependency Manager: npm
    Application Template: quick-start-from-scratch
    Output Directory: .
    Configuration file: serverless-application/samconfig.toml

    Next steps can be found in the README file at serverless-application/README.md

Commands you can use next
=========================
[*] Create pipeline: cd serverless-application && sam pipeline init --bootstrap
[*] Validate SAM template: cd serverless-application && sam validate
[*] Test Function in the Cloud: cd serverless-application && sam sync --stack-name {stack-name} --watch
```

# Step 2 : ì´ë²¤íŠ¸ ì†ŒìŠ¤ë¡œë¶€í„° íŠ¸ë¦¬ê±°ê°€ ë°œìƒí–ˆì„ ë•Œ ì´ë²¤íŠ¸ì˜ í˜•íƒœë¥¼ í™•ì¸í•˜ê¸° ìœ„í•œ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ ì‘ì„±

```jsx
// .. /serverless-application/src/handlers/hello-from-lambda.js

exports.helloFromLambdaHandler = async (event, context) => {
    console.log(event)

    console.log(context)

    return 'Hello from Lambda!';
}
```

# Step 3 : ë¹Œë“œ í›„ ë°°í¬

```
# ë¹Œë“œ
$ sam build

Starting Build use cache

#... ì¤‘ëµ ...

Commands you can use next
=========================
[*] Validate SAM template: sam validate
[*] Invoke Function: sam local invoke
[*] Test Function in the Cloud: sam sync --stack-name {{stack-name}} --watch
[*] Deploy: sam deploy --guided

# ë°°í¬
$ sam deploy --guided

Configuring SAM deploy
======================

        Looking for config file [samconfig.toml] :  Found
        Reading default arguments  :  Success

        Setting default arguments for 'sam deploy'
        =========================================
        Stack Name [serverless-application]:
        AWS Region [ap-northeast-2]:
        #Shows you resources changes to be deployed and require a 'Y' to initiate deploy
        Confirm changes before deploy [Y/n]: n
        #SAM needs permission to be able to create roles to connect to the resources in your template
        Allow SAM CLI IAM role creation [Y/n]: y
        #Preserves the state of previously provisioned resources when an operation fails
        Disable rollback [y/N]: n
        Save arguments to configuration file [Y/n]: y
        SAM configuration file [samconfig.toml]:
        SAM configuration environment [default]:
```

# Step 4 : S3 ë²„í‚· ìƒì„± í›„ Lambdaì˜ íŠ¸ë¦¬ê±°ë¡œ ì—°ê²°

1. S3 ë²„í‚· ìƒì„±

![https://blog.kakaocdn.net/dn/bFfrCJ/btseSBLMFhL/VCxbrEhT4lB5ZzeAbxHKo0/img.png](https://blog.kakaocdn.net/dn/bFfrCJ/btseSBLMFhL/VCxbrEhT4lB5ZzeAbxHKo0/img.png)

**â€» ì¶”í›„ ëŒë‹¤ í•¨ìˆ˜ê°€ S3 ë²„í‚·ì— ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•  ìˆ˜ ìˆëŠ” ì •ì±…ì„ í—ˆìš©í•˜ê¸° ìœ„í•´ ê°ì²´ ì†Œìœ ê¶Œì„ í™œì„±í™”**

2. Step 1ì—ì„œ ìƒì„±í•œ Lambda í•¨ìˆ˜ì— íŠ¸ë¦¬ê±° ì¶”ê°€

![https://blog.kakaocdn.net/dn/PEgaV/btseRhtAIMQ/4nTDDpBQDEaeONoxjrUy5K/img.png](https://blog.kakaocdn.net/dn/PEgaV/btseRhtAIMQ/4nTDDpBQDEaeONoxjrUy5K/img.png)

![https://blog.kakaocdn.net/dn/qXeIa/btseTeQneX0/RmSetnpvRKxzcN6l2zpSGK/img.png](https://blog.kakaocdn.net/dn/qXeIa/btseTeQneX0/RmSetnpvRKxzcN6l2zpSGK/img.png)

1. íŠ¸ë¦¬ê±°ë¡œ ì‚¬ìš©í•  ì´ë²¤íŠ¸ ì†ŒìŠ¤ ìœ í˜•ì„ ì„ íƒ
2. ì´ë²¤íŠ¸ ì†ŒìŠ¤ë¥¼ íŠ¹ì •
3. ì–´ë–¤ ìœ í˜•ì˜ ì´ë²¤íŠ¸ê°€ ë°œìƒí•  ë•Œ íŠ¸ë¦¬ê±°ë¥¼ ì‘ë™ì‹œí‚¬ ì§€ ì„ íƒ
4. ì ‘ë¯¸ì‚¬ë¥¼ í•„í„°ë§ (ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê²½ìš°ì—ë§Œ íŠ¸ë¦¬ê±°ê°€ ë°œë™)
5. ì¬ê·€ í˜¸ì¶œì— ëŒ€í•œ ì•ˆë‚´ì‚¬í•­ì„ í™•ì¸

3. S3 ë²„í‚·ì— ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê³  ëŒë‹¤ í•¨ìˆ˜ê°€ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸

3-1. ì´ë²¤íŠ¸ ì†ŒìŠ¤ë¡œ íŠ¹ì •í•œ S3ì— ì´ë¯¸ì§€ ì—…ë¡œë“œ

![https://blog.kakaocdn.net/dn/bdUEgm/btseQUrFemS/CJyZ77S5ApsYZ84QUex3pk/img.png](https://blog.kakaocdn.net/dn/bdUEgm/btseQUrFemS/CJyZ77S5ApsYZ84QUex3pk/img.png)

3-2. ëŒë‹¤ í•¨ìˆ˜ì— ì‘ì„±í•œ ë¡œê·¸ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ lambda í•¨ìˆ˜ í•˜ë‹¨ì˜ ëª¨ë‹ˆí„°ë§ > ë¡œê·¸ > cloudwatch logs ë³´ê¸°ë¡œ ì´ë™

![https://blog.kakaocdn.net/dn/bueyL9/btseOhuzgO3/Etg71GsdFBJykmS95cSi30/img.png](https://blog.kakaocdn.net/dn/bueyL9/btseOhuzgO3/Etg71GsdFBJykmS95cSi30/img.png)

3-3. ë¡œê·¸ë¥¼ í†µí•´ event ê°ì²´ì™€ context ê°ì²´ êµ¬ì¡° í™•ì¸

```
2023-05-10T05:49:41.660Z	7db5151f-1b48-4734-8c38-a8333d73017e	INFO	[event] :
{
    "Records": [
        {
            "eventVersion": "2.0",
            "eventSource": "aws:s3",
            "awsRegion": "us-east-1",
            "eventTime": "1970-01-01T00:00:00.000Z",
            "eventName": "ObjectCreated:Put",
            "userIdentity": {
                "principalId": "EXAMPLE"
            },
            "requestParameters": {
                "sourceIPAddress": "127.0.0.1"
            },
            "responseElements": {
                "x-amz-request-id": "EXAMPLE123456789",
                "x-amz-id-2": "EXAMPLE123/5678abcdefghijklambdaisawesome/mnopqrstuvwxyzABCDEFGH"
            },
            "s3": {
                "s3SchemaVersion": "1.0",
                "configurationId": "testConfigRule",
                "bucket": {
                    "name": "example-bucket",
                    "ownerIdentity": {
                        "principalId": "EXAMPLE"
                    },
                    "arn": "arn:aws:s3:::example-bucket"
                },
                "object": {
                    "key": "test%2Fkey",
                    "size": 1024,
                    "eTag": "0123456789abcdef0123456789abcdef",
                    "sequencer": "0A1B2C3D4E5F678901"
                }
            }
        }
    ]
}

2023-05-10T05:49:41.660Z	7db5151f-1b48-4734-8c38-a8333d73017e	INFO	[context] : {
    "callbackWaitsForEmptyEventLoop": true,
    "functionVersion": "$LATEST",
    "functionName": "serverless-application-helloFromLambdaFunction-PpzdYJabGJTJ",
    "memoryLimitInMB": "128",
    "logGroupName": "/aws/lambda/serverless-application-helloFromLambdaFunction-PpzdYJabGJTJ",
    "logStreamName": "2023/05/10/[$LATEST]242ab67329fb4421ae9f4b0a01e1db04",
    "invokedFunctionArn": "arn:aws:lambda:ap-northeast-2:644329934495:function:serverless-application-helloFromLambdaFunction-PpzdYJabGJTJ",
    "awsRequestId": "7db5151f-1b48-4734-8c38-a8333d73017e"
}
```

3-4. ëŒë‹¤ í•¨ìˆ˜ì˜ í…ŒìŠ¤íŠ¸Â íƒ­ ë‚´ í…œí”Œë¦¿ì—ì„œ S3 ì´ë²¤íŠ¸ê°€ ë§ˆë ¨ë˜ì–´ ìˆì–´ì„œ, ì‹¤ì œë¡œ jpeg ì´ë¯¸ì§€ë¥¼ ì˜¬ë¦¬ì§€ ì•Šê³ ë„ ì´ë²¤íŠ¸ë¥¼ í‰ë‚´ ë‚¼ ìˆ˜(mocking) ìˆìŒ

![https://blog.kakaocdn.net/dn/048M3/btseOiUBMAh/3OG8YfDZeS3deR850duz9k/img.png](https://blog.kakaocdn.net/dn/048M3/btseOiUBMAh/3OG8YfDZeS3deR850duz9k/img.png)

![https://blog.kakaocdn.net/dn/diiSoT/btseSVi3i7c/KNkfPfUEiS2ERJEsASHpXK/img.png](https://blog.kakaocdn.net/dn/diiSoT/btseSVi3i7c/KNkfPfUEiS2ERJEsASHpXK/img.png)

ë”ë³´ê¸°

# Step 4 : event, context ê°ì²´ êµ¬ì¡°ë¥¼ í™œìš©í•´ Lambda í•¨ìˆ˜ì— S3 ë²„í‚·ì— ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ë©´ ì¸ë„¤ì¼ì„ ë§Œë“œëŠ” ë¡œì§ ì‘ì„±

```jsx
// .. /serverless-application/src/handlers/hello-from-lambda.js

// í•„ìš”í•œ ëª¨ë“ˆ í˜¸ì¶œ
const sharp = require('sharp');
const aws = require('aws-sdk');

// s3 í´ë¼ì´ì–¸íŠ¸ ì°¸ì¡° ê°ì²´
const s3 = new aws.S3();

exports.helloFromLambdaHandler = async (event, context) => {
    console.log(`[event] : ${JSON.stringify(event)}`)
    console.log(`[context] : ${JSON.stringify(context)}`)
    const target_s3_bucket = "serverless-photo-thumbnail-bucket"
    const origin_s3_bucket = event.Records[0].s3.bucket;
    const upload_image_key = decodeURIComponent(event.Records[0].s3.object.key.replace(/\+/g, ' '));

    // ì›ë³¸ ë²„í‚·ìœ¼ë¡œë¶€í„° íŒŒì¼ ì½ê¸°
    const s3Object = await s3.getObject({
        Bucket: origin_s3_bucket["name"],
        Key: upload_image_key
    }).promise()

    // ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ, sharp ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ í•„ìš”
    const data = await sharp(s3Object.Body)
        .resize(200)
        .jpeg({ mozjpeg: true })
        .toBuffer()

    // ëŒ€ìƒ ë²„í‚·ìœ¼ë¡œ íŒŒì¼ ì“°ê¸°
    const result = await s3.putObject({
        Bucket: target_s3_bucket,
        Key: upload_image_key,
        ContentType: "image/jpeg",
        Body: data,
        ACL: "public-read"
    }).promise()

    return result;
   }
```

# Step 5 : íƒ€ê²Ÿ S3 ë²„í‚· ìƒì„± (Step 4ì˜ 1ë²ˆê³¼ ë™ì¼)

# Step 6 :ì´ë²¤íŠ¸ ì†ŒìŠ¤ S3 ë²„í‚·ì— ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê³  ëŒë‹¤ í•¨ìˆ˜ê°€ ë™ì‘í•´ ì¸ë„¤ì¼ì„ ë§Œë“¤ê³  íƒ€ê²Ÿ S3 ë²„í‚·ì— ì—…ë¡œë“œí•˜ëŠ”ì§€ í™•ì¸

![https://blog.kakaocdn.net/dn/bsoUGg/btseQVRDJu4/KQdoJOH4XSyhXcwatWlCS0/img.png](https://blog.kakaocdn.net/dn/bsoUGg/btseQVRDJu4/KQdoJOH4XSyhXcwatWlCS0/img.png)

# **âœï¸Â S3Â ì´ë²¤íŠ¸ê°€Â SQSë¡œÂ ì „ì†¡ë˜ê²ŒÂ ë§Œë“¤ê³ ,Â SQSë¡œë¶€í„°Â ì´ë²¤íŠ¸ë¥¼Â ë°›ì•„Â ëŒë‹¤ê°€Â ì‹¤í–‰í•˜ê²ŒÂ ë§Œë“¤ê¸°**

# Step 1 : SQS ì½˜ì†”ì„ ì´ìš©í•´ Amazon SQS ëŒ€ê¸°ì—´ ìƒì„±

- ëŒ€ê¸°ì—´ì„ ë§Œë“  í›„ ëŒ€ê¸°ì—´ì—Â [ë©”ì‹œì§€ë¥¼ ë³´ë‚´ê³  ë©”ì‹œì§€ë¥¼](https://docs.aws.amazon.com/ko_kr/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-using-send-messages.html)Â [ë°›ê±°ë‚˜ ì‚­ì œí• ](https://docs.aws.amazon.com/ko_kr/AWSSimpleQueueService/latest/SQSDeveloperGuide/step-receive-delete-message.html)Â ìˆ˜ ìˆìŒ ë˜í•œ ëŒ€ê¸°ì—´ ìœ í˜•ì„ ì œì™¸í•œ ëª¨ë“  ëŒ€ê¸°ì—´ êµ¬ì„± ì„¤ì •ì„Â [í¸ì§‘í• ](https://docs.aws.amazon.com/ko_kr/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-configure-edit-queue.html)Â ìˆ˜ ìˆìŒ

![https://blog.kakaocdn.net/dn/cEITxg/btseRXaCSGl/isf2FN6SyysZbstD5mNbv0/img.png](https://blog.kakaocdn.net/dn/cEITxg/btseRXaCSGl/isf2FN6SyysZbstD5mNbv0/img.png)

1. [https://console.aws.amazon.com/sqs/](https://console.aws.amazon.com/sqs/)Â ì—ì„œ Amazon SQS ì½˜ì†”ì„ ì„ íƒí•˜ê³ Â **Create queue**(ëŒ€ê¸°ì—´ ìƒì„±)ë¥¼ ì„ íƒ
2. **ìœ í˜•**Â ì„ íƒÂ (ëŒ€ê¸°ì—´ì„ ìƒì„±í•œ í›„ì—ëŠ” ëŒ€ê¸°ì—´ ìœ í˜•ì„ ë³€ê²½í•  ìˆ˜ ì—†ìŒ)
3. ëŒ€ê¸°ì—´Â **ì´ë¦„ì„**Â ì…ë ¥ (FIFO ëŒ€ê¸°ì—´ì˜ ì´ë¦„ì€.fifoÂ ì ‘ë¯¸ì‚¬ë¡œ ëë‚˜ì•¼ í•¨)
4. (ì„ íƒ ì‚¬í•­) ì½˜ì†”ì€ íÂ [êµ¬ì„± ë§¤ê°œë³€ìˆ˜ì˜](https://docs.aws.amazon.com/ko_kr/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-configure-queue-parameters.html)Â ê¸°ë³¸ê°’ì„ ì„¤ì • (**êµ¬ì„±ì—ì„œ**Â ë‹¤ìŒ ë§¤ê°œë³€ìˆ˜ì˜ ìƒˆ ê°’ì„ ì„¤ì • ê°€ëŠ¥)
    1. **í‘œì‹œ ì œí•œ ì‹œê°„**: í‘œì‹œ ì œí•œ ì‹œê°„ì€ (í•œ ì†Œë¹„ìê°€) ëŒ€ê¸°ì—´ì—ì„œ ìˆ˜ì‹ í•œ ë©”ì‹œì§€ê°€ ë‹¤ë¥¸ ë©”ì‹œì§€ ì†Œë¹„ìì—ê²Œ ë³´ì´ì§€ ì•Šê²Œ ë˜ëŠ” ì‹œê°„ì„ ì„¤ì •
    2. **ë©”ì‹œì§€ ë³´ì¡´ ê¸°ê°„:**Â Â AmazonÂ SQSê°€Â ì‚­ì œë˜ì§€Â ì•Šì€Â ë©”ì‹œì§€ë¥¼Â ë³´ê´€í•˜ëŠ”Â ê¸°ê°„
    3. **ì „ì†¡ ì§€ì—°:**Â ì†Œë¹„ìê°€ ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë° ì¶”ê°€ ì‹œê°„ì´ í•„ìš”í•œ ê²½ìš° ëŒ€ê¸°ì—´ì— ë“¤ì–´ì˜¤ëŠ” ê° ìƒˆ ë©”ì‹œì§€ì˜ ì „ì†¡ì„ ì§€ì—°í•˜ëŠ” ì‹œê°„
    4. **ìµœëŒ€ ë©”ì‹œì§€ í¬ê¸°:**Â ê°’ì„ ì…ë ¥ ë²”ìœ„ëŠ” 1KBì—ì„œ 256KBê¹Œì§€ ê¸°ë³¸ê°’ì€ 256KB
    5. **ìˆ˜ì‹  ë©”ì‹œì§€ ëŒ€ê¸° ì‹œê°„:**Â Â í´ë§ì´Â ë©”ì‹œì§€ë¥¼Â ìˆ˜ì‹ í• Â ìˆ˜Â ìˆì„Â ë•Œê¹Œì§€Â ëŒ€ê¸°í•˜ëŠ”Â ìµœëŒ€Â ì‹œê°„
5. (ì„ íƒ ì‚¬í•­)Â **ì•¡ì„¸ìŠ¤ ì •ì±…ì„**Â ì •ì˜Â ([ì•¡ì„¸ìŠ¤ ì •ì±…ì€](https://docs.aws.amazon.com/ko_kr/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-creating-custom-policies-access-policy-examples.html)Â ëŒ€ê¸°ì—´ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆëŠ” ê³„ì •, ì‚¬ìš©ì ë° ì—­í• ì„ ì •ì˜í•˜ë©°,ì‚¬ìš©ìê°€ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆëŠ” ì‘ì—… (ì˜ˆ:SendMessageReceiveMessage, ë˜ëŠ”DeleteMessage) ì„ ì •ì˜í•¨. ê¸°ë³¸ ì •ì±…ì—ì„œëŠ” í ì†Œìœ ìë§Œ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ê³  ë°›ì„ ìˆ˜ ìˆìŒ)
    â—¦ íì— ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆëŠ” ì‚¬ëŒê³¼ íì—ì„œ ë©”ì‹œì§€ë¥¼ ë°›ì„ ìˆ˜ ìˆëŠ” ì‚¬ëŒì„ êµ¬ì„±í•˜ë ¤ë©´Â **ê¸°ë³¸**Â ì„ íƒ, ì½˜ì†”ì€ ì‚¬ìš©ìì˜ ì„ íƒì— ë”°ë¼ ì •ì±…ì„ ìƒì„±í•˜ê³  ê²°ê³¼ ì•¡ì„¸ìŠ¤ ì •ì±…ì„ ì½ê¸° ì „ìš© JSON íŒ¨ë„ì— í‘œì‹œ
    â—¦ JSON ì•¡ì„¸ìŠ¤ ì •ì±…ì„ ì§ì ‘ ìˆ˜ì •í•˜ë ¤ë©´ [**ê³ ê¸‰**] ì„ ì„ íƒ ì´ë¥¼ í†µí•´ ê° ì£¼ì²´ (ê³„ì •, ì‚¬ìš©ì ë˜ëŠ” ì—­í• ) ê°€ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” ì‚¬ìš©ì ì§€ì • ì‘ì—… ì„¸íŠ¸ë¥¼ ì§€ì • ê°€ëŠ¥

# Step 2 : S3ê°€ SQSì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ SQSì—Â Â [ê¶Œí•œ](https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/grant-destinations-permissions-to-s3.html)Â ì„¤ì •

- SQSì— S3 ì„œë¹„ìŠ¤ì—ê²Œ SendMessageë¼ëŠ” ê¶Œí•œì„ í—ˆìš©í•˜ê¸° ìœ„í•´ ì•„ë˜ ì •ì±… ë‚´ìš©ì„ SQSì— ë¶€ì—¬

```jsx
{
    "Version": "2012-10-17",
    "Id": "example-ID",
    "Statement": [
        {
            "Sid": "example-statement-ID",
            "Effect": "Allow",
            "Principal": {
                "Service": "s3.amazonaws.com"
            },
            "Action": [
                "SQS:SendMessage"
            ],
            "Resource": "arn:aws:sqs:Region:account-id:queue-name",
            "Condition": {
                "ArnLike": {
                    "aws:SourceArn": "arn:aws:s3:*:*:awsexamplebucket1"
                },
                "StringEquals": {
                    "aws:SourceAccount": "bucket-owner-account-id"
                }
            }
        }
    ]
}
```

ë”ë³´ê¸°

# Step 3 : S3 ë²„í‚·ì— ëŒ€í•œ SQS ì´ë²¤íŠ¸ ì•Œë¦¼ ì‚¬ìš© ì„¤ì • ë° êµ¬ì„±

![https://blog.kakaocdn.net/dn/5OEF4/btseT0RX8hH/gbGZSjusHsKkhg249oMmdk/img.png](https://blog.kakaocdn.net/dn/5OEF4/btseT0RX8hH/gbGZSjusHsKkhg249oMmdk/img.png)

![https://blog.kakaocdn.net/dn/lFh0I/btseR9hA7vg/eheD7HocZJs3LXOjLckllk/img.png](https://blog.kakaocdn.net/dn/lFh0I/btseR9hA7vg/eheD7HocZJs3LXOjLckllk/img.png)

1. AWS Management Consoleì— ë¡œê·¸ì¸í•œ í›„Â [https://console.aws.amazon.com/s3/](https://console.aws.amazon.com/s3/)ì—ì„œ Amazon S3 ì½˜ì†”ì„ ì„ íƒ >**ë²„í‚·(Buckets)**Â ëª©ë¡ì—ì„œ ì´ë²¤íŠ¸ë¥¼ ì‚¬ìš© ì„¤ì •í•˜ë ¤ëŠ” ë²„í‚·ì˜ ì´ë¦„ì„ ì„ íƒí•œ ë’¤ [**ì†ì„±(Properties)**]ì„ ì„ íƒ
2. **ì´ë²¤íŠ¸ ì•Œë¦¼(Event Notifications)**Â ì„¹ì…˜ìœ¼ë¡œ ì´ë™í•˜ì—¬Â **ì´ë²¤íŠ¸ ì•Œë¦¼ ìƒì„±(Create event notification)**ì„ ì„ íƒ
3. **ì¼ë°˜ êµ¬ì„±(General configuration)**Â ì„¹ì…˜ì—ì„œ ì´ë²¤íŠ¸ ì•Œë¦¼ì„ ì„¤ëª…í•˜ëŠ” ì´ë²¤íŠ¸ ì´ë¦„ì„ ì§€ì • (ì„ íƒì ìœ¼ë¡œ ì ‘ë‘ì‚¬ì™€ ì ‘ë¯¸ì‚¬ë¥¼ ì§€ì •í•˜ì—¬ ì§€ì •ëœ ë¬¸ìë¡œ ëë‚˜ëŠ” í‚¤ê°€ ìˆëŠ” ê°ì²´ë¡œ ì•Œë¦¼ì„ ì œí•œí•  ìˆ˜ë„ ìˆìŒ)
    - **ì´ë²¤íŠ¸ ì´ë¦„(Event name)**ì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥, ì´ë¦„ì„ ì…ë ¥í•˜ì§€ ì•Šìœ¼ë©´ ì „ì—­ ê³ ìœ  ì‹ë³„ì(GUID)ê°€ ìƒì„±ë˜ì–´ ì´ë¦„ì— ì‚¬ìš©ë¨
    - (ì„ íƒ ì‚¬í•­) ì ‘ë‘ì‚¬ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì´ë²¤íŠ¸ ì•Œë¦¼ì„ í•„í„°ë§í•˜ë ¤ë©´Â **ì ‘ë‘ì‚¬(Prefix)**ë¥¼ ì…ë ¥ (ex.Â íŠ¹ì • í´ë”ì— íŒŒì¼ì´ ì¶”ê°€ë  ë•Œë§Œ ì•Œë¦¼ì„ ë°›ë„ë¡ ì ‘ë‘ì‚¬ í•„í„°ë¥¼ ì„¤ì • ê°€ëŠ¥(ì˜ˆ:Â images/))
    - (ì„ íƒ ì‚¬í•­) ì ‘ë¯¸ì‚¬ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì´ë²¤íŠ¸ ì•Œë¦¼ì„ í•„í„°ë§í•˜ë ¤ë©´Â **ì ‘ë¯¸ì‚¬(Suffix)**ë¥¼ ì…ë ¥(ìì„¸í•œ ë‚´ìš©ì€Â [ê°ì²´ í‚¤ ì´ë¦„ í•„í„°ë§ì„ ì‚¬ìš©í•˜ì—¬ ì´ë²¤íŠ¸ ì•Œë¦¼ êµ¬ì„±](https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/notification-how-to-filtering.html)Â ì„¹ì…˜ì„ ì°¸ì¡°)
4. **ì´ë²¤íŠ¸ ìœ í˜•(Event types)**Â ì„¹ì…˜ì—ì„œ ì•Œë¦¼ì„ ë°›ì„ ì´ë²¤íŠ¸ ìœ í˜•ì„ í•˜ë‚˜ ì´ìƒ ì„ íƒ
5. ë‹¤ì–‘í•œ ì´ë²¤íŠ¸ ìœ í˜• ëª©ë¡ì€Â [SQS, SNS ë° Lambdaì— ì§€ì›ë˜ëŠ” ì´ë²¤íŠ¸ ìœ í˜•](https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/notification-how-to-event-types-and-destinations.html#supported-notification-event-types)Â ì„¹ì…˜ì„ ì°¸ì¡°
6. **ëŒ€ìƒ(Destination)**Â ì„¹ì…˜ì—ì„œ ì´ë²¤íŠ¸ ì•Œë¦¼ ëŒ€ìƒì„ ì„ íƒ (ìì„¸í•œ ë‚´ìš©ì€Â [ì§€ì›ë˜ëŠ” ì´ë²¤íŠ¸ ëŒ€ìƒ](https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/notification-how-to-event-types-and-destinations.html#supported-notification-destinations)Â ì„¹ì…˜ì„ ì°¸ì¡°)
    - **Lambda í•¨ìˆ˜**,Â **SNS ì£¼ì œ**Â ë˜ëŠ”Â **SQS ëŒ€ê¸°ì—´**ê³¼ ê°™ì€ ëŒ€ìƒ ìœ í˜•ì„ ì„ íƒ
    - ëŒ€ìƒ ìœ í˜•ì„ ì„ íƒí•œ í›„ ëª©ë¡ì—ì„œ í•¨ìˆ˜, ì£¼ì œ ë˜ëŠ” ëŒ€ê¸°ì—´ì„ ì„ íƒ
    - ë˜ëŠ” Amazon ë¦¬ì†ŒìŠ¤ ì´ë¦„(ARN)ì„ ì§€ì •í•˜ë ¤ëŠ” ê²½ìš° [**ARN ì…ë ¥(Enter ARN)**]ì„ ì„ íƒí•˜ê³  ARNì„ ì…ë ¥
7. [**ë³€ê²½ ì‚¬í•­ ì €ì¥(Save changes)**]ì„ ì„ íƒí•˜ë©´ Amazon S3ê°€ ì´ë²¤íŠ¸ ì•Œë¦¼ ëŒ€ìƒìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ë¥¼ ë°œì†¡

# Step 4 : S3ì— ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ ì •ìƒì ìœ¼ë¡œ SQSì— ë©”ì‹œì§€ê°€ ë„ì°©í•˜ëŠ”ì§€ í™•ì¸

![https://blog.kakaocdn.net/dn/0B4k3/btseP5AMUXD/V1Id0Y8gXbbtIETr7DuGE1/img.png](https://blog.kakaocdn.net/dn/0B4k3/btseP5AMUXD/V1Id0Y8gXbbtIETr7DuGE1/img.png)

![https://blog.kakaocdn.net/dn/c8Jtq2/btseP4u8Huo/RscOTc7jKgkl07SnqnKGyK/img.png](https://blog.kakaocdn.net/dn/c8Jtq2/btseP4u8Huo/RscOTc7jKgkl07SnqnKGyK/img.png)

# Step 5 : SQSì— ëŒë‹¤ í•¨ìˆ˜ë¥¼ íŠ¸ë¦¬ê±°í•´ ë©”ì‹œì§€ê°€ ë„ì°©í•˜ë©´ Lambdaë¡œ ì „ë‹¬ë˜ë„ë¡ ì„¤ì •

1. ìƒì„±í•œ SQSì—ì„œ Lambda íŠ¸ë¦¬ê±° íƒ­ìœ¼ë¡œ ì´ë™í•˜ê³  Lambda í•¨ìˆ˜ íŠ¸ë¦¬ê±° êµ¬ì„±ì„ ì„ íƒí•˜ê³  ëŒ€ìƒ Lambda í•¨ìˆ˜ë¥¼ ì„ íƒ

![https://blog.kakaocdn.net/dn/MaMa8/btseVNdNRTQ/Ua8WAiR4Qp4KUTf2cjKShK/img.png](https://blog.kakaocdn.net/dn/MaMa8/btseVNdNRTQ/Ua8WAiR4Qp4KUTf2cjKShK/img.png)

![https://blog.kakaocdn.net/dn/EgWy7/btseSC49Phf/XId0ErFnZPLOKspAJq8nMK/img.png](https://blog.kakaocdn.net/dn/EgWy7/btseSC49Phf/XId0ErFnZPLOKspAJq8nMK/img.png)

**â€» ì°¸ê³  : ë§Œì¼ SQSì˜ ë©”ì‹œì§€ í‘œì‹œ ì œí•œ ì‹œê°„ì´ Lambda í•¨ìˆ˜ì˜ ì‹œê°„ ë¯¸ë§Œì´ë¼ë©´ ì„¤ì •ì„ ë³€ê²½í•´ì£¼ì–´ì•¼ í•¨**

![https://blog.kakaocdn.net/dn/ch2y8o/btseV9OF0uE/3qKH2Cbq9gfh61Q6a5igMK/img.png](https://blog.kakaocdn.net/dn/ch2y8o/btseV9OF0uE/3qKH2Cbq9gfh61Q6a5igMK/img.png)

# Step 6 : Lambda í•¨ìˆ˜ì—ì„œ SQSì—ì„œ ì „ë‹¬ë°›ì€ ì´ë²¤íŠ¸ë¥¼ í†µí•´ ì¸ë„¤ì¼ì„ ìƒì„±í•˜ë„ë¡ ë¡œì§ ë³€ê²½

```jsx
// .. /serverless-application/src/handlers/hello-from-lambda.js

// í•„ìš”í•œ ëª¨ë“ˆ í˜¸ì¶œ
const sharp = require('sharp');
const aws = require('aws-sdk');

// s3 í´ë¼ì´ì–¸íŠ¸ ì°¸ì¡° ê°ì²´
const s3 = new aws.S3();

exports.helloFromLambdaHandler = async (event, context) => {
    console.log(`[context] : ${JSON.stringify(context)}`)
    const body = JSON.parse(event.Records[0].body);
    console.log(`[event body] : ${JSON.stringify(body)}`)

    const target_s3_bucket = "serverless-photo-thumbnail-bucket"
    const origin_s3_bucket = body.Records[0].s3.bucket;
    const upload_image_key = decodeURIComponent(body.Records[0].s3.object.key.replace(/\+/g, ' '));

    console.log(`[ORIGIN S3 BUCKET] : ${JSON.stringify(origin_s3_bucket)}, [TARGET S3 BUCKET] : ${target_s3_bucket}, [IMAGE NAME] : ${upload_image_key}`)

    // ì›ë³¸ ë²„í‚·ìœ¼ë¡œë¶€í„° íŒŒì¼ ì½ê¸°
    const s3Object = await s3.getObject({
        Bucket: origin_s3_bucket["name"],
        Key: upload_image_key
    }).promise()

    // ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ, sharp ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ í•„ìš”
    const data = await sharp(s3Object.Body)
        .resize(200)
        .jpeg({ mozjpeg: true })
        .toBuffer()

    // ëŒ€ìƒ ë²„í‚·ìœ¼ë¡œ íŒŒì¼ ì“°ê¸°
    const result = await s3.putObject({
        Bucket: target_s3_bucket,
        Key: upload_image_key,
        ContentType: "image/jpeg",
        Body: data,
        ACL: "public-read"
    }).promise()

    console.log(`[result] : ${JSON.stringify(result)}`)
}
```

# Step 7 : ì›ë³¸ S3 ë²„í‚· ì—…ë¡œë“œ â†’ SQSÂ â†’ LambdaÂ â†’ íƒ€ê²Ÿ S3 ë²„í‚· ì—…ë¡œë“œ ê³¼ì •ì´ ì´ë£¨ì–´ì§€ëŠ”ì§€ í™•ì¸

1. ì›ë³¸ S3 ë²„í‚·ì— ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œ í›„ SQS ëŒ€ê¸°ì—´ì— ì •ìƒì ìœ¼ë¡œ ë©”ì‹œì§€ê°€ ìˆ˜ì‹ ë˜ì—ˆëŠ”ì§€ í™•ì¸

![https://blog.kakaocdn.net/dn/HpbCz/btseQTsRhK9/fssfVOXV2rJpE8WBcd1Vu1/img.png](https://blog.kakaocdn.net/dn/HpbCz/btseQTsRhK9/fssfVOXV2rJpE8WBcd1Vu1/img.png)

2. Lambda ë¡œê·¸ë¥¼ í†µí•´ ì¸ë„¤ì¼ ìƒì„± í•¨ìˆ˜ê°€ ì •ìƒì ìœ¼ë¡œ ë™ì‘ë˜ì—ˆëŠ”ì§€ í™•ì¸

![https://blog.kakaocdn.net/dn/7xyeW/btseR9opScE/f4ZVdDa3lLzCqokAtVFKoK/img.png](https://blog.kakaocdn.net/dn/7xyeW/btseR9opScE/f4ZVdDa3lLzCqokAtVFKoK/img.png)

3. íƒ€ê²Ÿ S3 ë²„í‚·ì— ì •ìƒì ìœ¼ë¡œ ì—…ë¡œë“œí•œ ì´ë¯¸ì§€ì˜ ì¸ë„¤ì¼ì´ ì—…ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸

# **âœï¸Â ì¸ë„¤ì¼ ìƒì„±ì´ ì™„ë£Œë˜ë©´, ë©”ì¼ë¡œ í•´ë‹¹ ì¸ë„¤ì¼ URLê³¼ í•¨ê»˜ ì „ì†¡ì´ ë˜ê²Œ ë§Œë“¤ê¸°**

# Step 1 : ì´ë©”ì¼ ì „ì†¡ì„ ìœ„í•´ Amazon SNS ì„œë¹„ìŠ¤ì— ì£¼ì œ, êµ¬ë…ì„ ìƒì„±

1. ì£¼ì œ ìƒì„±

![https://blog.kakaocdn.net/dn/w5zhp/btseSck7TTl/suWZseVeoCeCX2SIi56QP1/img.png](https://blog.kakaocdn.net/dn/w5zhp/btseSck7TTl/suWZseVeoCeCX2SIi56QP1/img.png)

![https://blog.kakaocdn.net/dn/dvk4uh/btseQjZTSTC/OnHa4VJSRnyrokjwCKMWFk/img.png](https://blog.kakaocdn.net/dn/dvk4uh/btseQjZTSTC/OnHa4VJSRnyrokjwCKMWFk/img.png)

1. [Amazon SNS ì½˜ì†”ì˜](https://console.aws.amazon.com/sns/home)Â ì™¼ìª½ íƒìƒ‰ ì°½ì—ì„œÂ **ì£¼ì œ**ë¥¼ ì„ íƒí•˜ê³ Â **ì£¼ì œ**Â í˜ì´ì§€ì—ì„œÂ **ì£¼ì œ ìƒì„±**ì„ ì„ íƒ
2. **í‘œì¤€**ì„ ì„ íƒ
3. **ì„¸ë¶€ ì •ë³´**Â ì„¹ì…˜ì—ì„œÂ ì£¼ì œì˜Â **ì´ë¦„**ì„ ì…ë ¥
4. ì¶”í›„ Lambdaë‚˜ S3ì—ì„œì˜ ì ‘ê·¼ì„ í—ˆê°€í•˜ê¸° ìœ„í•œ ê¶Œí•œ ì •ì±… ì§€ì • ê°€ëŠ¥
5. **ì£¼ì œ ìƒì„±**ì„ ì„ íƒ

2.ì£¼ì œ êµ¬ë… ìƒì„±

![https://blog.kakaocdn.net/dn/3aSqU/btseVMzdcLE/jsD3uUKBLx21UnDKHcnXcK/img.png](https://blog.kakaocdn.net/dn/3aSqU/btseVMzdcLE/jsD3uUKBLx21UnDKHcnXcK/img.png)

1. ì™¼ìª½ì˜ íƒìƒ‰ ì°½ì—ì„œÂ **êµ¬ë…**ì„ ì„ íƒ
2. **êµ¬ë…**Â í˜ì´ì§€ì—ì„œÂ **êµ¬ë… ìƒì„±**ì„ ì„ íƒ
3. **êµ¬ë… ìƒì„±**Â í˜ì´ì§€ì—ì„œÂ **ì£¼ì œ ARN**Â í•„ë“œë¥¼ ì„ íƒí•˜ì—¬ AWS ê³„ì •ì—ì„œ ì£¼ì œ ëª©ë¡ì„ í™•ì¸ í›„ ì´ì „ ë‹¨ê³„ì—ì„œ ìƒì„±í•œ ì£¼ì œë¥¼ ì„ íƒ
4. **í”„ë¡œí† ì½œ**ì—ì„œÂ **ì´ë©”ì¼(**ì›í•˜ëŠ” ì—”ë“œí¬ì¸íŠ¸ ìœ í˜•**)**ì„ ì„ íƒ
5. **ì—”ë“œí¬ì¸íŠ¸**ì— ì•Œë¦¼ì„ ë°›ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥
6. **êµ¬ë… ìƒì„±**ì„ ì„ íƒ

3. êµ¬ë… ì•ˆë‚´ ë©”ì¼ í™•ì¸ ë° êµ¬ë… ìŠ¹ì¸

- ì´ë©”ì¼Â ë°›ì€Â í¸ì§€í•¨ì„Â í™•ì¸í•˜ê³ Â AWSÂ ì•Œë¦¼ì˜Â ì´ë©”ì¼ì—ì„œÂ êµ¬ë…Â ìŠ¹ì¸ (ë°œì‹ ìÂ IDëŠ”Â ì¼ë°˜ì ìœ¼ë¡œÂ "no-reply@sns.amazonaws.com")

![https://blog.kakaocdn.net/dn/dSbaJk/btseQdZNilk/nMvIDm9Zk3ouKYaKPRJH90/img.png](https://blog.kakaocdn.net/dn/dSbaJk/btseQdZNilk/nMvIDm9Zk3ouKYaKPRJH90/img.png)

# Step 2 : Lambda í•¨ìˆ˜ë¥¼ ìƒˆë¡­ê²Œ ìƒì„±í•˜ê³  íƒ€ê²Ÿ S3 ë²„í‚·ì— ì¸ë„¤ì¼ ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ë©´ SNSì— ì´ë©”ì¼ì„ ë°œì†¡í•˜ë„ë¡ ì„¤ì •

1. SAMì„ ì´ìš©í•˜ê±°ë‚˜ AWS ì½˜ì†”ì„ í†µí•´ ì´ë©”ì¼ ì „ì†¡ì„ ìœ„í•œ Lambda í•¨ìˆ˜ ì‘ì„±

- AWS SDKì˜ s3 ê°ì²´ì˜ getSignedUrlÂ getObjectÂ ë©”ì„œë“œë¥¼ ì´ìš©í•´ ì ‘ê·¼ ê°€ëŠ¥í•œ url ìƒì„±

```jsx
// .. /serverless-application-email/src/handlers/hello-from-lambda.js

// í•„ìš”í•œ ëª¨ë“ˆ í˜¸ì¶œ
const aws = require('aws-sdk');
aws.config.update({ region: "ap-northeast-2" });

// s3 í´ë¼ì´ì–¸íŠ¸ ì°¸ì¡° ê°ì²´
const s3 = new aws.S3();
const sns = new aws.SNS();

exports.helloFromLambdaHandler = async (event, context) => {
    try {
        const s3_bucket = event.Records[0].s3.bucket;
        const image_key = decodeURIComponent(event.Records[0].s3.object.key.replace(/\+/g, ' '));
        console.log(` [s3_bucket] : ${JSON.stringify(s3_bucket)}, [IMAGE NAME] : ${image_key}`)

        // ì—…ë¡œë“œí•œ ê°ì²´ urlê³µìœ 
        var params = {
            Bucket: s3_bucket["name"],
            Key: image_key
        };

        const url = await s3.getSignedUrlPromise('getObject', params);
        console.log(`[URL] : ${url}` );

        var sns_params = {
            Message: url, /* required */
            Subject: "ìƒˆë¡­ê²Œ ì‚¬ì§„ì´ ì—…ë¡œë“œë˜ì—ˆì–´ìš”!",
            TopicArn: 'arn:aws:sns:ap-northeast-2:644329934495:serverless-photo-sns'
        };

        // Create promise and SNS service object
        const publish_result = await sns.publish(sns_params).promise();
        console.log(`[publish_result] : ${JSON.stringify(publish_result)}` );
    } catch(error) {
        console.log(error);
    }

}
```

2. Lambda í•¨ìˆ˜ì— íƒ€ê²Ÿ S3 ë²„í‚· íŠ¸ë¦¬ê±° ì—°ê²°

![https://blog.kakaocdn.net/dn/cGWYxB/btseQVKZlM6/0ecmCNfQ8j7GUZDXhTn441/img.png](https://blog.kakaocdn.net/dn/cGWYxB/btseQVKZlM6/0ecmCNfQ8j7GUZDXhTn441/img.png)

# Step 3 : ì›ë³¸ S3 ë²„í‚·ì— ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ URLì´ ì •ìƒì ìœ¼ë¡œ ì „ë‹¬ë˜ëŠ”ì§€ í™•ì¸

![https://blog.kakaocdn.net/dn/bJRcqN/btseTggvER1/0Cxa1kE88HGiWtXewfuKw1/img.png](https://blog.kakaocdn.net/dn/bJRcqN/btseTggvER1/0Cxa1kE88HGiWtXewfuKw1/img.png)

![https://blog.kakaocdn.net/dn/qPKUR/btseQdFqUdn/QFF4Hj72rkiT9FkkM4nlS1/img.png](https://blog.kakaocdn.net/dn/qPKUR/btseQdFqUdn/QFF4Hj72rkiT9FkkM4nlS1/img.png)

# **âœï¸Â S3ì˜ Pre-signed URL ê¸°ëŠ¥ì„ ì´ìš©í•˜ì—¬, ì—…ë¡œë“œ ì „ìš© URLì„ íšë“í•˜ê³ , ì´ë¥¼ í†µí•´ ì´ë¯¸ì§€ë¥¼ S3 ì—…ë¡œë“œí•  ìˆ˜ ìˆê²Œ ë§Œë“¤ê¸°**

# Step 1 :Â SAMì„ ì´ìš©í•˜ê±°ë‚˜ AWS ì½˜ì†”ì„ í†µí•´ ì´ë¯¸ì§€ ì—…ë¡œë“œë¥¼ ìœ„í•œ Lambda í•¨ìˆ˜ ì‘ì„±

- AWS SDKì˜ s3 ê°ì²´ì˜ getSignedUrlì˜ putObject ë©”ì„œë“œë¥¼ ì´ìš©í•´ ì—…ë¡œë“œ ê°€ëŠ¥í•œ url ìƒì„±

```jsx
// .. /serverless-application-upload/src/handlers/hello-from-lambda.js

// í•„ìš”í•œ ëª¨ë“ˆ í˜¸ì¶œ
const aws = require('aws-sdk');
aws.config.update({ region: "ap-northeast-2" });

// s3 í´ë¼ì´ì–¸íŠ¸ ì°¸ì¡° ê°ì²´
const s3 = new aws.S3();

exports.helloFromLambdaHandler = async (event, context) => {
    try {
        console.log(`[event] : ${JSON.stringify(event)}`)
        console.log(`[context] : ${JSON.stringify(context)}`)

	// í´ë¼ì´ì–¸íŠ¸ë¡œë¶€í„° ì „ë‹¬ë°›ì€ ì—…ë¡œë“œí•  ì´ë¯¸ì§€ëª…
        let img_name = event.iamge;

        let params = {
          Bucket: "serverless-photo-origin-bucket",
          Key: img_name,
        }

        const signedUrl = s3.getSignedUrl('putObject', params);

        return {
            statusCode: 200,
            body: JSON.stringify(signedUrl)
        }
    } catch(error) {
        console.log(error);
    }
}
```

# Step 2 : ì´ë¯¸ì§€ ì—…ë¡œë“œë¥¼ ê°€ëŠ¥í•˜ê²Œ í•˜ëŠ” API í˜¸ì¶œì„ ìœ„í•´ API Gatewayë¥¼ ìƒì„±í•˜ê³  ìƒì„±í•œ Lambda í•¨ìˆ˜ì˜ íŠ¸ë¦¬ê±°ë¡œ ì—°ê²°

1. API Gatewayë¥¼ ìƒì„±í•´ ì´ë¯¸ì§€ ì—…ë¡œë“œ urlì„ ë°›ì„ ë©”ì„œë“œë¥¼ ìƒì„±í•˜ê³ , API í˜¸ì¶œ URL ìƒì„±ì„ ìœ„í•´ API ë°°í¬

![https://blog.kakaocdn.net/dn/b1EtHJ/btseQDDLCuQ/kI73RBToTwipM8DPPk7Dq1/img.png](https://blog.kakaocdn.net/dn/b1EtHJ/btseQDDLCuQ/kI73RBToTwipM8DPPk7Dq1/img.png)

# 2. Step 1ì—ì„œ ì‘ì„±í•œ Lambda í•¨ìˆ˜ì— API gateway íŠ¸ë¦¬ê±° ì¶”ê°€

![https://blog.kakaocdn.net/dn/cE8M7M/btseTgU7Sfc/5eb5zyviljccstoOXBMPS0/img.png](https://blog.kakaocdn.net/dn/cE8M7M/btseTgU7Sfc/5eb5zyviljccstoOXBMPS0/img.png)

# Step 3 : ë°°í¬í•œ API URLì„ í†µí•´ (1) ì´ë¯¸ì§€ ì •ë³´ ìš”ì²­ í›„ (2) ì—…ë¡œë“œ ê°€ëŠ¥í•œ url ì‘ë‹µ í™•ì¸

1. API í˜¸ì¶œí•´ ìš”ì²­í•˜ê³  ì‘ë‹µë°›ê¸°

![https://blog.kakaocdn.net/dn/bVT8yK/btseVL1oiwo/KVKKFiwURbkA0koh1SuVxK/img.png](https://blog.kakaocdn.net/dn/bVT8yK/btseVL1oiwo/KVKKFiwURbkA0koh1SuVxK/img.png)

1. ì—…ë¡œë“œí•  ì´ë¯¸ì§€ëª…ì„ API ìš”ì²­
2. ì—…ë¡œë“œ ê°€ëŠ¥í•œ url ì‘ë‹µ

2. ì—…ë¡œë“œ ê°€ëŠ¥í•œ URLì„ í´ë¦­í•´ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ê³  ì—…ë¡œë“œ

![https://blog.kakaocdn.net/dn/bOUsmy/btseRWJBpgi/9NKzFDPkLLHnqOWZ4gkcP1/img.png](https://blog.kakaocdn.net/dn/bOUsmy/btseRWJBpgi/9NKzFDPkLLHnqOWZ4gkcP1/img.png)

# Step 4 : ì •ìƒì ìœ¼ë¡œ ì›ë³¸ S3 ë²„í‚·ì— ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ê³ , ì¸ë„¤ì¼ ì €ì¥ í›„ ì´ë©”ì¼ ì „ì†¡ë˜ëŠ”ì§€ í™•ì¸

1. ì›ë³¸ S3 ë²„í‚·ì— ì„¤ì •í•œ ì´ë¯¸ì§€ëª…ìœ¼ë¡œ ì •ìƒì ìœ¼ë¡œ ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸

![https://blog.kakaocdn.net/dn/be2WhW/btseT05zkiS/1P0iMrqekaMLgYQoNxUjq0/img.png](https://blog.kakaocdn.net/dn/be2WhW/btseT05zkiS/1P0iMrqekaMLgYQoNxUjq0/img.png)

2. íƒ€ê²Ÿ S3 ë²„í‚·ì— ì¸ë„¤ì¼ë¡œ ì €ì¥ë˜ì—ˆëŠ”ì§€ í™•ì¸

3. SNSë¥¼ í†µí•´ ì¸ë„¤ì¼ ì—…ë¡œë“œ ì•Œë¦¼ ë©”ì¼ì´ ìˆ˜ì‹ ë˜ì—ˆëŠ”ì§€ í™•ì¸

![https://blog.kakaocdn.net/dn/91IbS/btseQDX3ZJY/OZqDnD35GOKStchcxQ7fik/img.png](https://blog.kakaocdn.net/dn/91IbS/btseQDX3ZJY/OZqDnD35GOKStchcxQ7fik/img.png)

# #REFERENCES

[https://docs.aws.amazon.com/ko_kr/lambda/latest/dg/with-s3-example.html](https://docs.aws.amazon.com/ko_kr/lambda/latest/dg/with-s3-example.html)



[https://docs.aws.amazon.com/ko_kr/lambda/latest/dg/with-s3-tutorial.html](https://docs.aws.amazon.com/ko_kr/lambda/latest/dg/with-s3-tutorial.html)



[https://docs.aws.amazon.com/ko_kr/lambda/latest/dg/invocation-async.html?icmpid=docs_lambda_help#invocation-async-destinations](https://docs.aws.amazon.com/ko_kr/lambda/latest/dg/invocation-async.html?icmpid=docs_lambda_help#invocation-async-destinations)



[https://docs.aws.amazon.com/ko_kr/AWSSimpleQueueService/latest/SQSDeveloperGuide/welcome.html](https://docs.aws.amazon.com/ko_kr/AWSSimpleQueueService/latest/SQSDeveloperGuide/welcome.html)



[https://docs.aws.amazon.com/ko_kr/AWSSimpleQueueService/latest/SQSDeveloperGuide/step-create-queue.html](https://docs.aws.amazon.com/ko_kr/AWSSimpleQueueService/latest/SQSDeveloperGuide/step-create-queue.html)



[https://docs.aws.amazon.com/ko_kr/AWSSimpleQueueService/latest/APIReference/API_SendMessage.html](https://docs.aws.amazon.com/ko_kr/AWSSimpleQueueService/latest/APIReference/API_SendMessage.html)



[https://docs.aws.amazon.com/ko_kr/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-configure-lambda-function-trigger.html](https://docs.aws.amazon.com/ko_kr/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-configure-lambda-function-trigger.html)



[https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/NotificationHowTo.html](https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/NotificationHowTo.html)



[https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/how-to-enable-disable-notification-intro.html](https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/how-to-enable-disable-notification-intro.html)



[https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/enable-event-notifications.html](https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/enable-event-notifications.html)



[https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/ways-to-add-notification-config-to-bucket.html](https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/ways-to-add-notification-config-to-bucket.html)



[https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/grant-destinations-permissions-to-s3.html](https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/grant-destinations-permissions-to-s3.html)



[https://docs.aws.amazon.com/ko_kr/lambda/latest/dg/with-sqs-create-package.html#with-sqs-example-deployment-pkg-nodejs](https://docs.aws.amazon.com/ko_kr/lambda/latest/dg/with-sqs-create-package.html#with-sqs-example-deployment-pkg-nodejs)



[https://docs.aws.amazon.com/ko_kr/sns/latest/dg/sns-email-notifications.html](https://docs.aws.amazon.com/ko_kr/sns/latest/dg/sns-email-notifications.html)



[https://docs.aws.amazon.com/ko_kr/sns/latest/dg/sns-getting-started.html](https://docs.aws.amazon.com/ko_kr/sns/latest/dg/sns-getting-started.html)



[https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/PresignedUrlUploadObject.html](https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/PresignedUrlUploadObject.html)



[https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/ShareObjectPreSignedURL.html](https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/ShareObjectPreSignedURL.html)



[https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/S3.html#getSignedUrl-property](https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/S3.html#getSignedUrl-property)



[https://docs.aws.amazon.com/ko_kr/sdk-for-javascript/v2/developer-guide/sns-examples-publishing-messages.html](https://docs.aws.amazon.com/ko_kr/sdk-for-javascript/v2/developer-guide/sns-examples-publishing-messages.html)



[https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/SNS.html#setSMSAttributes-property](https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/SNS.html#setSMSAttributes-property)



[https://catalog.us-east-1.prod.workshops.aws/workshops/ac11f205-6c9d-417e-b656-0aa26ef873f7/ko-KR/lab3/lab3-2](https://catalog.us-east-1.prod.workshops.aws/workshops/ac11f205-6c9d-417e-b656-0aa26ef873f7/ko-KR/lab3/lab3-2)



[https://mihee0703.tistory.com/128](https://mihee0703.tistory.com/128)



[https://github.com/awsdocs/aws-doc-sdk-examples/tree/main/javascriptv3/example_code/s3#code-examples](https://github.com/awsdocs/aws-doc-sdk-examples/tree/main/javascriptv3/example_code/s3#code-examples)



[https://velog.io/@ohjinseo/NodeJS-AWS-Serverless-%ED%99%98%EA%B2%BD%EC%97%90%EC%84%9C-PresignedURL-%EA%B0%80%EC%A0%B8%EC%98%A4%EA%B8%B](https://velog.io/@ohjinseo/NodeJS-AWS-Serverless-%ED%99%98%EA%B2%BD%EC%97%90%EC%84%9C-PresignedURL-%EA%B0%80%EC%A0%B8%EC%98%A4%EA%B8%B)