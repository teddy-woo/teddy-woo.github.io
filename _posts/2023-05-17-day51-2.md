---
date: 2023-05-11 00:00:00
layout: post
title: DevOps&#91;Terraform x AWS&#93; / [Sprint]
subtitle: '01. Terraform x AWS'
description: 01. Terraform x AWS
image: /iac.png
optimized_image: /iac.png
category: Sprint
tags:
  - IaC
  - Infrastructure as Code
  - ì½”ë“œí˜• ì¸í”„ë¼
  - í…Œë¼í¼
  - terraform
  - ë¶ˆë³€(Immutable)í•œ ì¸í”„ë¼
  - HCL ì–¸ì–´
  - DevOps BootCamp
author: teddy-woo

---

# #í•™ìŠµ ëª©í‘œ

ë‹¤ìŒì˜ ì•„í‚¤í…ì²˜ë¥¼ terraformì„ ì´ìš©í•´ ì‘ì„±

![https://blog.kakaocdn.net/dn/b6iGwv/btsfdWQ9ZQb/eNCuSdssI5XrhXVWvlk0O1/img.png](https://blog.kakaocdn.net/dn/b6iGwv/btsfdWQ9ZQb/eNCuSdssI5XrhXVWvlk0O1/img.png)

- í¼ë¸”ë¦­ ì¸í„°ë„·ì´ ì•„ë‹Œ ì›¹ ì„œë²„ì—ì„œë§Œ DBÂ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ì•¼ í•˜ë¯€ë¡œ í¼ë¸”ë¦­ ì„œë¸Œë„·ê³¼ í”„ë¼ì´ë¹— ì„œë¸Œë„·ì„ ëª¨ë‘ í¬í•¨í•˜ì—¬ VPCë¥¼ ìƒì„±
    - í¼ë¸”ë¦­ ì„œë¸Œë„·ì—ì„œ ì›¹ ì„œë²„ë¥¼ í˜¸ìŠ¤íŒ…í•˜ë¯€ë¡œ ì›¹ ì„œë²„ì—ì„œ í¼ë¸”ë¦­ ì¸í„°ë„·ì— ì•¡ì„¸ìŠ¤ ê°€ëŠ¥
    - DB ì¸ìŠ¤í„´ìŠ¤ëŠ” í”„ë¼ì´ë¹— ì„œë¸Œë„·ì—ì„œ í˜¸ìŠ¤íŒ…
    - Amazon EC2 ì¸ìŠ¤í„´ìŠ¤ëŠ” ë™ì¼í•œ VPC ë‚´ì—ì„œ í˜¸ìŠ¤íŒ…ë˜ë¯€ë¡œ DB ì¸ìŠ¤í„´ìŠ¤ì— ì—°ê²°í•  ìˆ˜ ìˆìœ¼ë‚˜ í¼ë¸”ë¦­ ì¸í„°ë„·ì—ì„œëŠ” DB ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ë³´ì•ˆì´ ê°•í™”ë¨
- ë³„ë„ì˜ ê°€ìš© ì˜ì—­ì—ì„œ ì¶”ê°€ í¼ë¸”ë¦­ ë° í”„ë¼ì´ë¹— ì„œë¸Œë„·ì„ êµ¬ì„±
- Amazon RDS DB ì¸ìŠ¤í„´ìŠ¤ìš© VPC êµ¬ì„±
    - ì´ëŸ¬í•œ VPC ì‹œë‚˜ë¦¬ì˜¤ì— ëŒ€í•œ ì›¹ ì„œë²„ë¥¼ ìƒì„±í•˜ëŠ” ë°©ë²•ì„ ë³´ì—¬ ì£¼ëŠ” ììŠµì„œëŠ”Â [ììŠµì„œ: ì›¹ ì„œë²„ ë° Amazon RDS DB ì¸ìŠ¤í„´ìŠ¤ ìƒì„±](https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/UserGuide/TUT_WebAppWithRDS.html)Â ë‹¨ì›ì„ ì°¸ì¡°
    - Amazon VPC ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€Â [Amazon VPC ì‹œì‘ ì•ˆë‚´ì„œ](https://docs.aws.amazon.com/AmazonVPC/latest/GettingStartedGuide/)Â ë°Â [Amazon VPC ì‚¬ìš© ì„¤ëª…ì„œ](https://docs.aws.amazon.com/vpc/latest/userguide/)ë¥¼ ì°¸ì¡°
    - Amazon EC2 ì¸ìŠ¤í„´ìŠ¤ì™€ DB ê°„ì— ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ ì„¤ì •í•  ìˆ˜ ìˆìŒ(ìì„¸í•œ ë‚´ìš©ì€Â [EC2 ì¸ìŠ¤í„´ìŠ¤ì™€ì˜ ìë™ ë„¤íŠ¸ì›Œí¬ ì—°ê²° êµ¬ì„±](https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/UserGuide/USER_CreateDBInstance.html#USER_CreateDBInstance.Prerequisites.VPC.Automatic)Â ì„¹ì…˜ ì°¸ì¡°)

# #í•´ê²° ê³¼ì œ

ğŸ’¡Â [ììŠµì„œ:Â DBÂ ì¸ìŠ¤í„´ìŠ¤ì—Â ì‚¬ìš©í• Â AmazonÂ VPCÂ ìƒì„±](https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/UserGuide/CHAP_Tutorials.WebServerDB.CreateVPC.html)

ğŸ’¡ EC2Â ì¸ìŠ¤í„´ìŠ¤Â ìƒì„±

ğŸ’¡Â [ììŠµì„œ:Â DBÂ ì¸ìŠ¤í„´ìŠ¤Â ìƒì„±](https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/UserGuide/CHAP_Tutorials.WebServerDB.CreateDBInstance.html)

ğŸ’¡Â ì• í”Œë¦¬ì¼€ì´ì…˜Â ë¡œë“œÂ ë°¸ëŸ°ì„œÂ ë°Â AutoÂ ScalingÂ GroupÂ ì ìš©

# # ì°¸ê³  ì‚¬í•­

- IaC ì½”ë“œë¥¼ ì‘ì„±í•˜ë ¤ë©´ ë¨¼ì € AWS Management Consoleì„ ì´ìš©í•´ ë¨¼ì € ìµœì¢… ì¸í”„ë¼ ìƒíƒœë¥¼ ë§Œë“¤ì–´ë†“ê³ , ì˜ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•œ ë‹¤ìŒ, ì´ë¥¼ í•´ë‹¹í•˜ëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ í•˜ë‚˜ì”© ì½”ë“œë¡œ ì˜®ê¸°ëŠ” ë°©ë²•ì„ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì„ ì‚¬ìš©í•˜ê¸°
- ë¨¼ì € AWS Management Consoleì„ í†µí•´ ìµœì¢… ê²°ê³¼ë¬¼ì„ ë”°ë¼ í•´ë³´ê³ , ì˜ˆìƒ ìƒíƒœê°€ ë¬´ì—‡ì¸ì§€ ë¨¼ì € íŒŒì•…
- ëª¨ë“  ë¦¬ì†ŒìŠ¤ë¥¼ ë§Œë“¤ ë•Œì—ëŠ” ë°˜ë“œì‹œ ì´ë¦„ì„ ë¶™ì´ê¸°

# #ê³¼ì œ í•­ëª©ë³„ ì§„í–‰ ìƒí™©

# **âœï¸Â Â Terraform êµ¬ì¡° ë° íŒŒì¼ êµ¬ì„±**

```bash
# version.tf : terraform ë¸”ëŸ­
# variables.tf : ë³€ìˆ˜
# main.tf : IaC ì¸í”„ë¼ ìƒì„± ì½”ë“œ
# outputs.tf : RDS ìƒì„± í›„ ì •ë³´
# user-data.sh : EC2 ìƒì„± ì‹œ ì‚¬ìš©ì ë°ì´í„°
```

```bash
# version.tf
terraform {
  cloud {
    organization = "roheerumi"

    workspaces {
      name = "terraform-study"
    }

    required_providers {
      aws = {
        source = "hashicorp/aws"
        version = "4.67.0"
      }
    }
  }
}
```

```bash
# variables.tf
variable "region" {
   default     = "ap-northeast-2"
   description = "AWS region"
}

variable "server_port" {
   default = 80
}
```

```bash
# main.tf
# 1) AWS providerì˜ resource, 2) terraformì˜ aws ë ˆì§€ìŠ¤íŠ¸ë¦¬ module ì‚¬ìš©
provider "aws" {
  region = var.region
}

# ... í•˜ëµ ... #
```

# **âœï¸Â Â [ììŠµì„œ:Â DBÂ ì¸ìŠ¤í„´ìŠ¤ì—Â ì‚¬ìš©í• Â AmazonÂ VPCÂ ìƒì„±](https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/UserGuide/CHAP_Tutorials.WebServerDB.CreateVPC.html)**

# Step 1 : VPC ë° ì„œë¸Œë„· ìƒì„±

- í”„ë¼ì´ë¹— ì„œë¸Œë„· 2ê°œì™€ í¼ë¸”ë¦­ ì„œë¸Œë„· 2ê°œë¡œ ì´ ë„¤ ê°œ ìƒì„±

[AWS ì½˜ì†”] ì½˜ì†”ì—ì„œ ìƒì„±

ë”ë³´ê¸°

[Terraform] IaC ì½”ë“œë¡œ ì‘ì„±

```bash
# main.tf

###################################################################################
# 1. VPC ìƒì„±
# IPv4 CIDR block: - 10.0.0.0/16
# IPv6 CIDR ë¸”ë¡ - No IPv6 CIDR Block(IPv6 CIDR ë¸”ë¡ ì—†ìŒ)
# í…Œë„Œì‹œ - ê¸°ë³¸ê°’
# ê°€ìš© ì˜ì—­(AZ)ì˜ ìˆ˜ - 2
# Customize AZs(AZ ì‚¬ìš©ì ì§€ì •) - ê¸°ë³¸ê°’ì„ ìœ ì§€
# í¼ë¸”ë¦­ ì„œë¸Œë„· ìˆ˜ â€“ 2
# í”„ë¼ì´ë¹— ì„œë¸Œë„· ìˆ˜ â€“ 2
# Customize subnets CIDR blocks(ì„œë¸Œë„· CIDR ë¸”ë¡ ì‚¬ìš©ì ì§€ì •) - ê¸°ë³¸ê°’ ìœ ì§€
# NAT ê²Œì´íŠ¸ì›¨ì´($) â€“ ìƒì„±
# VPC ì—”ë“œí¬ì¸íŠ¸ â€“ ì—†ìŒ
# DNS options(DNS ì˜µì…˜) - ê¸°ë³¸ê°’ ìœ ì§€
module "terraform-aws-vps" { # ëª¨ë“ˆ ì‚¬ìš©
  source = "terraform-aws-modules/vpc/aws"

  # ì´ë¦„ ë° vpc cidr ì§€ì •
  name = "terraform-aws-vps"
  cidr = "10.0.0.0/16"

  # az, ì„œë¸Œë„· cidr ì§€ì •
  azs             = ["ap-northeast-2a", "ap-northeast-2c"]
  private_subnets = ["10.0.1.0/24", "10.0.2.0/24"]
  public_subnets  = ["10.0.101.0/24", "10.0.102.0/24"]

  # ê° ì„œë¸Œë„· ìƒì„± ì‹œ suffix ì‹œì •
  private_subnet_suffix  = "private"
  public_subnet_suffix =  "public"

  # igw ì´ë¦„ ì§€ì •
  igw_tags = {
    Name = "terraform-aws-public-igw"
  }

  # nat gateway ìƒì„± ë° ì„¤ì •, ì´ë¦„ ì§€ì •
  enable_nat_gateway = true
  one_nat_gateway_per_az = true
  nat_gateway_tags = {
    Name = "terraform-aws-public-nat"
  }
}
```

â†’ Result : terraform apply ì‹¤í–‰ ê²°ê³¼

(1) VPCÂ ìƒì„±

![https://blog.kakaocdn.net/dn/dorCN9/btsgdBqxkOo/I9zTxI4HkRoJI3GfxRO0Pk/img.png](https://blog.kakaocdn.net/dn/dorCN9/btsgdBqxkOo/I9zTxI4HkRoJI3GfxRO0Pk/img.png)

(2) 4ê°œ ì„œë¸Œë„· ìƒì„±

![https://blog.kakaocdn.net/dn/c4RfK1/btsgiBQFQXS/9MDRCvgieZWRRmIRwJ8Go1/img.png](https://blog.kakaocdn.net/dn/c4RfK1/btsgiBQFQXS/9MDRCvgieZWRRmIRwJ8Go1/img.png)

(3) ë¼ìš°íŒ… í…Œì´ë¸” ìƒì„±

![https://blog.kakaocdn.net/dn/z4cnN/btsgaMNbxXY/QRr1wqds4XnX8vmh1MnkFK/img.png](https://blog.kakaocdn.net/dn/z4cnN/btsgaMNbxXY/QRr1wqds4XnX8vmh1MnkFK/img.png)

(4) IGW ìƒì„±

![https://blog.kakaocdn.net/dn/b7Rdt3/btsgchM702w/KstdJlkKlyg5AQEJ6hoO01/img.png](https://blog.kakaocdn.net/dn/b7Rdt3/btsgchM702w/KstdJlkKlyg5AQEJ6hoO01/img.png)

(5)Â NAT Gateway ë° ê´€ë ¨ ë¦¬ì†ŒìŠ¤(EIP ë“±) ìƒì„±

![https://blog.kakaocdn.net/dn/bmRinI/btsgcsVcYFQ/vEdfuHMgmIk5DULRoQTpx1/img.png](https://blog.kakaocdn.net/dn/bmRinI/btsgcsVcYFQ/vEdfuHMgmIk5DULRoQTpx1/img.png)

![https://blog.kakaocdn.net/dn/b3R5JE/btsgdymSrHG/0u156I1UZF5KNtOGA5biY1/img.png](https://blog.kakaocdn.net/dn/b3R5JE/btsgdymSrHG/0u156I1UZF5KNtOGA5biY1/img.png)

# Step 2 : VPC ë³´ì•ˆ ê·¸ë£¹ ìƒì„± :Â í¼ë¸”ë¦­ ì›¹ ì„œë²„ê°€ ì‚¬ìš©í•  VPC ë³´ì•ˆ ê·¸ë£¹ê³¼Â í”„ë¼ì´ë¹— DB ì›¹ ì„œë²„ê°€ ì‚¬ìš©í•  VPC ë³´ì•ˆ ê·¸ë£¹ì„ ë§Œë“¤ê¸°

[AWS ì½˜ì†”] ì½˜ì†”ì—ì„œ ìƒì„±

ë”ë³´ê¸°

[Terraform] IaC ì½”ë“œë¡œ ì‘ì„±

```# main.tf

###################################################################################
#1. public subnet ë³´ì•ˆê·¸ë£¹ ìƒì„± 

resource "aws_security_group" "public-terraform-aws-security-group" {
  name        = "public-terraform-aws-security-group"
  description = "public-terraform-aws-security-group"
  
  # VPC: ì´ì „ì— ìƒì„±í•œ VPCë¥¼ ì„ íƒ
  vpc_id      = module.terraform-aws-vps.vpc_id

# inbound ê·œì¹™ì— ssh, http í—ˆìš©
  ingress {
    description      = "Allow to Connect VPC EC2 instances by SSH"
    from_port        = 22
    to_port          = 22
    protocol         = "tcp"
    cidr_blocks      = ["HOST IP ADDRESS/32"]
  }

    ingress {
    description      = "Allow to Connect VPC EC2 instances by SSH"
    from_port        = 3306
    to_port          = 3306
    protocol         = "tcp"
    cidr_blocks      = ["0.0.0.0/32"]
  }

   ingress {
    description      = "Allow Public Client to Connect VPC EC2 by HTTP"
    from_port        = 80
    to_port          = 80
    protocol         = "tcp"
    cidr_blocks      = ["0.0.0.0/0"]
  }

# outbound ê·œì¹™ì— ì „ë¶€ í—ˆìš© - apt update ë“±ì„ ìœ„í•´
  egress {
    from_port        = 0
    to_port          = 0
    protocol         = "-1"
    cidr_blocks      = ["0.0.0.0/0"]
  }

  tags = {
    Name = "public-terraform-aws-security-group"
  }
}

###################################################################################
# 2. private subnet ë³´ì•ˆê·¸ë£¹ ìƒì„± 
resource "aws_security_group" "private-terraform-aws-db-security-group" {
  name        = "private-terraform-aws-db-security-group"
  description = "private-terraform-aws-db-security-group"
  
  # VPC: ì´ì „ì— ìƒì„±í•œ VPCë¥¼ ì„ íƒ
  vpc_id      = module.terraform-aws-vps.vpc_id

  # inbound ê·œì¹™ì— ec2ì—ì„œ 3306í¬íŠ¸ì— ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ec2 ë³´ì•ˆ ê·¸ë£¹ í—ˆìš©
  ingress {
    description      = "Allow EC2 instances to Connect MySQL"
    from_port        = 3306
    to_port          = 3306
    protocol         = "tcp"
    security_groups  = [aws_security_group.public-terraform-aws-security-group.id]
  }

  egress {
    from_port        = 3306
    to_port          = 3306
    protocol         = "tcp"
    cidr_blocks      = ["0.0.0.0/0"]
  }

  tags = {
    Name = "private-terraform-aws-db-security-group"
  }
}`

â†’ Result : terraform apply ì‹¤í–‰ ê²°ê³¼

![https://blog.kakaocdn.net/dn/Nf2xR/btsgaL8Cb3N/4H62ABe9HMV9aF8dzxn4Vk/img.png](https://blog.kakaocdn.net/dn/Nf2xR/btsgaL8Cb3N/4H62ABe9HMV9aF8dzxn4Vk/img.png)

# Step 3 :Â DB ì„œë¸Œë„· ê·¸ë£¹ ìƒì„± :Â RDS ì¸ìŠ¤í„´ìŠ¤ê°€ ì‚¬ìš©í•  VPC ì„œë¸Œë„· ê·¸ë£¹ì„ ë§Œë“¤ê¸°

[AWS ì½˜ì†”] ì½˜ì†”ì—ì„œ ìƒì„±

ë”ë³´ê¸°

[Terraform] IaC ì½”ë“œë¡œ ì‘ì„±

```bash
# main.tf

###################################################################################
# DB ì„œë¸Œë„· ê·¸ë£¹ ìƒì„±
resource "aws_db_subnet_group" "terraform-aws-db-subnet-group" {
  name       = "terraform-aws-db-subnet-group"
  description = "terraform-aws-db-subnet-group"

  # private ì„œë¸Œë„·ìœ¼ë¡œ ì§€ì •
  subnet_ids = module.terraform-aws-vps.private_subnets

  tags = {
    Name = "terraform-aws-db-subnet-group"
  }
}
```

â†’ Result : terraform apply ì‹¤í–‰ ê²°ê³¼

![https://blog.kakaocdn.net/dn/cB01PF/btsgbIxuGSj/9PBchjFnIpVTOfP8CgWorK/img.png](https://blog.kakaocdn.net/dn/cB01PF/btsgbIxuGSj/9PBchjFnIpVTOfP8CgWorK/img.png)

# **âœï¸Â EC2Â ì¸ìŠ¤í„´ìŠ¤Â ìƒì„±**

- ìƒì„±í•  EC2 ì‚¬ì–‘
- AMI: Ubuntu Server 18
- ì¸ìŠ¤í„´ìŠ¤ íƒ€ì…: t2.micro
- ì‚¬ìš©ì ë°ì´í„°
    - #!/bin/bashechoÂ "Hello,Â World"Â >Â index.htmlnohup busybox httpd -f -p ${var.server_port} &
- í‚¤Â í˜ì–´:Â ìˆ˜ë™ìœ¼ë¡œÂ ë§Œë“¤ê³ Â EC2ì—Â í• ë‹¹

# Step 1 : EC2 ìƒì„±

[AWS ì½˜ì†”] ì½˜ì†”ì—ì„œ ìƒì„±

ë”ë³´ê¸°

[Terraform] IaC ì½”ë“œë¡œ ì‘ì„±

```bash
###################################################################################
# EC2 ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
# 1. ê° ê°€ìš©ì˜ì—­ì— EC2 ì¸ìŠ¤í„´ìŠ¤ ìƒì„±ì„ ìœ„í•´ local ë³€ìˆ˜ ì„ ì–¸
locals {
  # VPCì—ì„œ ìƒì„±í•œ í¼ë¸”ë¦­ ì„œë¸Œë„· ë¦¬ìŠ¤íŠ¸
  public_subnets  = module.terraform-aws-vps.public_subnets

  public_instance_conf = [
    for index, subnet in local.public_subnets : [{
        # ê° í¼ë¸”ë¦­ ì„œë¸Œë„·ì— ìƒì„±
        subnet_id              = subnet

        # ì‚¬ìš©í•  ë³´ì•ˆ ê·¸ë£¹ìœ¼ë¡œ í¼ë¸”ë¦­ ì„œë¸Œë„·ì— ìƒì„±í•œ ë³´ì•ˆ ê·¸ë£¹ ì§€ì •
        vpc_security_group_ids = [aws_security_group.public-terraform-aws-security-group.id]

        # ì¸ìŠ¤í„´ìŠ¤ëª…, ì‚¬ìš©í•  amiì™€ instance type, ì‚¬ìš©í•  key-pair ì´ë¦„ ì§€ì •

        name                   = "terraform-aws-ec2-${index}"
        ami                    = "ami-0a2a74934366c9715"     # AMI: Ubuntu Server 18
        instance_type          = "t2.micro"                  # ì¸ìŠ¤í„´ìŠ¤ íƒ€ì…: t2.micro
        key_name               = "terraform-aws-key-pair"    # ìˆ˜ë™ìœ¼ë¡œ ë§Œë“  key pairë¥¼ EC2ì— í• ë‹¹

        # EC2 ì‹œì‘ì‹œ ì‹¤í–‰í•  ì‚¬ìš©ì ë°ì´í„° ì…ë ¥
        user_data              =  <<-EOF
        #!/bin/bash
        sudo apt update
        sudo apt install -y mysql-server
        echo "Hello, World" > index.html
        nohup busybox httpd -f -p ${var.server_port} &
        EOF
      }
    ]
  ]
}

# terraformì˜ platten í•¨ìˆ˜ë¥¼ ì´ìš©í•´ ì¼ê´€ëœ ì‹œí€€ìŠ¤ë¡œ ë§Œë“¦
locals {
  public_instance  = flatten(local.public_instance_conf)
}

###################################################################################
# 2. local ë³€ìˆ˜ë¥¼ í™œìš©í•´ EC2 ì¸ìŠ¤í„´ìŠ¤ë“¤ ìƒì„±

resource "aws_instance" "terraform-aws-ec2" {
  for_each                    = {for key, value in local.public_instance : key => value}

  ami                         = each.value.ami
  instance_type               = each.value.instance_type

  # network
  vpc_security_group_ids      = each.value.vpc_security_group_ids
  subnet_id                   = each.value.subnet_id
  associate_public_ip_address = true

  # key-pair
  key_name                    = each.value.key_name
  user_data                   = each.value.user_data

  tags = {
    Name   = each.value.name
    Group  = "terraform-aws-ec2"
  }
}
```

â†’ Result : terraform apply ì‹¤í–‰ ê²°ê³¼

(1) EC2 ì¸ìŠ¤í„´ìŠ¤ ìƒì„±

![https://blog.kakaocdn.net/dn/CgzKn/btsgcNx03JG/6J6bY8SiuoIeKNwci2uIm0/img.png](https://blog.kakaocdn.net/dn/CgzKn/btsgcNx03JG/6J6bY8SiuoIeKNwci2uIm0/img.png)

(2) ì‚¬ìš©ì ë°ì´í„° ì‹¤í–‰ ë‚´ì—­

> ì›¹ ì„œë¹„ìŠ¤ ê¸°ë™

![https://blog.kakaocdn.net/dn/SsDnf/btsf5eQ4icL/ekPKDZW30itBRISWPuxn4K/img.png](https://blog.kakaocdn.net/dn/SsDnf/btsf5eQ4icL/ekPKDZW30itBRISWPuxn4K/img.png)

> mysql ì„œë²„ ì„¤ì¹˜ í›„ DB ì—°ê²° ë˜ëŠ”ì§€ í™•ì¸

![https://blog.kakaocdn.net/dn/pGNzc/btsgbKhJXU8/tvEUvDKRnNWlK2kiM7EiaK/img.png](https://blog.kakaocdn.net/dn/pGNzc/btsgbKhJXU8/tvEUvDKRnNWlK2kiM7EiaK/img.png)

# **âœï¸Â Â [ììŠµì„œ:Â DBÂ ì¸ìŠ¤í„´ìŠ¤Â ìƒì„±](https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/UserGuide/CHAP_Tutorials.WebServerDB.CreateDBInstance.html)**

# Step 1 : DB ì¸ìŠ¤í„´ìŠ¤ ìƒì„±

[AWS ì½˜ì†”]Â [ì½˜ì†”ì—ì„œ ìƒì„±](https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/UserGuide/CHAP_Tutorials.WebServerDB.CreateDBInstance.html)

ë”ë³´ê¸°

[Terraform] IaC ì½”ë“œë¡œ ì‘ì„±

`# variables.tf

# ë³€ìˆ˜ë¡œ ì‚¬ìš©í•  íŒ¨ìŠ¤ì›Œë“œ ì§€ì •
 variable "MYSQL_DB_PASSWORD" {
   description = "MySQL admin user password"
   type        = string
   sensitive   = true
 }
 
 # ì¶”í›„ ì½˜ì†”ì—ì„œ DB íŒ¨ìŠ¤ì›Œë“œ í™˜ê²½ ë³€ìˆ˜ ì„ ì–¸
 $ export TF_VAR_MYSQL_DB_PASSWORD="ë¹„ë°€ë²ˆí˜¸"
 $ terraform init`

```bash
# outputs.tf

# db ì¸ìŠ¤í„´ìŠ¤ ìƒì„± í›„ ì°¸ì¡°í•  output
output "rds_hostname" {
  description = "RDS instance hostname"
  value       = aws_db_instance.terraform-aws-db.address
  sensitive   = true
}

output "rds_port" {
  description = "RDS instance port"
  value       = aws_db_instance.terraform-aws-db.port
  sensitive   = true
}

output "rds_username" {
  description = "RDS instance admin username"
  value       = aws_db_instance.terraform-aws-db.username
  sensitive   = true
}
```

```bash
# main.tf
###################################################################################
# DB ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
# 1. DB íŒŒë¼ë©”í„° ê·¸ë£¹ ìƒì„±
resource "aws_db_parameter_group" "terraform-aws-db-parameter-group" {
  name   = "terraform-aws-db"

   # ìƒì„±í•  db ì—”ì§„ ë²„ì „ê³¼ ë™ì¼í•´ì•¼ í•¨
  family = "mysql8.0"
}

# 2. RDS ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
resource "aws_db_instance" "terraform-aws-db" {
  # db instance name
  identifier             = "terraform-aws-db"

  # db spec
  instance_class         = "db.t3.micro"
  allocated_storage      = 20
  engine                 = "mysql"
  engine_version         = "8.0.32"

  # db network setting
  db_subnet_group_name   = aws_db_subnet_group.terraform-aws-db-subnet-group.name
  vpc_security_group_ids = [aws_security_group.private-terraform-aws-db-security-group.id]

  # db default setting
  username               = "admin"
  password               = var.MYSQL_DB_PASSWORD # terraform cloud setup
  db_name                = "terraformAwsDb"
  parameter_group_name   = aws_db_parameter_group.terraform-aws-db-parameter-group.name
  skip_final_snapshot    = true
}
```

â†’ Result : terraform apply ì‹¤í–‰ ê²°ê³¼

![https://blog.kakaocdn.net/dn/bLG70m/btsf6EveoSd/ozHjji8d3yv3k2qkFCaSpk/img.png](https://blog.kakaocdn.net/dn/bLG70m/btsf6EveoSd/ozHjji8d3yv3k2qkFCaSpk/img.png)

![https://blog.kakaocdn.net/dn/kYgL3/btsge4Z8i8v/JS4f3yhpcCKDhYnygFWGI1/img.png](https://blog.kakaocdn.net/dn/kYgL3/btsge4Z8i8v/JS4f3yhpcCKDhYnygFWGI1/img.png)

![https://blog.kakaocdn.net/dn/bsthzY/btsf6FAUL64/Ee734dr7R44mv6S4eJspFk/img.png](https://blog.kakaocdn.net/dn/bsthzY/btsf6FAUL64/Ee734dr7R44mv6S4eJspFk/img.png)

# **âœï¸Â ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œë“œ ë°¸ëŸ°ì„œ ë° Auto Scaling Group ì ìš©**

# Step 1 : Target Group ìƒì„±

[AWS ì½˜ì†”]Â [ì½˜ì†”ì—ì„œ ìƒì„±](https://docs.aws.amazon.com/ko_kr/elasticloadbalancing/latest/application/create-target-group.html)



[Terraform] IaC ì½”ë“œë¡œ ì‘ì„±

```bash
# main.tf

###################################################################################
# íƒ€ê²Ÿ ê·¸ë£¹ ìƒì„±
resource "aws_lb_target_group" "terraform-aws-tg" {
  name        = "terraform-aws-tg"
  target_type = "instance"
  port        = 80
  protocol    = "HTTP"
  vpc_id      = module.terraform-aws-vps.vpc_id
  health_check {
    matcher = "200-299"
  }
}
```

â†’ Result : terraform apply ì‹¤í–‰ ê²°ê³¼

![https://blog.kakaocdn.net/dn/bUPFrh/btsgcggpV1x/6GVRLO2RRf7Y2KibQixkT0/img.png](https://blog.kakaocdn.net/dn/bUPFrh/btsgcggpV1x/6GVRLO2RRf7Y2KibQixkT0/img.png)

# Step 2 : ALB ìƒì„±

[AWS ì½˜ì†”]Â [ì½˜ì†”ì—ì„œ ìƒì„±](https://docs.aws.amazon.com/ko_kr/elasticloadbalancing/latest/application/create-application-load-balancer.html)



[Terraform] IaC ì½”ë“œë¡œ ì‘ì„±

```bash
# main.tf

###################################################################################
# 1. ALB ìƒì„±
resource "aws_lb" "terraform-aws-alb" {
  name               = "terraform-aws-alb"
  internal           = false
  load_balancer_type = "application"
  security_groups    = [aws_security_group.public-terraform-aws-security-group.id]
  subnets            = [for subnet in module.terraform-aws-vps.public_subnets : subnet]
  tags = {
    Name = "terraform-aws-alb"
  }
}

#2. ë¡œë“œë°¸ëŸ°ì„œì— ë¦¬ìŠ¤ë„ˆ ìƒì„±
resource "aws_lb_listener" "terraform-aws-alb-listener" {
  load_balancer_arn = aws_lb.terraform-aws-alb.arn
  port              = "80"
  protocol          = "HTTP"

  default_action {
    type             = "forward"
    target_group_arn = aws_lb_target_group.terraform-aws-tg.arn
  }
}
```

â†’ Result : terraform apply ì‹¤í–‰ ê²°ê³¼

![https://blog.kakaocdn.net/dn/nZTvM/btsgiCovYKy/OpFiMG6K3E1ggF5kXeJN9K/img.png](https://blog.kakaocdn.net/dn/nZTvM/btsgiCovYKy/OpFiMG6K3E1ggF5kXeJN9K/img.png)

# Step 3 : Auto Scaling Groupì„ ìœ„í•œÂ EC2Â ì‹œì‘ í…œí”Œë¦¿ ìƒì„±

[AWS ì½˜ì†”]Â [ì½˜ì†”ì—ì„œ ìƒì„±](https://docs.aws.amazon.com/ko_kr/autoscaling/ec2/userguide/create-launch-template.html#create-launch-template-for-auto-scaling)



[Terraform] IaC ì½”ë“œë¡œ ì‘ì„±

```bash
# main.tf

###################################################################################
#1. EC2 ì‹œì‘ í…œí”Œë¦¿ ìƒì„±
resource "aws_launch_template" "terraform-aws-launch-template" {
  name                         = "terraform-aws-launch-template"
  image_id                     = "ami-0a2a74934366c9715"
  instance_type                = "t2.micro"

  #vpc_security_group_ids       = [aws_security_group.public-terraform-aws-security-group.id]
  key_name                     = "terraform-aws-key-pair"
  user_data                    =  filebase64("${path.module}/user-data.sh")

  network_interfaces {
    security_groups = [aws_security_group.public-terraform-aws-security-group.id]
    associate_public_ip_address = true
  }

  monitoring {
    enabled = true
  }

  tag_specifications {
    resource_type = "instance"

    tags = {
      Name   = "terraform-aws-ec2-autoscaled"
      Group  = "terraform-aws-ec2"
    }
  }
}
```

```bash
# user-data.sh

# EC2 ì¸ìŠ¤í„´ìŠ¤ ì‹œì‘ì‹œë§ˆë‹¤ ìŠ¤í¬ë¦½íŠ¸ê°€ ê¸°ë™í•˜ë„ë¡ ì„¤ì •
Content-Type: multipart/mixed; boundary="//"
MIME-Version: 1.0

--//
Content-Type: text/cloud-config; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="cloud-config.txt"

#cloud-config
cloud_final_modules:
- [scripts-user, always]

--//
Content-Type: text/x-shellscript; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="userdata.txt"

# ì‹¤ì œ ì‹¤í–‰í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ ë‚´ìš©
#!/bin/bash
sudo apt update -y
sudo apt install -y mysql-server
echo "Hello, World" > index.html
sudo nohup busybox httpd -f -p 80 &
--//--
```

â†’ Result : terraform apply ì‹¤í–‰ ê²°ê³¼

![https://blog.kakaocdn.net/dn/mf9Og/btsge6cxMbE/u5l5zdreQ2RA8aFQZ49dZk/img.png](https://blog.kakaocdn.net/dn/mf9Og/btsge6cxMbE/u5l5zdreQ2RA8aFQZ49dZk/img.png)

![https://blog.kakaocdn.net/dn/bYQofs/btsgeyfR0Yn/zT53jgPdIf6OBOjaGLA3lk/img.png](https://blog.kakaocdn.net/dn/bYQofs/btsgeyfR0Yn/zT53jgPdIf6OBOjaGLA3lk/img.png)

# Step 4 : Auto Scaling Group ìƒì„±

- Auto Scaling Groupì€ ìµœì†Œ 2ê°œ, ìµœëŒ€ 10ê°œë¡œ ì„¤ì •

[AWS ì½˜ì†”]Â [ì½˜ì†”ì—ì„œ ìƒì„±](https://docs.aws.amazon.com/ko_kr/autoscaling/ec2/userguide/create-asg-launch-template.html)



[Terraform] IaC ì½”ë“œë¡œ ì‘ì„±

```bash
# main.tf

###################################################################################
# ì‹œì‘ í…œí”Œë¦¿ì„ ë°”íƒ•ìœ¼ë¡œ auto scaling group ìƒì„±
resource "aws_autoscaling_group" "terraform-aws-auto-scaling-group" {
  name                      = "terraform-aws-auto-scaling-group"
  max_size                  = 10
  min_size                  = 2
  health_check_grace_period = 300
  desired_capacity          = 2
  vpc_zone_identifier       = [for subnet in module.terraform-aws-vps.public_subnets : subnet]
  launch_template {
    id = aws_launch_template.terraform-aws-launch-template.id
    version = "$Latest"
  }
  target_group_arns = [aws_lb_target_group.terraform-aws-tg.arn]
}
```

â†’ Result : terraform apply ì‹¤í–‰ ê²°ê³¼

![https://blog.kakaocdn.net/dn/GfAHq/btsgezMDx79/bRgVQpYwyQkDPX3rsqVlxK/img.png](https://blog.kakaocdn.net/dn/GfAHq/btsgezMDx79/bRgVQpYwyQkDPX3rsqVlxK/img.png)

![https://blog.kakaocdn.net/dn/boLbdf/btsggNKx88I/lxle3tyEIj8XKWBRVVV9FK/img.png](https://blog.kakaocdn.net/dn/boLbdf/btsggNKx88I/lxle3tyEIj8XKWBRVVV9FK/img.png)

# #TROUBLE SHOOTING & STUDY LOG

# ğŸ“ EC2 ì‹œì‘ ì‹œ user-data.sh íŒŒì¼ì´ ì‹¤í–‰ë˜ì§€ ì•ŠëŠ” ë¬¸ì œ

í˜„ìƒ

```bash
__init__.py[WARNING]: Unhandled non-multipart (text/x-not-multipart) userdata: 'b'\\ufeff#!/bin/bash'...'
```

ì›ì¸

- terraformì€ us-ascii ì¸ì½”ë”©ì„ ì‚¬ìš©í•˜ëŠ”ë° vscodeì—ì„œ shíŒŒì¼ ìƒì„± ì‹œ utf-8ë¡œ ì¸ì½”ë”©ë˜ê¸° ë•Œë¬¸ì— ë°œìƒí•˜ëŠ” ë¬¸ì œ
- cloud-init.log í™•ì¸ ì‹œ pythonì—ì„œ ì¸ì½”ë”© ì‹œ \\ufeff ë¬¸ìê°€ ë””ì½”ë”©ëœ ë¡œê·¸ í™•ì¸ ê°€ëŠ¥

í•´ê²° ë°©ì•ˆ

- user-data.sh íŒŒì¼ì„ us-ascii ì¸ì½”ë”©í•´ì„œ ì „ë‹¬
- ec2 ì¸ìŠ¤í„´ìŠ¤ì— ssh ì ‘ì† ì‹œ /var/log/cloud-init.logì—ì„œ ì˜¤ë¥˜ í™•ì¸ì´ ê°€ëŠ¥í•˜ê³ , /var/lib/cloud/<instancesëª…>ì— ì‹¤í–‰ëœ ì‚¬ìš©ì ë°ì´í„° í™•ì¸ ê°€ëŠ¥

```bash
2023-05-16 10:22:38,126 - handlers.py[DEBUG]: finish: init-network/consume-user-data: SUCCESS: reading and applying user-data
```

# ğŸ“ terraform destroy ì‹œ network Interfaceê°€ ì‚­ì œë˜ì§€ ì•ŠëŠ” í˜„ìƒ

ì›ì¸

- terraform íŒŒì¼ ì‘ì„± ì‹œ load balancer ë¦¬ì†ŒìŠ¤ ë¸”ëŸ­ì— enable_deletion_protection = true ì„¤ì •ì„ í•˜ë©´ ì‚­ì œ ë°©ì§€ê°€ ë˜ì–´ ì‚­ì œë˜ì§€ ì•ŠëŠ” í˜„ìƒ

í•´ê²° ë°©ì•ˆ

- í•´ë‹¹ ì„¤ì •ì„ í•´ì œ

# ğŸ“ terraform block ì¤‘ resourceì™€ module ì°¨ì´

# resource

- ë¦¬ì†ŒìŠ¤ëŠ” aws_vpc, aws_db_instanceë“±
- ë¦¬ì†ŒìŠ¤ëŠ” ê³µê¸‰ìì— ì†í•˜ê³ , ì¸ìˆ˜ë¥¼ ë°›ì•„ë“¤ì´ê³ , ì†ì„±ì„ ì¶œë ¥í•˜ê³ , ìˆ˜ëª… ì£¼ê¸°ë¥¼ ê°€ì§
- ë¦¬ì†ŒìŠ¤ë¥¼ ìƒì„±, ê²€ìƒ‰, ì—…ë°ì´íŠ¸ ë° ì‚­ì œ ê°€ëŠ¥

# module

- ë¦¬ì†ŒìŠ¤ ëª¨ë“ˆì€ ê³µí†µ ì‘ì—…ì„ í•¨ê»˜ ìˆ˜í–‰í•˜ëŠ” ì—°ê²°ëœ ë¦¬ì†ŒìŠ¤ ëª¨ìŒ (ex. VPC, ì„œë¸Œë„·, NAT ê²Œì´íŠ¸ì›¨ì´ ë“± ìƒì„±)
- ê³µê¸‰ì êµ¬ì„±ì— ë”°ë¼ ë‹¬ë¼ì§€ë©°,Â ê³µê¸‰ìÂ êµ¬ì„± ë˜ëŠ” ìƒìœ„ ìˆ˜ì¤€ êµ¬ì¡°(ì˜ˆ: ì¸í”„ë¼ ëª¨ë“ˆ)ì—ì„œ ì •ì˜ ê°€ëŠ¥

# #REFERENCES

[https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/UserGuide/CHAP_terraform-awss.WebServerDB.CreateDBInstance.html](https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/UserGuide/CHAP_Tutorials.WebServerDB.CreateDBInstance.html)



[https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/AccessingInstancesLinux.html](https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/AccessingInstancesLinux.html)



[https://cloud-images.ubuntu.com/locator/ec2/](https://cloud-images.ubuntu.com/locator/ec2/)



[https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/UserGuide/CHAP_terraform-awss.WebServerDB.CreateWebServer.html](https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/UserGuide/CHAP_Tutorials.WebServerDB.CreateWebServer.html)



[https://ubuntu.com/server/docs/databases-mysql](https://ubuntu.com/server/docs/databases-mysql)



[https://developer-ping9.tistory.com/402](https://developer-ping9.tistory.com/402)



[https://yunamom.tistory.com/295](https://yunamom.tistory.com/295)



[https://developer-ping9.tistory.com/402](https://developer-ping9.tistory.com/402)



[https://registry.terraform.io/providers/hashicorp/aws/latest/docs](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)



[https://registry.terraform.io/modules/terraform-aws-modules/vpc/aws/latest](https://registry.terraform.io/modules/terraform-aws-modules/vpc/aws/latest)



[https://registry.terraform.io/providers/hashicorp/aws/latest](https://registry.terraform.io/providers/hashicorp/aws/latest)



[https://registry.terraform.io/modules/terraform-aws-modules/security-group/aws/latest/submodules/web](https://registry.terraform.io/modules/terraform-aws-modules/security-group/aws/latest/submodules/web)



[https://github.com/terraform-aws-modules/terraform-aws-security-group/blob/master/](https://github.com/terraform-aws-modules/terraform-aws-security-group/blob/master/)

[https://registry.terraform.io/modules/terraform-aws-modules/vpc/aws/latestrules.tf](https://registry.terraform.io/modules/terraform-aws-modules/vpc/aws/latestrules.tf)



[https://github.com/hashicorp/learn-terraform-rds](https://github.com/hashicorp/learn-terraform-rds)



[https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/instance](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/instance)



[https://www.middlewareinventory.com/blog/terraform-aws-ec2-user_data-example/](https://www.middlewareinventory.com/blog/terraform-aws-ec2-user_data-example/)



[https://levelup.gitconnected.com/provision-multiple-ec2-instances-on-multiple-subnets-using-terraform-528a198b48c](https://levelup.gitconnected.com/provision-multiple-ec2-instances-on-multiple-subnets-using-terraform-528a198b48c)



[https://stackoverflow.com/questions/66598788/terraform-how-can-i-reference-terraform-cloud-environmental-variables](https://stackoverflow.com/questions/66598788/terraform-how-can-i-reference-terraform-cloud-environmental-variables)



[https://developer.hashicorp.com/terraform/language/values/variables#environment-variables](https://developer.hashicorp.com/terraform/language/values/variables#environment-variables)



[https://discuss.hashicorp.com/t/passing-user-data-to-ec2-instance/12251](https://discuss.hashicorp.com/t/passing-user-data-to-ec2-instance/12251)



[https://developer.hashicorp.com/terraform/language/expressions/for](https://developer.hashicorp.com/terraform/language/expressions/for)



[https://docs.aws.amazon.com/ko_kr/vpc/latest/userguide/nat-gateway-scenarios.html#public-nat-internet-access](https://docs.aws.amazon.com/ko_kr/vpc/latest/userguide/nat-gateway-scenarios.html#public-nat-internet-access)



[https://docs.aws.amazon.com/ko_kr/vpc/latest/userguide/vpc-nat-gateway.html#nat-gateway-creating](https://docs.aws.amazon.com/ko_kr/vpc/latest/userguide/vpc-nat-gateway.html#nat-gateway-creating)



[https://docs.aws.amazon.com/ko_kr/vpc/latest/userguide/amazon-vpc-limits.html#vpc-limits-eips](https://docs.aws.amazon.com/ko_kr/vpc/latest/userguide/amazon-vpc-limits.html#vpc-limits-eips)



[https://terraform101.inflearn.devopsart.dev/cont/vpc-practice/vpc-practice-with-nat/](https://terraform101.inflearn.devopsart.dev/cont/vpc-practice/vpc-practice-with-nat/)



[https://github.com/terraform-aws-modules/terraform-aws-vpc/pull/816](https://github.com/terraform-aws-modules/terraform-aws-vpc/pull/816)



[https://developer.hashicorp.com/terraform/language/expressions/references](https://developer.hashicorp.com/terraform/language/expressions/references)



[https://developer.hashicorp.com/terraform/language/expressions/references](https://developer.hashicorp.com/terraform/language/expressions/references)



[https://tf-eks-workshop.workshop.aws/600_extra_content/610-second-node-group/tf-files.html](https://tf-eks-workshop.workshop.aws/600_extra_content/610-second-node-group/tf-files.html)



[https://github.com/hashicorp/terraform-provider-aws/blob/main/internal/service/ec2/ec2_launch_template.go](https://github.com/hashicorp/terraform-provider-aws/blob/main/internal/service/ec2/ec2_launch_template.go)



[https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/user-data.html](https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/user-data.html)



[https://developer.hashicorp.com/terraform/language/functions/filebase64](https://developer.hashicorp.com/terraform/language/functions/filebase64)



[https://repost.aws/ko/knowledge-center/execute-user-data-ec2](https://repost.aws/ko/knowledge-center/execute-user-data-ec2)



[https://developer.hashicorp.com/terraform/language/functions/flatten](https://developer.hashicorp.com/terraform/language/functions/flatten)



[https://medium.com/@mitesh_shamra/module-in-terraform-920257136228](https://medium.com/@mitesh_shamra/module-in-terraform-920257136228)



[https://www.terraform-best-practices.com/key-concepts](https://www.terraform-best-practices.com/key-concepts)

