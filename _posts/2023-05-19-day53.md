---
date: 2023-05-19 00:00:00
layout: post
title: DevOps&#91;ìƒˆ ë²„ì „ì´ ë§ê°€ì¡Œì–´ìš”&#93; / [Sprint]
subtitle: '01. ìƒˆ ë²„ì „ì´ ë§ê°€ì¡Œì–´ìš”'
description: 01. ìƒˆ ë²„ì „ì´ ë§ê°€ì¡Œì–´ìš”
image: /thumbnail/k8s.png
optimized_image: /thumbnail/k8s.png
category: Sprint
tags:
  - k8s
  - ì¿ ë²„ë„¤í‹°ìŠ¤
  - ì»¨í…Œì´ë„ˆ
  - ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜
  - Kubernetes
  - minikube
  - kubrctl
  - DevOps BootCamp
author: teddy-woo

---

# #í•™ìŠµ ëª©í‘œ

- íŒŒë“œ ëª…ì„¸ë¥¼ ì‘ì„±í•  ìˆ˜ ìˆë‹¤.
- ë””í”Œë¡œì´ë¨¼íŠ¸ ëª…ì„¸ë¥¼ ì‘ì„±í•  ìˆ˜ ìˆë‹¤.
- ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•´ íŒŒë“œë¥¼ ë…¸ì¶œí•  ìˆ˜ ìˆë‹¤.
- kubectl apply ëª…ë ¹ì„ ì´ìš©í•´ ë¦¬ì†ŒìŠ¤ë¥¼ ìƒì„±í•  ìˆ˜ ìˆë‹¤.
- ë””í”Œë¡œì´ë¨¼íŠ¸ ëª…ì„¸ë¥¼ ìˆ˜ì •(ë˜ëŠ” ì¬ì‘ì„±)í•˜ì—¬ ìƒˆë¡œìš´ ë²„ì „ì„ ë°°í¬í•  ìˆ˜ ìˆë‹¤.
- kubectl rollout ëª…ë ¹ì„ ì´ìš©í•´ ë¡¤ë§ ë°°í¬ í˜„í™©ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
- ìƒˆë¡œìš´ ë²„ì „ì— ë¬¸ì œê°€ ë°œìƒí–ˆì„ ë•Œ ë¡¤ë°±í•  ìˆ˜ ìˆë‹¤.

# #í•´ê²° ê³¼ì œ

ğŸ’¡ cozserver-deployment-v1.yaml

ğŸ’¡Â cozserver-deployment-v2.yaml

ğŸ’¡Â cozserver-deployment-v3.yaml

ğŸ’¡Â cozserver-service.yaml

ğŸ’¡Â rollback-log.txtÂ (ë¡¤ë°±Â í„°ë¯¸ë„Â ë¡œê·¸)

# #ê³¼ì œ í•­ëª©ë³„ ì§„í–‰ ìƒí™©

# âœï¸Â STEP 0 : ë„ì»¤ë¡œ ì»¨í…Œì´ë„ˆ êµ¬ë™ ë³µìŠµ

```
$ docker run -p 80:8080 sebcontents/cozserver:1.0

Unable to find image 'sebcontents/cozserver:1.0' locally
1.0: Pulling from sebcontents/cozserver
59bf1c3509f3: Pull complete
683dd8c3cc08: Pull complete
ae5b2724f19b: Pull complete
39190df3f477: Pull complete
ace5267edc85: Pull complete
054a12501f62: Pull complete
5012be8966ae: Pull complete
00df233fc0a3: Pull complete
Digest: sha256:b22208c1daa48966da36df4bcd365167b7585b8708d2a669c016cb2b9049eb11
Status: Downloaded newer image for sebcontents/cozserver:1.0
Example app listening at http://localhost:8080
[v1] running in pod ::ffff:172.17.0.1
```

# **âœï¸**Â STEP 1 : íŒŒë“œ

# 0. minikube ì»¨í…Œì´ë„ˆ ì‹¤í–‰

```
$ minikube start
ğŸ˜„  Darwin 10.15.7 ì˜ minikube v1.30.1
âœ¨  ê¸°ì¡´ í”„ë¡œí•„ì— ê¸°ë°˜í•˜ì—¬ docker ë“œë¼ì´ë²„ë¥¼ ì‚¬ìš©í•˜ëŠ” ì¤‘
ğŸ‘  minikube í´ëŸ¬ìŠ¤í„°ì˜ minikube ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ ë…¸ë“œë¥¼ ì‹œì‘í•˜ëŠ” ì¤‘
ğŸšœ  ë² ì´ìŠ¤ ì´ë¯¸ì§€ë¥¼ ë‹¤ìš´ë°›ëŠ” ì¤‘ ...
ğŸ”„  Restarting existing docker container for "minikube" ...
ğŸ³  ì¿ ë²„ë„¤í‹°ìŠ¤ v1.26.3 ì„ Docker 23.0.2 ëŸ°íƒ€ì„ìœ¼ë¡œ ì„¤ì¹˜í•˜ëŠ” ì¤‘
ğŸ”—  Configuring bridge CNI (Container Networking Interface) ...
ğŸ”  Kubernetes êµ¬ì„± ìš”ì†Œë¥¼ í™•ì¸...
    â–ª Using image gcr.io/k8s-minikube/storage-provisioner:v5
ğŸŒŸ  ì• ë“œì˜¨ í™œì„±í™” : storage-provisioner
ğŸ„  ëë‚¬ìŠµë‹ˆë‹¤! kubectlì´ "minikube" í´ëŸ¬ìŠ¤í„°ì™€ "default" ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ê¸°ë³¸ì ìœ¼ë¡œ ì‚¬ìš©í•˜ë„ë¡ êµ¬ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
```

# 1. sebcontents/cozserver:1.0 ì´ë¯¸ì§€ë¥¼ ë°”íƒ•ìœ¼ë¡œ cozserver-pod.yaml ì— íŒŒë“œ ëª…ì„¸ ì‘ì„±

```
# cozserver-pod.yaml

apiVersion: v1
kind: Pod
metadata:
  name: cozserver
spec:
  containers:
  - name: cozserver
    image: sebcontents/cozserver:1.0
    ports:
    - containerPort: 8080
```

# 2. kubectl ëª…ë ¹ì–´ë¡œ íŒŒë“œ ì‹¤í–‰

```
$ kubectl apply -f cozserver-pod.yaml
pod/cozserver created

$ kubectl get pods -A
NAMESPACE     NAME                               READY   STATUS              RESTARTS       AGE
default       cozserver                          0/1     ContainerCreating   0              8s
kube-system   coredns-787d4945fb-xl4b5           1/1     Running             1 (115s ago)   14h
kube-system   etcd-minikube                      1/1     Running             1 (115s ago)   14h
kube-system   kube-apiserver-minikube            1/1     Running             1 (114s ago)   14h
kube-system   kube-controller-manager-minikube   1/1     Running             1 (115s ago)   14h
kube-system   kube-proxy-7cx2g                   1/1     Running             1 (115s ago)   14h
kube-system   kube-scheduler-minikube            1/1     Running             1 (115s ago)   14h
kube-system   storage-provisioner                1/1     Running             3 (49s ago)    14h

$ kubectl describe pod cozserver
Name:             cozserver
Namespace:        default
Priority:         0
Service Account:  default
Node:             minikube/
Start Time:       Fri, 19 May 2023 10:26:55 +0900
Labels:           <none>
Annotations:      <none>
Status:           Running
IP:               10.244.0.9
IPs:
  IP:  10.244.0.9
Containers:
  cozserver:
    Container ID:   docker://99e3faabf244961a798945a09f738b17a5554c48e05b57c6cfafae85aba1e059
    Image:          sebcontents/cozserver:1.0
    Image ID:       docker-pullable://sebcontents/cozserver@sha256:b22208c1daa48966da36df4bcd365167b7585b8708d2a669c016cb2b9049eb11
    Port:           8080/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Fri, 19 May 2023 10:27:11 +0900
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-hn6kk (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  kube-api-access-hn6kk:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  61s   default-scheduler  Successfully assigned default/cozserver to minikube
  Normal  Pulling    60s   kubelet            Pulling image "sebcontents/cozserver:1.0"
  Normal  Pulled     46s   kubelet            Successfully pulled image "sebcontents/cozserver:1.0" in 14.497008832s (14.497067596s including waiting)
  Normal  Created    45s   kubelet            Created container cozserver
  Normal  Started    45s   kubelet            Started container cozserver
```

# 3. ìƒì„±í•œ pods ì‚­ì œ

```
$ kubectl delete pods cozserver
pod "cozserver" deleted

$ kubectl get pods
No resources found in default namespace.
```

# **âœï¸**Â STEP 2: ë””í”Œë¡œì´ë¨¼íŠ¸ë¥¼ ì´ìš©í•œ 1.0 ë°°í¬

# 1. sebcontents/cozserver:1.0 ì´ë¯¸ì§€ë¥¼ ë°”íƒ•ìœ¼ë¡œ cozserver-deployment-v1.yamlì— íŒŒë“œ ë””í”Œë¡œì´ë¨¼íŠ¸ ëª…ì„¸ ì‘ì„±

```
# cozserver-deployment-v1.yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  name: cozserver-deployment # metadata.name : ë””í”Œë¡œì´ë¨¼íŠ¸ëª…
  labels:
    app: cozserver
spec:
  replicas: 1 # spec.replicas í•„ë“œ: ë””í”Œë¡œì´ë¨¼íŠ¸ê°€ ìƒì„±í•˜ëŠ” ë ˆí”Œë¦¬ì¹´ íŒŒë“œ ìˆ˜
  selector:
    matchLabels:
      app: cozserver # spec.selector í•„ë“œ: ë””í”Œë¡œì´ë¨¼íŠ¸ê°€ ê´€ë¦¬í•  íŒŒë“œë¥¼ ì°¾ëŠ” ë°©ë²•ì„ ì •ì˜ (íŒŒë“œ í…œí”Œë¦¿ì— ì •ì˜ëœ ë ˆì´ë¸”ì„ ì„ íƒ)
  template:
    metadata:
      labels:
        app: cozserver
    spec:
      containers:
      - name: cozserver # ìƒì„±í•  íŒŒë“œëª…
        image: sebcontents/cozserver:1.0 # ìƒì„±í•  íŒŒë“œ ì´ë¯¸ì§€
        ports: # íŒŒë“œ ì»¨í…Œì´ë„ˆì— ë…¸ì¶œí•  í¬íŠ¸
        - containerPort: 8080
```

# 2. kubectl ëª…ë ¹ì–´ë¡œ ë””í”Œë¡œì´ë¨¼íŠ¸ ëª…ì„¸ ì‹¤í–‰

```
$ kubectl apply -f cozserver-deployment-v1.yaml --record
Flag --record has been deprecated, --record will be removed in the future
deployment.apps/cozserver-deployment created

# NAME: ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ìˆëŠ” ë””í”Œë¡œì´ë¨¼íŠ¸ ì´ë¦„ì˜ ëª©ë¡
# READY: ì‚¬ìš©ìê°€ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë ˆí”Œë¦¬ì¹´ì˜ ìˆ˜ë¥¼ í‘œì‹œ
# UP-TO-DATE: ì˜ë„í•œ ìƒíƒœë¥¼ ì–»ê¸° ìœ„í•´ ì—…ë°ì´íŠ¸ëœ ë ˆí”Œë¦¬ì¹´ì˜ ìˆ˜ë¥¼ í‘œì‹œ
# AVAILABLE: ì‚¬ìš©ìê°€ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆí”Œë¦¬ì¹´ì˜ ìˆ˜ë¥¼ í‘œì‹œ
# AGE: ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì‹¤í–‰ëœ ì‹œê°„ì„ í‘œì‹œ
$ kubectl get deployments
NAME                   READY   UP-TO-DATE   AVAILABLE   AGE
cozserver-deployment   1/1     1            1           11s

$ kubectl describe deployment cozserver-deployment
Name:                   cozserver-deployment
Namespace:              default
CreationTimestamp:      Fri, 19 May 2023 11:25:12 +0900
Labels:                 app=cozserver
Annotations:            deployment.kubernetes.io/revision: 1
                        kubernetes.io/change-cause: kubectl apply --filename=cozserver-deployment-v1.yaml --record=true
Selector:               app=cozserver
Replicas:               1 desired | 1 updated | 1 total | 1 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:  app=cozserver
  Containers:
   cozserver:
    Image:        sebcontents/cozserver:1.0
    Port:         8080/TCP
    Host Port:    0/TCP
    Environment:  <none>
    Mounts:       <none>
  Volumes:        <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  <none>
NewReplicaSet:   cozserver-deployment-58df6df99f (1/1 replicas created)
Events:
  Type    Reason             Age   From                   Message
  ----    ------             ----  ----                   -------
  Normal  ScalingReplicaSet  24s   deployment-controller  Scaled up replica set cozserver-deployment-58df6df99f to 1
```

# 3. kubectl ëª…ë ¹ì–´ë¡œ ë ˆí”Œë¦¬ì¹´ì…‹ ì¶œë ¥

```
# NAME: ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ìˆëŠ” ë ˆí”Œë¦¬ì¹´ì…‹ ì´ë¦„ì˜ ëª©ë¡
# DESIRED: ë””í”Œë¡œì´ë¨¼íŠ¸ì˜ ìƒì„± ì‹œ ì •ì˜ëœ ì˜ë„í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆí”Œë¦¬ì¹´ì˜ ìˆ˜
# CURRENT: í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ë ˆí”Œë¦¬ì¹´ì˜ ìˆ˜ë¥¼ í‘œì‹œ
# READY: ì‚¬ìš©ìê°€ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë ˆí”Œë¦¬ì¹´ì˜ ìˆ˜ë¥¼ í‘œì‹œ
# AGE: ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì‹¤í–‰ëœ ì‹œê°„ì„ í‘œì‹œ
$ kubectl get rs
NAME                              DESIRED   CURRENT   READY   AGE
cozserver-deployment-58df6df99f   1         1         1       4m48s

$ kubectl get pods --show-labels
NAME                                    READY   STATUS    RESTARTS   AGE    LABELS
cozserver-deployment-58df6df99f-6jb86   1/1     Running   0          5m8s   app=cozserver,pod-template-hash=58df6df99f
```

# **âœï¸**Â STEP 3: ì„œë¹„ìŠ¤

# 1. cozserver-service.yamlì— ì„œë¹„ìŠ¤ ëª…ì„¸ ì‘ì„±

```
# cozserver-service.yaml

apiVersion: v1
kind: Service
metadata:
  name: cozserver-service
spec:
  type: LoadBalancer
  selector:
    app: cozserver
  ports:
    - protocol: TCP
      port: 80            # ë…¸ì¶œí•  í¬íŠ¸
      targetPort: 8080    # íŒŒë“œ í¬íŠ¸
```

# 2. kubectl ëª…ë ¹ì–´ë¡œ ì„œë¹„ìŠ¤ ëª…ì„¸ ì‹¤í–‰

```
$ kubectl apply -f cozserver-service.yaml
service/cozserver-service created

# minikubeëŠ” í„°ë„ë§ì„ í•´ì£¼ì–´ì•¼ external-ipë¥¼ ë¡œì»¬í˜¸ìŠ¤íŠ¸ë¡œ ì—°ê²°í•  ìˆ˜ ìˆìŒ
$ minikube tunnel

# ì„œë¹„ìŠ¤ ì¡°íšŒ
$ kubectl get services
NAME                TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE
cozserver-service   LoadBalancer   10.96.120.43   127.0.0.1     80:31500/TCP   34s
kubernetes          ClusterIP      10.96.0.1      <none>        443/TCP        15h
```

# 3. docker exec -it <ì»¨í…Œì´ë„ˆ ID> /bin/shë¡œ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ í™•ì¸

```
$ docker exec -it ddf08e8a703a /bin/sh

$ ls
Dockerfile         node_modules       package.json
app.js             package-lock.json

$ cat app.js
const express = require('express')
const cors = require('cors')
const os = require('os')
const app = express()
app.use(cors())
const port = 8080

app.get('/', (req, res) => {
  console.log('[v1] running in pod ' + req.socket.remoteAddress)
  res.send(`
    <h1>CozServerì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</h1>
    <div>ë²„ì „: v1.0</div>
    <div>íŒŒë“œ ì´ë¦„: ${os.hostname()}</div>
    <div>${req.socket.remoteAddress}ì—ì„œ ì˜¤ì…¨êµ°ìš”!</div>
  `)
})

app.listen(port, () => {
  console.log(`Example app listening at http://localhost:${port}`)
})
```

# 4. http://localhostë¡œ ì ‘ì†í•´ë³´ê¸°

![https://blog.kakaocdn.net/dn/c1iRjH/btsgBeaXj04/yKDWdUPo3kcHKzY51e8xz1/img.png](https://blog.kakaocdn.net/dn/c1iRjH/btsgBeaXj04/yKDWdUPo3kcHKzY51e8xz1/img.png)

# **âœï¸**Â STEP 4: 2.0 ë°°í¬, ë¡¤ì•„ì›ƒ

# 1. sebcontents/cozserver:2.0 ì´ë¯¸ì§€ë¥¼ ë°”íƒ•ìœ¼ë¡œ cozserver-deployment-v2.yamlì— íŒŒë“œ ë””í”Œë¡œì´ë¨¼íŠ¸ ëª…ì„¸ ì‘ì„±

```
# cozserver-deployment-v2.yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  name: cozserver-deployment
  labels:
    app: cozserver
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
  selector:
    matchLabels:
      app: cozserver
  template:
    metadata:
      labels:
        app: cozserver
    spec:
      containers:
      - name: cozserver
        image: sebcontents/cozserver:2.0
        ports:
        - containerPort: 8080
```

# 2. kubectl get allÂ ëª…ë ¹ì–´ë¥¼ í†µí•´ ì ìš©í•  ë•Œ, ë°°í¬ë˜ëŠ” ê³¼ì •ì„ ê¼­ í™•ì¸

```
$ kubectl get all
NAME                                        READY   STATUS        RESTARTS   AGE
pod/cozserver-deployment-58df6df99f-g7fwh   1/1     Terminating   0          12m
pod/cozserver-deployment-64f6b57986-pw5lq   1/1     Running       0          37s

NAME                        TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE
service/cozserver-service   LoadBalancer   10.96.120.43   <pending>     80:31500/TCP   11m
service/kubernetes          ClusterIP      10.96.0.1      <none>        443/TCP        16h

NAME                                   READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/cozserver-deployment   1/1     1            1           12m

NAME                                              DESIRED   CURRENT   READY   AGE
replicaset.apps/cozserver-deployment-58df6df99f   0         0         0       12m
replicaset.apps/cozserver-deployment-64f6b57986   1         1         1       38s
```

```
$ kubectl rollout history deployment/cozserver-deployment
deployment.apps/cozserver-deployment
REVISION  CHANGE-CAUSE
1         kubectl apply --filename=cozserver-deployment-v1.yaml --record=true
2         kubectl apply --filename=cozserver-deployment-v2.yaml --record=true

$ kubectl get pods
NAME                                    READY   STATUS    RESTARTS   AGE
cozserver-deployment-64f6b57986-pw5lq   1/1     Running   0          4m58s

$ kubectl get rs
NAME                              DESIRED   CURRENT   READY   AGE
cozserver-deployment-58df6df99f   0         0         0       17m
cozserver-deployment-64f6b57986   1         1         1       5m15s

$ kubectl describe deployments
Name:                   cozserver-deployment
Namespace:              default
CreationTimestamp:      Fri, 19 May 2023 11:25:12 +0900
Labels:                 app=cozserver
Annotations:            deployment.kubernetes.io/revision: 2
                        kubernetes.io/change-cause: kubectl apply --filename=cozserver-deployment-v2.yaml --record=true
Selector:               app=cozserver
Replicas:               1 desired | 1 updated | 1 total | 1 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:  app=cozserver
  Containers:
   cozserver:
    Image:        sebcontents/cozserver:2.0
    Port:         8080/TCP
    Host Port:    0/TCP
    Environment:  <none>
    Mounts:       <none>
  Volumes:        <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  <none>
NewReplicaSet:   cozserver-deployment-64f6b57986 (1/1 replicas created)
Events:
  Type    Reason             Age    From                   Message
  ----    ------             ----   ----                   -------
  Normal  ScalingReplicaSet  17m    deployment-controller  Scaled up replica set cozserver-deployment-58df6df99f to 1
  Normal  ScalingReplicaSet  5m32s  deployment-controller  Scaled up replica set cozserver-deployment-64f6b57986 to 1
  Normal  ScalingReplicaSet  5m24s  deployment-controller  Scaled down replica set cozserver-deployment-58df6df99f to 0 from 1
```

ë ˆí”Œë¦¬ì¹´ì…‹ì˜ ë³€í™” ê³¼ì •

- 

DESIRED, CURRENT, READYì˜ ì˜ë¯¸

- 

# 3. http://localhostë¡œ ì ‘ì†í•´ë³´ê¸°

![https://blog.kakaocdn.net/dn/oYs2f/btsgCpCrF6I/GdBkl3eABAu2iUKSbMQYd0/img.png](https://blog.kakaocdn.net/dn/oYs2f/btsgCpCrF6I/GdBkl3eABAu2iUKSbMQYd0/img.png)

# **âœï¸**Â STEP 5: 3.0 ë°°í¬ì™€ 2.0ìœ¼ë¡œì˜ ë¡¤ë°±

# 1. sebcontents/cozserver:3.0 ì´ë¯¸ì§€ë¥¼ ë°”íƒ•ìœ¼ë¡œ cozserver-deployment-v3.yamlì— íŒŒë“œ ë””í”Œë¡œì´ë¨¼íŠ¸ ëª…ì„¸ ì‘ì„±

```
# cozserver-deployment-v3.yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  name: cozserver-deployment
  labels:
    app: cozserver
spec:
  replicas: 1
  strategy: # ë°°í¬ ì „ëµ ì„¤ì •
    type: RollingUpdate
  selector:
    matchLabels:
      app: cozserver
  template:
    metadata:
      labels:
        app: cozserver
    spec:
      containers:
      - name: cozserver
        image: sebcontents/cozserver:3.0
        ports:
        - containerPort: 8080
```

# 2. http://localhost ë¡œ ì ‘ì†í•´ë³´ê¸°

![https://blog.kakaocdn.net/dn/JJNnI/btsgBfgIyWW/alWi3QxGyoyUSDKsoaijA1/img.png](https://blog.kakaocdn.net/dn/JJNnI/btsgBfgIyWW/alWi3QxGyoyUSDKsoaijA1/img.png)

![https://blog.kakaocdn.net/dn/bS5lyw/btsgBALBDDm/4k9DdX6XXMdxueEWKG25bk/img.png](https://blog.kakaocdn.net/dn/bS5lyw/btsgBALBDDm/4k9DdX6XXMdxueEWKG25bk/img.png)

# 3. cozserver-deployment-v3.yamlì— íŒŒë“œ ë””í”Œë¡œì´ë¨¼íŠ¸ ëª…ì„¸ ì‘ì„±

```
# ë¡¤ì•„ì›ƒ ìƒíƒœ í™•ì¸
$ kubectl rollout status deployment/cozserver-deployment
deployment "cozserver-deployment" successfully rolled out

# ë¡¤ì•„ì›ƒ ë‚´ì—­ í™•ì¸
$ kubectl rollout history deployment cozserver-deployment
deployment.apps/cozserver-deployment
REVISION  CHANGE-CAUSE
1         kubectl apply --filename=cozserver-deployment-v1.yaml --record=true
2         kubectl apply --filename=cozserver-deployment-v2.yaml --record=true
3         kubectl apply --filename=cozserver-deployment-v3.yaml --record=true
```

# 4. kubectl rollout undo ëª…ë ¹ì–´ë¡œ ì´ì „ ë²„ì „ ë¡¤ë°±í•˜ê¸°

```
$ kubectl rollout undo deployment/cozserver-deployment
deployment.apps/cozserver-deployment rolled back

$ kubectl describe deployments
Name:                   cozserver-deployment
Namespace:              default
CreationTimestamp:      Fri, 19 May 2023 11:25:12 +0900
Labels:                 app=cozserver
Annotations:            deployment.kubernetes.io/revision: 4 #revision ë²„ì „
                        kubernetes.io/change-cause: kubectl apply --filename=cozserver-deployment-v2.yaml --record=true
Selector:               app=cozserver
Replicas:               1 desired | 1 updated | 1 total | 1 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:  app=cozserver
  Containers:
   cozserver:
    Image:        sebcontents/cozserver:2.0
    Port:         8080/TCP
    Host Port:    0/TCP
    Environment:  <none>
    Mounts:       <none>
  Volumes:        <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  <none>
NewReplicaSet:   cozserver-deployment-64f6b57986 (1/1 replicas created)
Events:
  Type    Reason             Age    From                   Message
  ----    ------             ----   ----                   -------
  Normal  ScalingReplicaSet  37m    deployment-controller  Scaled up replica set cozserver-deployment-58df6df99f to 1
  Normal  ScalingReplicaSet  25m    deployment-controller  Scaled up replica set cozserver-deployment-64f6b57986 to 1
  Normal  ScalingReplicaSet  25m    deployment-controller  Scaled down replica set cozserver-deployment-58df6df99f to 0 from 1
  Normal  ScalingReplicaSet  5m     deployment-controller  Scaled up replica set cozserver-deployment-69bf859597 to 1
  Normal  ScalingReplicaSet  4m53s  deployment-controller  Scaled down replica set cozserver-deployment-64f6b57986 to 0 from 1
  Normal  ScalingReplicaSet  30s    deployment-controller  Scaled up replica set cozserver-deployment-64f6b57986 to 1 from 0
  Normal  ScalingReplicaSet  29s    deployment-controller  Scaled down replica set cozserver-deployment-69bf859597 to 0 from 1
$ kubectl get deployments
NAME                   READY   UP-TO-DATE   AVAILABLE   AGE
cozserver-deployment   1/1     1            1           38m
```

# 5. ë¡¤ë°±ì´ ì˜ ë˜ì—ˆëŠ”ì§€ í™•ì¸

```
$ kubectl rollout history deployment cozserver-deployment
deployment.apps/cozserver-deployment
REVISION  CHANGE-CAUSE
1         kubectl apply --filename=cozserver-deployment-v1.yaml --record=true
2         kubectl apply --filename=cozserver-deployment-v2.yaml --record=true
3         kubectl apply --filename=cozserver-deployment-v3.yaml --record=true

$ kubectl rollout undo deployment/cozserver-deployment
deployment.apps/cozserver-deployment rolled back

$ kubectl rollout history deployment cozserver-deployment
deployment.apps/cozserver-deployment
REVISION  CHANGE-CAUSE
1         kubectl apply --filename=cozserver-deployment-v1.yaml --record=true
3         kubectl apply --filename=cozserver-deployment-v3.yaml --record=true
4         kubectl apply --filename=cozserver-deployment-v2.yaml --record=true
```

# #REFERENCES

[https://kubernetes.io/docs/concepts/workloads/controllers/deployment/](https://kubernetes.io/docs/concepts/workloads/controllers/deployment/)



[https://kubernetes.io/ko/docs/concepts/workloads/controllers/deployment/](https://kubernetes.io/ko/docs/concepts/workloads/controllers/deployment/)



[https://kubernetes.io/ko/docs/concepts/services-networking/service/](https://kubernetes.io/ko/docs/concepts/services-networking/service/)



[https://kubernetes.io/ko/docs/concepts/services-networking/connect-applications-service/](https://kubernetes.io/ko/docs/concepts/services-networking/connect-applications-service/)



[https://honggg0801.tistory.com/45](https://honggg0801.tistory.com/45)



[https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/deployment-v1/](https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/deployment-v1/)



[https://kubernetes.io/ko/docs/concepts/workloads/controllers/deployment/#%EB%94%94%ED%94%8C%EB%A1%9C%EC%9D%B4%EB%A8%BC%ED%8A%B8-%EB%A1%A4%EB%B0%B1](https://kubernetes.io/ko/docs/concepts/workloads/controllers/deployment/#%EB%94%94%ED%94%8C%EB%A1%9C%EC%9D%B4%EB%A8%BC%ED%8A%B8-%EB%A1%A4%EB%B0%B1)



[https://kubernetes.io/ko/docs/concepts/workloads/controllers/deployment/#%EB%94%94%ED%94%8C%EB%A1%9C%EC%9D%B4%EB%A8%BC%ED%8A%B8-%EC%83%81%ED%83%9C](https://kubernetes.io/ko/docs/concepts/workloads/controllers/deployment/#%EB%94%94%ED%94%8C%EB%A1%9C%EC%9D%B4%EB%A8%BC%ED%8A%B8-%EC%83%81%ED%83%9C)



[https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#rollout](https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#rollout)



[https://kubernetes.io/ko/docs/reference/kubectl/cheatsheet/](https://kubernetes.io/ko/docs/reference/kubectl/cheatsheet/)



[https://kubernetes.io/ko/docs/concepts/workloads/controllers/replicaset/](https://kubernetes.io/ko/docs/concepts/workloads/controllers/replicaset/)

