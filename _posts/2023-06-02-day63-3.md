---
date: 2023-06-02 00:00:00
layout: post
title: DevOps&#91;Day63-3#93; / [ì„œë¹„ìŠ¤ ëª¨ë‹ˆí„°ë§]
subtitle: '03. Prometheus + Grafana'
description: 03. Prometheus + Grafana
image: /thumbnail/Monitoring.png
optimized_image: /thumbnail/Monitoring.png
category: ì„œë¹„ìŠ¤ ëª¨ë‹ˆí„°ë§
tags:
  - Monitoring
  - CI/CD
  - ëª¨ë‹ˆí„°ë§
  - Prometheus
  - í”„ë¡œë©”í…Œìš°ìŠ¤ êµ¬ì„± ìš”ì†Œ
  - ì¿ ë²„ë„¤í‹°ìŠ¤ exporter
  - Grafana
  - DevOps BootCamp
author: teddy-woo

---

# **# í•™ìŠµ ëª©í‘œ**

- ì¿ ë²„ë„¤í‹°ìŠ¤Â ëª¨ë‹ˆí„°ë§Â ì‹œìŠ¤í…œì´Â Prometheusì™€Â Grafanaë¥¼Â í†µí•´Â êµ¬í˜„ë¨ì„Â ì´í•´í• Â ìˆ˜Â ìˆë‹¤.

---

# **# í•™ìŠµ ë‚´ìš©**

# 1. PrometheusÂ ëª¨ë‹ˆí„°ë§Â ì‹œìŠ¤í…œ

- ì˜¤í”ˆì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§/ì•Œë¦¼ ì‹œìŠ¤í…œ
- í”„ë¡œë©”í…Œìš°ìŠ¤ëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤, ë…¸ë“œ, í”„ë¡œë©”í…Œìš°ìŠ¤ ìì²´ë¥¼ ëª¨ë‹ˆí„°ë§ ê°€ëŠ¥
- ì¿ ë²„ë„¤í‹°ìŠ¤ë¥¼ ì§€ì›í•˜ê³  ê´€ë¦¬í•˜ëŠ” ì¬ë‹¨ì¸ CNCFì—ì„œ í”„ë¡œë©”í…Œìš°ìŠ¤ ì—­ì‹œ ê´€ë¦¬í•˜ê³  ìˆìœ¼ë©°, ì´ ë‘ ë„êµ¬ë¥¼ ë¹„ë¡¯í•´ ì‹œê°í™”ë¥¼ ë‹´ë‹¹í•˜ëŠ” Grafanaì™€ í•¨ê»˜ ì„¸ ë„êµ¬ ì¡°í•©ì€ ì •ì„ì ìœ¼ë¡œ ë„ë¦¬ ì‚¬ìš©ë˜ê³  ìˆìŒ

# í”„ë¡œë©”í…Œìš°ìŠ¤ êµ¬ì„± ìš”ì†Œ

- í”„ë¡œë©”í…Œìš°ìŠ¤ëŠ” ì‹œê³„ì—´(time series) ë°ì´í„°ë¥¼ ì €ì¥
- í”„ë¡œë©”í…Œìš°ìŠ¤ ì„œë²„ëŠ” ë‹¤ì–‘í•œ exporterë¡œë¶€í„° ê° ëŒ€ìƒì˜ ë©”íŠ¸ë¦­ì„ pullí•˜ì—¬ ì£¼ê¸°ì ìœ¼ë¡œ ê°€ì ¸ì˜¤ëŠ” ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ
    - ì˜ˆë¥¼ ë“¤ì–´, ì¿ ë²„ë„¤í‹°ìŠ¤ ê´€ë ¨ ë©”íŠ¸ë¦­ì„ ê°€ì ¸ì˜¤ê³  ì‹¶ë‹¤ë©´ ì¿ ë²„ë„¤í‹°ìŠ¤ exporterë¥¼, mongoDB ê´€ë ¨ ë©”íŠ¸ë¦­ì„ ê°€ì ¸ì˜¤ê³  ì‹¶ë‹¤ë©´, mongodb exporterë¥¼ ì‚¬ìš©í•˜ë©´ ë¨
- Alert manager: ê²½ê³  ë° ì•ŒëŒì„ ë‹´ë‹¹
- ì‚¬ìš©ìê°€ ë°ì´í„°ë¥¼ ì§ˆì˜í•  ìˆ˜ ìˆëŠ” Web UIê°€ ì¡´ì¬
    - ì´ë•Œ ì§ˆì˜ ì–¸ì–´ë¡œëŠ” PromQL(Prometheus Query Language)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
- GrafanaëŠ” í”„ë¡œë©”í…Œìš°ìŠ¤ì˜ êµ¬ì„±ìš”ì†ŒëŠ” ì•„ë‹ˆì§€ë§Œ í”„ë¡œë©”í…Œìš°ìŠ¤ì—ì„œ ê¶Œì¥í•˜ëŠ” ì‹œê°í™” ë„êµ¬
- 

# ì¿ ë²„ë„¤í‹°ìŠ¤ exporter

- í”„ë¡œë©”í…Œìš°ìŠ¤ì—ì„œ ì¿ ë²„ë„¤í‹°ìŠ¤ ê´€ë ¨ ë©”íŠ¸ë¦­ì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ exporterê°€ ì¡´ì¬í•˜ë©° ì´ë•Œ í”„ë¡œë©”í…Œìš°ìŠ¤ exporterëŠ” Kube APIë¥¼ ì‚¬ìš©
- ëŒ€ë¶€ë¶„ì˜ í•„ìš”í•œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŒ

![](https://blog.kakaocdn.net/dn/dB5i9Z/btsij7oeIHo/i9ht1R6PXu1lTYjpqydjhK/img.png)

ì¶œì²˜ :&nbsp;https://prometheus.io/docs/introduction/overview/

# 2. Prometheus,Â GrafanaÂ ì„¤ì¹˜

# Prometheus Operatorë¥¼ ì´ìš©í•˜ì—¬ ì„¤ì¹˜í•˜ê¸°

- minikubeë¥¼ ì´ìš©í•´ í´ëŸ¬ìŠ¤í„°ë¥¼ ìƒì„±(--nodes ì˜µì…˜ì„ ì´ìš©í•˜ì—¬ ì—¬ëŸ¬ ê°œì˜ ë…¸ë“œë¥¼ ë§Œë“¤ ìˆ˜ ìˆìŒ)

```
$ minikube start --nodes=3
ğŸ˜„  Darwin 10.15.7 ì˜ minikube v1.30.1
âœ¨  ê¸°ì¡´ í”„ë¡œí•„ì— ê¸°ë°˜í•˜ì—¬ docker ë“œë¼ì´ë²„ë¥¼ ì‚¬ìš©í•˜ëŠ” ì¤‘
ğŸ‘  minikube í´ëŸ¬ìŠ¤í„°ì˜ minikube ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ ë…¸ë“œë¥¼ ì‹œì‘í•˜ëŠ” ì¤‘
ğŸšœ  ë² ì´ìŠ¤ ì´ë¯¸ì§€ë¥¼ ë‹¤ìš´ë°›ëŠ” ì¤‘ ...
ğŸ¤·  docker "minikube" container is missing, will recreate.
ğŸ”¥  Creating docker container (CPUs=2, Memory=4000MB) ...
ğŸ³  ì¿ ë²„ë„¤í‹°ìŠ¤ v1.26.3 ì„ Docker 23.0.2 ëŸ°íƒ€ì„ìœ¼ë¡œ ì„¤ì¹˜í•˜ëŠ” ì¤‘
ğŸ”—  Configuring bridge CNI (Container Networking Interface) ...
ğŸ”  Kubernetes êµ¬ì„± ìš”ì†Œë¥¼ í™•ì¸...
ğŸ’¡  After the addon is enabled, please run "minikube tunnel" and your ingress resources would be available at "127.0.0.1"
    â–ª Using image registry.k8s.io/ingress-nginx/controller:v1.7.0
    â–ª Using image registry.k8s.io/ingress-nginx/kube-webhook-certgen:v20230312-helm-chart-4.5.2-28-g66a760794
    â–ª Using image gcr.io/k8s-minikube/storage-provisioner:v5
    â–ª Using image registry.k8s.io/ingress-nginx/kube-webhook-certgen:v20230312-helm-chart-4.5.2-28-g66a760794
ğŸ”  Verifying ingress addon...
ğŸŒŸ  ì• ë“œì˜¨ í™œì„±í™” : storage-provisioner, default-storageclass, ingress
â—  The cluster minikube already exists which means the --nodes parameter will be ignored. Use "minikube node add" to add nodes to an existing cluster.
ğŸ„  ëë‚¬ìŠµë‹ˆë‹¤! kubectlì´ "minikube" í´ëŸ¬ìŠ¤í„°ì™€ "default" ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ê¸°ë³¸ì ìœ¼ë¡œ ì‚¬ìš©í•˜ë„ë¡ êµ¬ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
```

- ì—¬ëŸ¬ ê°œì˜ ë…¸ë“œë¥¼ ë§Œë“¤ ê²½ìš°

> ì²« ë²ˆì§¸ëŠ” master, ë‚˜ë¨¸ì§€ ë‘ ê°œì˜ ë…¸ë“œëŠ” worker ë…¸ë“œë¡œ êµ¬ì„±

> ì—¬ëŸ¬ ê°œì˜ ë…¸ë“œë¥¼ êµ¬ì„±í•  ê²½ìš°, ì›Œì»¤ ë…¸ë“œì—ëŠ” ì‹¤ì œë¡œ ì‹¤í–‰ë˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë°°ì¹˜í•˜ë©°, ë§ˆìŠ¤í„° ë…¸ë“œëŠ” í´ëŸ¬ìŠ¤í„° ê´€ë¦¬ ê·¸ ìì²´ì— ì§‘ì¤‘

> Q. ëª¨ë‹ˆí„°ë§ì˜ ê´€ì ì—ì„œ ì›Œì»¤ ë…¸ë“œì— ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë³„ë„ë¡œ ë°°ì¹˜í•˜ëŠ” ê²ƒì´ ì™œ ìœ ë¦¬í• ê¹Œ?
> 

[Prometheus Operator Quick Start](https://prometheus-operator.dev/docs/prologue/quick-start/)

1. kube-prometheusë¥¼ í´ë¡ 

```
 $ git clone https://github.com/prometheus-operator/kube-prometheus.git
```

2. í•´ë‹¹ ë””ë ‰í† ë¦¬ë¡œ ì´ë™í•˜ì—¬ kube-prometheusë¥¼ ë°°í¬

- Prometheus Operator ê´€ë ¨ ì„œë¹„ìŠ¤ ë° ì›Œí¬ë¡œë“œê°€ ì‹¤í–‰ë˜ê¸° ì „ê¹Œì§€ ê¸°ë‹¤ë¦´ ê²ƒ

```
$ cd kube-prometheus

# manifests/setup ì•ˆì˜ ì›Œí¬ë¡œë“œë¥¼ ì „ë¶€ ì‹¤í–‰
# ë„¤ì„ ìŠ¤í˜ì´ìŠ¤ì™€ customresourcedefinitionë“¤ì„ ìƒì„± ë¦¬ì†ŒìŠ¤ê°€ ìƒì„±ë˜ê¸° ì „ì— ì‚¬ìš©ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
$ kubectl create -f manifests/setup

customresourcedefinition.apiextensions.k8s.io/alertmanagerconfigs.monitoring.coreos.com created
customresourcedefinition.apiextensions.k8s.io/alertmanagers.monitoring.coreos.com created
#... ì¤‘ëµ ...#
customresourcedefinition.apiextensions.k8s.io/thanosrulers.monitoring.coreos.com created
namespace/monitoring created

# "servicemonitors" CRDê°€ ìƒì„±ë  ë•Œ ê¹Œì§€ ê¸°ë‹¤ë¦¼
# "No resources found" ë©”ì‹œì§€ê°€ ë°œìƒí•˜ë©´ ì„±ê³µëœ ê²ƒ
$ until kubectl get servicemonitors --all-namespaces ; do date; sleep 1; echo ""; done

# manifest/ ì•ˆì˜ ì›Œí¬ë¡œë“œë¥¼ ì „ë¶€ ì‹¤í–‰
$ kubectl create -f manifests/
alertmanager.monitoring.coreos.com/main created
networkpolicy.networking.k8s.io/alertmanager-main created
#... ì¤‘ëµ ...#
serviceaccount/prometheus-operator created
servicemonitor.monitoring.coreos.com/prometheus-operator created
```

2. ê´€ë ¨ ì„œë¹„ìŠ¤ë¥¼ ë¡œì»¬í˜¸ìŠ¤íŠ¸ì— í¬íŠ¸ í¬ì›Œë”©ìœ¼ë¡œ ë…¸ì¶œ

1) í”„ë¡œë©”í…Œìš°ìŠ¤ ë…¸ì¶œÂ [: http://localhost:9090](http://localhost:9090/)ë¡œ ì ‘ì†í•´ì„œ í”„ë¡œë©”í…Œìš°ìŠ¤ì— ì ‘ì† ê°€ëŠ¥

```
$ kubectl --namespace monitoring port-forward svc/prometheus-k8s 9090 &
```

![](https://blog.kakaocdn.net/dn/RFXES/btsioobFuYI/14KiHIl1FDqHdKkleCgR01/img.png)

2) ê·¸ë¼íŒŒë‚˜ ë…¸ì¶œ :Â [http://localhost:3000](http://localhost:3000/)ìœ¼ë¡œ ì ‘ì†í•´ì„œ ê·¸ë¼íŒŒë‚˜ì— ì ‘ì† ê°€ëŠ¥

- ì´ˆê¸° ì‚¬ìš©ì ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ëŠ” admin/admin

```
$ kubectl --namespace monitoring port-forward svc/grafana 3000 &
```

![](https://blog.kakaocdn.net/dn/s1Wrc/btsir4cKMDc/2Hq3rhrGyByfkyEZmDRYlk/img.png)

![](https://blog.kakaocdn.net/dn/btr750/btsikVnMSTq/c0R7IB3XmZMpPW3QV6tgvk/img.png)

3) ìƒì„±ëœ ì¿ ë²„ë„¤í‹°ìŠ¤ ë¦¬ì†ŒìŠ¤ í™•ì¸

```bash
$ kubectl get namespace
NAME              STATUS   AGE
default           Active   10d
kube-node-lease   Active   10d
kube-public       Active   10d
kube-system       Active   10d
monitoring        Active   21m

$ kubectl get all --namespace="monitoring" 
NAME                                       READY   STATUS    RESTARTS   AGE
pod/alertmanager-main-0                    2/2     Running   0          15m
pod/alertmanager-main-1                    2/2     Running   0          15m
pod/alertmanager-main-2                    2/2     Running   0          15m
pod/blackbox-exporter-6bc47b9578-hw2db     3/3     Running   0          16m
pod/grafana-57f885b6c8-q4cz7               1/1     Running   0          16m
pod/kube-state-metrics-f76ffbf8b-zv7ls     3/3     Running   0          16m
pod/node-exporter-9sq7l                    2/2     Running   0          16m
pod/prometheus-adapter-6b88dfd544-nvw8f    1/1     Running   0          16m
pod/prometheus-adapter-6b88dfd544-z4wjm    1/1     Running   0          16m
pod/prometheus-k8s-0                       2/2     Running   0          15m
pod/prometheus-k8s-1                       2/2     Running   0          15m
pod/prometheus-operator-58899ccbf4-lc8dp   2/2     Running   0          16m

NAME                            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE
service/alertmanager-main       ClusterIP   10.111.201.192   <none>        9093/TCP,8080/TCP            16m
service/alertmanager-operated   ClusterIP   None             <none>        9093/TCP,9094/TCP,9094/UDP   15m
service/blackbox-exporter       ClusterIP   10.111.198.84    <none>        9115/TCP,19115/TCP           16m
service/grafana                 ClusterIP   10.108.176.133   <none>        3000/TCP                     16m
service/kube-state-metrics      ClusterIP   None             <none>        8443/TCP,9443/TCP            16m
service/node-exporter           ClusterIP   None             <none>        9100/TCP                     16m
service/prometheus-adapter      ClusterIP   10.104.131.70    <none>        443/TCP                      16m
service/prometheus-k8s          ClusterIP   10.105.29.195    <none>        9090/TCP,8080/TCP            16m
service/prometheus-operated     ClusterIP   None             <none>        9090/TCP                     15m
service/prometheus-operator     ClusterIP   None             <none>        8443/TCP                     16m

NAME                           DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE
daemonset.apps/node-exporter   1         1         1       1            1           kubernetes.io/os=linux   16m

NAME                                  READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/blackbox-exporter     1/1     1            1           16m
deployment.apps/grafana               1/1     1            1           16m
deployment.apps/kube-state-metrics    1/1     1            1           16m
deployment.apps/prometheus-adapter    2/2     2            2           16m
deployment.apps/prometheus-operator   1/1     1            1           16m

NAME                                             DESIRED   CURRENT   READY   AGE
replicaset.apps/blackbox-exporter-6bc47b9578     1         1         1       16m
replicaset.apps/grafana-57f885b6c8               1         1         1       16m
replicaset.apps/kube-state-metrics-f76ffbf8b     1         1         1       16m
replicaset.apps/prometheus-adapter-6b88dfd544    2         2         2       16m
replicaset.apps/prometheus-operator-58899ccbf4   1         1         1       16m

NAME                                 READY   AGE
statefulset.apps/alertmanager-main   3/3     15m
statefulset.apps/prometheus-k8s      2/2     15m
```