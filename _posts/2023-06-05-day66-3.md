---
date: 2023-06-05 00:00:00
layout: post
title: DevOps&#91;ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ êµ¬ì¶•&#93; / [Sprint]
subtitle: 'ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ êµ¬ì¶•'
description: ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ êµ¬ì¶•
image: /thumbnail/Monitoring.png
optimized_image: /thumbnail/Monitoring.png
category: Sprint
tags:
  - Prometheus
  - Operator
  - CloudWatch
  - nginx
  - ingress
  - Grafan
  - helm
  - DevOps BootCamp
author: teddy-woo

---

# #í•´ê²° ê³¼ì œ

ğŸ’¡ Prometheus Operatorê°€ ì„¤ì¹˜ëœ í™˜ê²½ì—ì„œÂ [nginx ì¸ê·¸ë ˆìŠ¤ ì»¨íŠ¸ë¡¤ëŸ¬](https://artifacthub.io/packages/helm/ingress-nginx/ingress-nginx)ë¥¼ ì„¤ì¹˜

ğŸ’¡Â [cozserver (v2)](https://github.com/cs-devops-bootcamp/sprint-k8s-rollout-reference)ì˜ ë””í”Œë¡œì´ë¨¼íŠ¸ ë° ì„œë¹„ìŠ¤ë¥¼ ë°°í¬í•˜ê³ , ì¸ê·¸ë ˆìŠ¤ë¥¼ ë§Œë“¤ì–´ì„œ nginxë¥¼ í†µí•´ ì„œë¹„ìŠ¤ì— ì ‘ê·¼í•˜ë„ë¡ ì„¤ì •

ğŸ’¡ Prometheusì—ì„œ ì¿¼ë¦¬ë¥¼ í†µí•´ ì£¼ìš” ë©”íŠ¸ë¦­ì„ í™•ì¸

ğŸ’¡ Grafanaì— ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ëŒ€ì‹œë³´ë“œë“¤ì„ ì‚´í´ë³´ê³ , ì–´ë–¤ ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•˜ëŠ”ì§€ í™•ì¸

# #ê³¼ì œ í•­ëª©ë³„ ì§„í–‰ ìƒí™©

# **âœï¸Â helmì„ ì´ìš©í•´ nginx ì¸ê·¸ë ˆìŠ¤ ì»¨íŠ¸ë¡¤ëŸ¬ ì„¤ì¹˜**

- nginx ì¸ê·¸ë ˆìŠ¤ ì»¨íŠ¸ë¡¤ëŸ¬ê°€ í”„ë¡œë©”í…Œìš°ìŠ¤ìš© ë©”íŠ¸ë¦­ì„ ë…¸ì¶œí•  ìˆ˜ ìˆë„ë¡ í™˜ê²½ ì„¤ì • (ì°¸ê³  ë ˆí¼ëŸ°ìŠ¤ :Â [ë ˆí¼ëŸ°ìŠ¤](https://artifacthub.io/packages/helm/ingress-nginx/ingress-nginx#prometheus-metrics),Â [ë ˆí¼ëŸ°ìŠ¤2)](https://kubernetes.github.io/ingress-nginx/user-guide/monitoring/#re-configure-nginx-ingress-controller)

# Step 1 : helm íŒ¨í‚¤ì§€ ë§¤ë‹ˆì €ë¡œ nginx ingress controller ì„¤ì¹˜

```
# nginx controllerë¥¼ helm repoë¥¼ ì´ìš©í•´ ë‹¤ìš´ë¡œë“œ
$ helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
$ helm repo update

# í”„ë¡œë©”í…Œìš°ìŠ¤ ë©”íŠ¸ë¦­ìŠ¤ ë…¸ì¶œ ì„¤ì • í›„ nginx ì„¤ì¹˜
$ helm install ingress-nginx ingress-nginx/ingress-nginx \
--set controller.metrics.enabled=true \
--set controller.metrics.serviceMonitor.enabled=true
NAME: ingress-nginx
LAST DEPLOYED: Fri Jun  2 17:21:12 2023
NAMESPACE: default
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
The ingress-nginx controller has been installed.
It may take a few minutes for the LoadBalancer IP to be available.
You can watch the status by running 'kubectl --namespace default get services -o wide -w ingress-nginx-controller'

An example Ingress that makes use of the controller:
  apiVersion: networking.k8s.io/v1
  kind: Ingress
  metadata:
    name: example
    namespace: foo
  spec:
    ingressClassName: nginx
    rules:
      - host: www.example.com
        http:
          paths:
            - pathType: Prefix
              backend:
                service:
                  name: exampleService
                  port:
                    number: 80
              path: /
    # This section is only required if TLS is to be enabled for the Ingress
    tls:
      - hosts:
        - www.example.com
        secretName: example-tls

If TLS is enabled for the Ingress, a Secret containing the certificate and key must also be provided:

  apiVersion: v1
  kind: Secret
  metadata:
    name: example-tls
    namespace: foo
  data:
    tls.crt: <base64 encoded cert>
    tls.key: <base64 encoded key>
  type: kubernetes.io/tls
```

# Step 2 : í”„ë¡œë©”í…Œìš°ìŠ¤ ì›¹ UI (http://localhost:9090)ì—ì„œ ingress-nginx-controllerê°€ Targetìœ¼ë¡œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸

- ì‚¬ì „ì— kubectl ëª…ë ¹ì–´ë¥¼ í†µí•´ port-forward í•„ìš”

```
# í”„ë¡œë©”í…Œìš°ìŠ¤ ë…¸ì¶œ
$ kubectl --namespace monitoring port-forward svc/prometheus-k8s 9090

# ê·¸ë¼íŒŒë‚˜ ë…¸ì¶œ
$ kubectl --namespace monitoring port-forward svc/grafana 3000
```

![](https://blog.kakaocdn.net/dn/cb3M89/btsiNcu22Uj/7FAPlv5MKxBg5nHtIKyVN0/img.png)

# **âœï¸**Â [ì¸ê·¸ë ˆìŠ¤](https://kubernetes.io/ko/docs/concepts/services-networking/ingress/)Â ìƒì„±

# Step 0 : ì•„í‚¤í…ì²˜

![](https://blog.kakaocdn.net/dn/8Lv3E/btsis0g2rTS/cNV6KrX75D6oSCftBmuOpk/img.png)

ì¶œì²˜ : ì½”ë“œìŠ¤í…Œì´ì¸  ë°ë¸Œì˜µìŠ¤ ë¶€íŠ¸ìº í”„ ê³¼ì •

# Step 1 : ë””í”Œë¡œì´ë¨¼íŠ¸, ì„œë¹„ìŠ¤ ë°°í¬ í›„ ingress ìƒì„±

(1) ë””í”Œë¡œì´ë¨¼íŠ¸, ì„œë¹„ìŠ¤, ì¸ê·¸ë ˆìŠ¤ yaml íŒŒì¼ ì‘ì„±

```
# deployment.yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  name: cozserver
  namespace: default
  labels:
    app: cozserver
spec:
  selector:
    matchLabels:
      app: cozserver
  replicas: 3
  minReadySeconds: 10
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: cozserver
    spec:
      containers:
      - name:  nodejs
        image:  sebcontents/cozserver:2.0
```

```
# service.yaml

apiVersion: v1
kind: Service
metadata:
  name: cozserver
  namespace: default
spec:
  selector:
    app: cozserver
  type: ClusterIP # NOT LoadBalancer
  ports:
  - name: cozserver
    protocol: TCP
    port: 8055
    targetPort: 8080
```

```
# ingress.yaml

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: cozserver
  annotations:
    kubernetes.io/ingress.class: "nginx" # ingress classë¥¼ ëª…ì‹œí•´ì£¼ì–´ì•¼ í•¨
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  rules:
  - host: localhost # nginx ingress controllerì—ì„œ ì¸ê·¸ë ˆìŠ¤ ë¦¬ì†ŒìŠ¤ë¥¼ ì •ì˜í•  ë•Œ ì´ hostí•„ë“œëŠ” í•„ìˆ˜
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: cozserver
            port:
              number: 8055
```

(2) Â ë””í”Œë¡œì´ë¨¼íŠ¸, ì„œë¹„ìŠ¤, ì¸ê·¸ë ˆìŠ¤ ë°°í¬

```
# ë””í”Œë¡œì´ë¨¼íŠ¸ ë°°í¬
$ kubectl apply -f cozserver-deployment-v2.yaml --record
deployment.apps/cozserver created

# ì„œë¹„ìŠ¤ ë°°í¬
$ kubectl apply -f cozserver-service.yaml
service/cozserver created

# ì¸ê·¸ë ˆìŠ¤ ë°°í¬
$ kubectl apply -f cozserver-ingress.yaml
ingress.networking.k8s.io/cozserver created
```

# Step 2 : í¬íŠ¸í¬ì›Œë”©ì„ í†µí•´ í˜¸ìŠ¤íŠ¸ PCì—ì„œ ì¸ê·¸ë ˆìŠ¤ì— ì ‘ê·¼ í—ˆìš©

```
$ sudo kubectl port-forward service/ingress-nginx-controller 80 &
```

# Step 3 : í•´ë‹¹ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ í´ëŸ¬ìŠ¤í„°ì— ì‹¤í–‰ëœ ë””í”Œë¡œì´ë¨¼íŠ¸, ì„œë¹„ìŠ¤, ì¸ê·¸ë ˆìŠ¤ í™•ì¸

```
$ kubectl get all,ingresses --namespace="default"
NAME                                           READY   STATUS    RESTARTS   AGE
pod/cozserver-7dcc7c99b7-ffpc9                 1/1     Running   0          18m
pod/cozserver-7dcc7c99b7-l9622                 1/1     Running   0          18m
pod/cozserver-7dcc7c99b7-sbwwx                 1/1     Running   0          18m
pod/ingress-nginx-controller-5988bbb6b-r2v56   1/1     Running   0          22m

NAME                                         TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE
service/cozserver                            ClusterIP      10.105.185.120   <none>        8055/TCP                     17m
service/ingress-nginx-controller             LoadBalancer   10.100.241.249   <pending>     80:32213/TCP,443:31440/TCP   22m
service/ingress-nginx-controller-admission   ClusterIP      10.101.10.117    <none>        443/TCP                      22m
service/ingress-nginx-controller-metrics     ClusterIP      10.96.128.235    <none>        10254/TCP                    22m
service/kubernetes                           ClusterIP      10.96.0.1        <none>        443/TCP                      32m

NAME                                       READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/cozserver                  3/3     3            3           18m
deployment.apps/ingress-nginx-controller   1/1     1            1           22m

NAME                                                 DESIRED   CURRENT   READY   AGE
replicaset.apps/cozserver-7dcc7c99b7                 3         3         3       18m
replicaset.apps/ingress-nginx-controller-5988bbb6b   1         1         1       22m

NAME                                  CLASS    HOSTS       ADDRESS   PORTS   AGE
ingress.networking.k8s.io/cozserver   <none>   localhost             80      10m
  sprint-k8s-rollout-reference $ git:(reference) $ Handling connection for 80
```

# **âœï¸**Â ì¸ê·¸ë ˆìŠ¤ ì ‘ì† ë¡œê·¸ê°€ ì°íˆëŠ”ì§€ í”„ë¡œë©”í…Œìš°ìŠ¤ë¥¼ í†µí•´ í™•ì¸

# Step 1 : http://localhostë¡œ ì ‘ì†í•´ ì¸ê·¸ë ˆìŠ¤ë¥¼ í†µí•´ cozserverì— ì ‘ì†

![](https://blog.kakaocdn.net/dn/1pmtH/btsiOjm4m4G/3hNR5fWJfPbIN9fVqNVmxK/img.png)

# Step 2 : í”„ë¡œë©”í…Œìš°ìŠ¤ ì›¹ UI Graph ì—ì„œ ê°ì¢… ì¿¼ë¦¬ ìˆ˜í–‰ (SREì˜ ë„¤ ê°€ì§€ì˜ í™©ê¸ˆ ì‹œê·¸ë„ì„ ë³´ê¸° ìœ„í•´ í•„ìš”í•œ ë©”íŠ¸ë¦­ ì¡°íšŒ)

(1) nginx_ingress_controller_requests : íŠ¸ë˜í”½, ì˜¤ë¥˜ í™•ì¸

![](https://blog.kakaocdn.net/dn/biXjqI/btsivPnKlg6/GUlKMmk1guLOU7PzJYSm40/img.png)

ìš°ì¸¡ 10ì€ ì ‘ì† íšŸìˆ˜ë¥¼ ì˜ë¯¸

(2) nginx_ingress_controller_request_duration_seconds_count : ëŒ€ê¸° ì‹œê°„

![](https://blog.kakaocdn.net/dn/P4VO2/btsiJz5bF5R/4DN3mYK49KTTa2KzD9hhi0/img.png)

(3) nginx_ingress_controller_request_duration_seconds_bucket : ëŒ€ê¸° ì‹œê°„

![](https://blog.kakaocdn.net/dn/bNiprE/btsitZ4Omru/RBBn7ajYCV9PcH8bMG67Dk/img.png)

(4) node_cpu_seconds_total : í¬í™” ìˆ˜ì¤€

![](https://blog.kakaocdn.net/dn/cNxOH7/btsiu0PEV8I/GQyVfrRe7kbBhksluWSuEk/img.png)

# Step 3 : í”„ë¡œë©”í…Œìš°ìŠ¤ê°€ ì§€ì›í•˜ëŠ” PromQLì„ í†µí•´ ë‹¤ìŒê³¼ ê°™ì´ ë³µì¡í•œ ì§€í‘œë¥¼ í‘œí˜„ ê°€ëŠ¥

(1) 1ì‹œê°„ ë™ì•ˆ ì¸ê·¸ë ˆìŠ¤ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ í†µí•´ ë“¤ì–´ì˜¨ ìš”ì²­ì˜ ëˆ„ì  ë¹„ìœ¨

```
sum(rate(
  nginx_ingress_controller_requests[1h]
))
by (ingress)
```

![](https://blog.kakaocdn.net/dn/X3GUA/btsiFCtnQKo/WJgmAIjhKr8jRTrKhNzycK/img.png)

(2) 1ì‹œê°„ ë™ì•ˆ ëª¨ë“  ìš”ì²­ ì¤‘ 400ë²ˆëŒ€ ì—ëŸ¬ì˜ ë¹„ìœ¨

```
sum(rate(
  nginx_ingress_controller_requests{
    status=~"4.."
  }[1h]
))
by (ingress) /
sum(rate(
  nginx_ingress_controller_requests[1h]
))
by (ingress)
```

![](https://blog.kakaocdn.net/dn/zxJ3P/btsiuAXXGyz/ZnXK73TCSX7J1RUTC4Mij0/img.png)

# **âœï¸**Â Grafanaì˜ ëŒ€ì‹œë³´ë“œ ì‚´í´ë³´ê¸°

# Step 1 : grafanaì˜ ëŒ€ì‹œë³´ë“œì—ì„œ ì¿¼ë¦¬ ìˆ˜í–‰

![](https://blog.kakaocdn.net/dn/tPecE/btsiBJUKxZ0/N5VaKx6cpgpY3GNpMWZ0sk/img.png)

# Step 2 : ì»¤ë®¤ë‹ˆí‹°ì—ì„œ ë§Œë“¤ì–´ë†“ì€ ëŒ€ì‹œë³´ë“œë¥¼ Import í•´ë³´ê¸°

(0) grafana dash ë³´ë“œ importí•˜ëŠ” ë°©ë²•

- ëŒ€ì‹œë³´ë“œì—ì„œ new > import

![](https://blog.kakaocdn.net/dn/Ls3ku/btsiOItuhjD/Eo6Whkny3EnPQvd1Htqe00/img.png)

- json íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê±°ë‚˜, grafana.comì˜ dashboard idë¥¼ ì…ë ¥í•˜ê±°ë‚˜, ì§ì ‘ jsonì„ ì…ë ¥í•´ dashboard ë¡œë“œ

![](https://blog.kakaocdn.net/dn/dBxO3s/btsiOkffDVA/6KHF6VMtbkBMESwb8cIHDk/img.png)

- data sourceë¡œ í”„ë¡œë©”í…Œìš°ìŠ¤ë¥¼ ì„ íƒ í›„ import

![](https://blog.kakaocdn.net/dn/Xaofs/btsizdomWeW/BokvaLfaZHqYikkDJJrphk/img.png)

[(1) NGINX Ingress controller](https://grafana.com/grafana/dashboards/9614)

![](https://blog.kakaocdn.net/dn/k5Iv6/btsiNcolfCj/MiEba4d0RryVt7gkpcYMzk/img.png)

[(2) ì¿ ë²„ë„¤í‹°ìŠ¤ ì˜¬ì¸ì› ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ](https://grafana.com/grafana/dashboards/13770)

![](https://blog.kakaocdn.net/dn/cD7QXF/btsiM9ynLqV/VQbkvf5K85EqWcGtckovkk/img.png)

# #TROUBLE SHOOTING LOG

# ğŸ“ ë¬¸ì œ 1 : nginx 404 not found

- ì›ì¸ : ingress class nameì„ ëª…ì‹œì ìœ¼ë¡œ ì§€ì •í•´ì£¼ì§€ ì•Šì•„ ë°œìƒí•œ ë¬¸ì œ
- í•´ê²° ë°©ì•ˆ : ingress.yaml íŒŒì¼ì— ingress-controller podì˜ class nameê³¼ ë™ì¼í•œ ingress class nameì„ ëª…ì‹œ

```
$ kubectl describe pod ingress-nginx-controller-5988bbb6b-r2v56

Name:             ingress-nginx-controller-5988bbb6b-r2v56
Namespace:        default
# ... ì¤‘ëµ ... #
Containers:
  controller:
    Container ID:  docker://bb3d562c924cb3b9570cb7de4dd1fd6d401d2e1ea3ac53b3c6c3a71ac40beb1c
    Image:         registry.k8s.io/ingress-nginx/controller:v1.8.0@sha256:744ae2afd433a395eeb13dc03d3313facba92e96ad71d9feaafc85925493fee3
    Image ID:      docker-pullable://registry.k8s.io/ingress-nginx/controller@sha256:744ae2afd433a395eeb13dc03d3313facba92e96ad71d9feaafc85925493fee3
    Ports:         80/TCP, 443/TCP, 10254/TCP, 8443/TCP
    Host Ports:    0/TCP, 0/TCP, 0/TCP, 0/TCP
    Args:
      /nginx-ingress-controller
      --publish-service=$(POD_NAMESPACE)/ingress-nginx-controller
      --election-id=ingress-nginx-leader
      --controller-class=k8s.io/ingress-nginx
      --ingress-class=nginx # ingress-classëª…
      --configmap=$(POD_NAMESPACE)/ingress-nginx-controller
      --validating-webhook=:8443
      --validating-webhook-certificate=/usr/local/certificates/cert
      --validating-webhook-key=/usr/local/certificates/key
# ... í•˜ëµ ... #
```

```
# ingress.yaml

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: cozserver
  annotations:
    kubernetes.io/ingress.class: "nginx" # ingress classë¥¼ ëª…ì‹œ
# ... í•˜ëµ ...#
```

- ì°¸ê³ 
    - ì¿ ë²„ë„¤í‹°ìŠ¤ 1.18ì— IngressClass ë¦¬ì†ŒìŠ¤ ë° ingressClassName í•„ë“œê°€ ì¶”ê°€ë˜ê¸° ì „ì— ì¸ê·¸ë ˆìŠ¤ í´ë˜ìŠ¤ëŠ” ì¸ê·¸ë ˆìŠ¤ì—ì„œ kubernetes.io/ingress.class ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ ì§€ì •ë˜ì—ˆìœ¼ë‚˜ ì•ìœ¼ë¡œ ì‚¬ë¼ì§ˆ ì–´ë…¸í…Œì´ì…˜ì„
    - kubernetes.io/ingress.class ì–´ë…¸í…Œì´ì…˜ì€ ì¼ë°˜ì ìœ¼ë¡œ ì¸ê·¸ë ˆìŠ¤ë¥¼ êµ¬í˜„í•´ì•¼ í•˜ëŠ” ì¸ê·¸ë ˆìŠ¤ ì»¨íŠ¸ë¡¤ëŸ¬ì˜ ì´ë¦„ì„ ì°¸ì¡°í•˜ëŠ” ë° ì‚¬ìš©ë¨
    - ì¸ê·¸ë ˆìŠ¤ì˜ ìµœì‹  ingressClassName í•„ë“œëŠ”Â kubernetes.io/ingress.class ì–´ë…¸í…Œì´ì…˜ì„ ëŒ€ì²´í•˜ë‚˜ ì™„ì „ ë™ë“±í•œ ê²ƒì€ ì•„ë‹˜
    - ingressClassName í•„ë“œëŠ” ì¸ê·¸ë ˆìŠ¤ ì»¨íŠ¸ë¡¤ëŸ¬ì˜ ì´ë¦„ì„ í¬í•¨í•˜ëŠ” ì¶”ê°€ ì¸ê·¸ë ˆìŠ¤ êµ¬ì„±ì´ í¬í•¨ëœ ì¸ê·¸ë ˆìŠ¤ í´ë˜ìŠ¤ ë¦¬ì†ŒìŠ¤ë¥¼ ì°¸ì¡°
    - ingressClassNameì„ ìƒëµí•˜ë ¤ë©´, ê¸°ë³¸ ì¸ê·¸ë ˆìŠ¤ í´ë˜ìŠ¤ê°€ ì •ì˜ë˜ì–´ ìˆì–´ì•¼ í•¨(ì¦‰, ê¸°ë³¸ ì¸ê·¸ë ˆìŠ¤ í´ë˜ìŠ¤ê°€ ì •ì˜ë˜ì–´ìˆì§€ ì•Šìœ¼ë©´ ìƒëµ ë¶ˆê°€ëŠ¥)