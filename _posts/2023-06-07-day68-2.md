---
date: 2023-06-07 00:00:00
layout: post
title: DevOps&#91;aws EC2ì™€ K6ë¥¼ ì´ìš©í•œ ì„±ëŠ¥í…ŒìŠ¤íŠ¸&#93; / [Sprint]
subtitle: 'aws EC2ì™€ K6ë¥¼ ì´ìš©í•œ ì„±ëŠ¥í…ŒìŠ¤íŠ¸'
description: aws EC2ì™€ K6ë¥¼ ì´ìš©í•œ ì„±ëŠ¥í…ŒìŠ¤íŠ¸
image: /Monitoring.png
optimized_image: /Monitoring.png
category: Sprint
tags:
  - aws
  - EC2
  - k6
  - ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
  - DevOps BootCamp
author: teddy-woo

---

# #í•™ìŠµ ëª©í‘œ

- k6 ë„êµ¬ í™œìš©ë²•ì„ í•™ìŠµ
- ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ìœ í˜•ë³„ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±
- aws ec2 ì¸ìŠ¤í„´ìŠ¤ë¥¼ ëª¨ë‹ˆí„°ë§
- awsì—ì„œ ì œê³µí•˜ëŠ” ë²„ìŠ¤íŠ¸ í¬ë ˆë”§ì„ ì´í•´

# #ê³¼ì œ í•­ëª©ë³„ ì§„í–‰ ìƒí™©

# **âœï¸Â Â aws ec2 ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì„œë²„ë¥¼ ì»¨í…Œì´ë„ˆë¡œ ë°°í¬**

# Step 1 : EC2 ì¸ìŠ¤í„´ìŠ¤ ìƒì„±

- ë²„ìŠ¤íŠ¸ ê¸°ëŠ¥ì´ ìˆëŠ” t2microë¥¼ ìƒì„±í•˜ê³  ìš´ì˜ì²´ì œëŠ” ubuntu 20.04ë¡œ ì„¤ì •

![](https://blog.kakaocdn.net/dn/bWINkl/btsiJ7uGrNF/kCanYNNOfsRykds8B7Abm0/img.png)

![](https://blog.kakaocdn.net/dn/bFSqEY/btsiOjnMVTe/sxuJhZkJ2mGI3GNJvXLFs0/img.png)

# Step 2 : EC2 ì¸ìŠ¤í„´ìŠ¤ì— SSH ì ‘ì† í›„ ë„ì»¤ ì„¤ì¹˜

1) SSH ì ‘ì†

```
$ ssh -i "****.pem" ubuntu@ec2-**-***-**-**.ap-northeast-2.compute.amazonaws.com
The authenticity of host 'ec2-**-**-**-**.ap-northeast-2.compute.amazonaws.com (**.***.**.**)' can't be established.
ECDSA key fingerprint is SHA256:*
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
```

2)Â [ë„ì»¤ ì„¤ì¹˜](https://docs.docker.com/engine/install/ubuntu/)Â ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰

```
#!/bin/sh

#ì—…ë°ì´íŠ¸ ë° HTTP íŒ¨í‚¤ì§€ ì„¤ì¹˜
sudo apt update -y
sudo apt-get install -y ca-certificates \
    curl \
    software-properties-common \
    apt-transport-https \
    gnupg \
    lsb-release
# GPG í‚¤ ë° ì €ì¥ì†Œ ì¶”ê°€
sudo mkdir -p /etc/apt/keyrings

curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
# ë„ì»¤ì—”ì§„ ì„¤ì¹˜
sudo apt update
sudo apt install docker-ce docker-ce-cli containerd.io
```

# Step 3 : ë„ì»¤ ì»¨í…Œì´ë„ˆ ë°°í¬

1) ë„ì»¤ í—ˆë¸Œì—ì„œ ê°€ì ¸ì˜¨ ì´ë¯¸ì§€ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì»¨í…Œì´ë„ˆ ë°°í¬

```
$ sudo docker run --name <ì„œë²„ëª…> -d -p 8080:8080 sebcontents/cozserver:1.0
```

2) ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆëŠ”ì§€ í™•ì¸

```
$ curl http://localhost:8080

    <h1>CozServerì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</h1>
    <div>ë²„ì „: v1.0</div>
    <div>íŒŒë“œ ì´ë¦„: 343ecf8c14d6</div>
    <div>::ffff:172.17.0.1ì—ì„œ ì˜¤ì…¨êµ°ìš”!</div>
```

# **âœï¸Â [k6 ì„¤ì¹˜](https://snapcraft.io/install/k6/ubuntu)**

# Step 1 : snapdë¥¼ ì´ìš©í•´ k6 ì„¤ì¹˜

```
$ sudo apt update
$ sudo apt install snapd

$ sudo snap install k6
Download snap "k6" (29) from channel "stable"                                                                                                                                         |
k6 v0.43.1 from Thomas Bille (tbmb) installed
```

# Step 2 :Â [ë‹¤ì–‘í•œ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸](https://github.com/cs-devops-bootcamp/sprint_k6_test)Â ì‹¤í–‰

```
# ë¡œì»¬ì— ìˆëŠ” ìŠ¤í¬ë¦½íŠ¸ë¥¼ EC2 ì¸ìŠ¤í„´ìŠ¤ë¡œ ì—…ë¡œë“œ
# scp -i "í‚¤í˜ì–´ ê²½ë¡œ ì£¼ì†Œ" [-r ì˜µì…˜, ë””ë ‰í„°ë¦¬] <íŒŒì¼/ë””ë ‰í„°ë¦¬ëª…> <EC2 ì¸ìŠ¤í„´ìŠ¤ í¼ë¸”ë¦­ ì£¼ì†Œ>[-r ì˜µì…˜ ì‚¬ìš©ì‹œ, :/home/ubuntu ë“± ë””ë ‰í„°ë¦¬ ëª…ì‹œ]

# ec2 ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ë¡œì»¬ë¡œ ë‹¤ìš´ë¡œë“œ ë°›ì„ ê²½ìš°, íŒŒì¼/ë””ë ‰í† ë¦¬ ìœ„ì¹˜ë¥¼ ë°˜ëŒ€ë¡œ ì…ë ¥í•˜ë©´ ë¨
$ scp -i "***.pem" -r ./k6_practice ubuntu@ec2-**-***-**-***.ap-northeast-2.compute.amazonaws.com:/home/ubuntu
```

# **âœï¸Â Â k6ë¥¼ ì´ìš©í•´ EC2 ì¸ìŠ¤í„´ìŠ¤ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸**

# Step 0 : ë¶€í•˜(Load) í…ŒìŠ¤íŠ¸ ìœ í˜•

![](https://blog.kakaocdn.net/dn/bOZQdo/btsi2gqrrXE/bB23fNSV8a8vRaQ5fgGMv0/img.png)

ì¶œì²˜ : k6.io/docs

| ìœ í˜• | vus/ì²˜ë¦¬ëŸ‰ | ì§€ì† | ì‚¬ìš© ì‚¬ë¡€ |
| --- | --- | --- | --- |
| smoke | ë‚®ì€ | ë¹ ë¦„(ì´ˆ ë˜ëŠ” ë¶„) | ìƒˆë¡œìš´ ì½”ë“œë‚˜ ë³€ê²½ì´ ìˆì„ ë•Œë§ˆë‹¤.Â ìŠ¤í¬ë¦½íŠ¸, ê¸°ì¤€ ì‹œìŠ¤í…œ ë©”íŠ¸ë¦­ ë° ë³€ê²½ ì‚¬í•­ì˜ í¸ì°¨ë¥¼ í™•ì¸í•©ë‹ˆë‹¤. |
| https://k6.io/docs/test-types/load-testing/ | í‰ê·  ìƒì‚°ëŸ‰ | ì¤‘ê°„ (15-60ë¶„) | ì¢…ì¢… ì‹œìŠ¤í…œì´ í‰ê·  ì‚¬ìš©ìœ¼ë¡œ ì„±ëŠ¥ì„ ìœ ì§€í•˜ëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ |
| https://k6.io/docs/test-types/stress-testing/ | ë†’ìŒ(í‰ê·  ì´ìƒ) | ì¤‘ê°„ (15-60ë¶„) | ì‹œìŠ¤í…œì´ ê´€ë¦¬ ë°©ë²•ì„ í™•ì¸í•˜ê¸° ìœ„í•´ í‰ê·  ì´ìƒì˜ ë¶€í•˜ë¥¼ ë°›ì„ ìˆ˜ ìˆëŠ” ê²½ìš° |
| https://k6.io/docs/test-types/soak-testing/ | í‰ê·  | ê¸º (ì‹œê°„) | ì¥ê¸°ê°„ ì—°ì† ì‚¬ìš© ì‹œ ì²´í¬ ì‹œìŠ¤í…œìœ¼ë¡œ ë³€ê²½ í›„ |
| https://k6.io/docs/test-types/spike-testing/ | ë§¤ìš° ë†’ìŒ | ë¹ ë¦„(ì´ˆì—ì„œ ë¶„) | ë“œë¬¼ê²Œ ì‹œìŠ¤í…œ ìœ„í—˜ì´ ê°‘ìê¸° ëŒì§„í•  ë•Œ |
| breakpoint | ì‰¬ëŠ” ì‹œê°„ê¹Œì§€ ì¦ê°€ | í•„ìš”í•œ ë§Œí¼ | ì‹œìŠ¤í…œì˜ ìƒí•œì„ ì„ ì°¾ê¸° ìœ„í•´ ëª‡ ë²ˆ |

# Step 1 : ê°ê°ì˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•´ ë³´ê³  ec2 ì¸ìŠ¤í„´ìŠ¤ì˜ CPU ì‚¬ìš©ë¥  ëŒ€ì‹œë³´ë“œë¥¼ í™•ì¸

1) basic test ì‹¤í–‰

ë”ë³´ê¸°

2) load test ì‹¤í–‰

- í‰ê·  ë¶€í•˜ í…ŒìŠ¤íŠ¸ëŠ” ì¼ë°˜ì ì¸ ë¶€í•˜ì—ì„œ ì‹œìŠ¤í…œì´ ì–´ë–»ê²Œ ì‘ë™í•˜ëŠ”ì§€ í‰ê°€í•˜ë©°, ì¼ë°˜ì ì¸ ë¶€í•˜ëŠ” í”„ë¡œë•ì…˜ì˜ ì¼ìƒì¼ ìˆ˜ë„ ìˆê³  í‰ê·  ìˆœê°„ì¼ ìˆ˜ë„ ìˆìŒ

ë”ë³´ê¸°

3) stress test ì‹¤í–‰

- ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸ëŠ” ë¶€í•˜ê°€ í‰ì†Œë³´ë‹¤ ë¬´ê±°ìš¸ ë•Œ ì‹œìŠ¤í…œì´ ì–´ë–»ê²Œ ì‘ë™í•˜ëŠ”ì§€ í‰ê°€í•¨
- ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸ì˜ ë¶€í•˜ íŒ¨í„´ì€ í‰ê·  ë¶€í•˜ í…ŒìŠ¤íŠ¸ì™€ ë¹„ìŠ·í•˜ë‚˜, ì£¼ìš” ì°¨ì´ì ì€ ë” ë†’ì€ ë¶€í•˜ë¥¼ ê°€í•œë‹¤ëŠ” ì 

ë”ë³´ê¸°

4) soak test ì‹¤í–‰

- í‰ê·  ë¶€í•˜ í…ŒìŠ¤íŠ¸ì˜ ë˜ë‹¤ë¥¸ ë³€í˜•ìœ¼ë¡œ ì¥ê¸°ê°„ë™í•œ ìˆ˜í–‰í•˜ë©° ì•„ë˜ ì‚¬í•­ì„ ë¶„ì„
- ì¥ê¸°ê°„ì— ê±¸ì¹œ ì‹œìŠ¤í…œ ì„±ëŠ¥ ì €í•˜ ë° ë¦¬ì†ŒìŠ¤ ë‚­ë¹„
- í™•ì¥ëœ ê¸°ê°„ ë™ì•ˆ ì‹œìŠ¤í…œì˜ ê°€ìš©ì„± ë° ì•ˆì •ì„±

ë”ë³´ê¸°

5) spike test ì‹¤í–‰

- ìŠ¤íŒŒì´í¬ í…ŒìŠ¤íŠ¸ëŠ” ì‹œìŠ¤í…œì´ ê°‘ìê¸° ëŒ€ìš©ëŸ‰ì˜ ì‚¬ìš©ëŸ‰ì´ ê¸‰ì¦í•  ë•Œ ì‚´ì•„ë‚¨ê³  ì„±ëŠ¥ì„ ë°œíœ˜í•˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” í…ŒìŠ¤íŠ¸ë¡œ ê°€ì¥ í”í•˜ì§€ ì•Šì€ í…ŒìŠ¤íŠ¸ ì¤‘ í•˜ë‚˜

ë”ë³´ê¸°

# Step 2 : EC2 ëŒ€ì‹œë³´ë“œì—ì„œ aws burst credit(CPU í¬ë ˆë”§ ì‚¬ìš©ëŸ‰(ê°œìˆ˜) )ì™€ CPU í¬ë ˆë”§ ë°¸ëŸ°ìŠ¤(ê°œìˆ˜)ë¥¼ ê´€ì°°

(1) basic test

![](https://blog.kakaocdn.net/dn/bfMlVP/btsi2gcy9kp/JnKvAqXed1W2ypSP8wpvZK/img.png)

(2) load test

![](https://blog.kakaocdn.net/dn/MnrX2/btsiWSX3Szj/p9EgYvAcM1H7HO7TJ4FJJK/img.png)

(3) stress test

![](https://blog.kakaocdn.net/dn/dGXVCF/btsiU4wl1ci/bsbyPdvkYCVmKVgDlF36x1/img.png)

(4) soak test

![](https://blog.kakaocdn.net/dn/lmlrF/btsiX2ffkHR/3Kkv3JUqRhyxpJm47Hywd0/img.png)

(5) spike test

![](https://blog.kakaocdn.net/dn/cLjGFl/btsi2N2BWsO/u2GrCrpqKcyhevkA7oy93k/img.png)

# # TROUBLE SHOOTING LOG

# ğŸ“Â ë¬¸ì œÂ 1Â :Â k6 í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œ stage í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ

# 1. í˜„ìƒ

```
WARN[0000] There were unknown fields in the options exported in the script  error="json: unknown field \"stage\""
```

# 2. ì›ì¸

- ì˜µì…˜ì— stageë¼ëŠ” í•„ë“œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ,Â [k6 options document](https://k6.io/docs/using-k6/k6-options/reference/)ë¥¼ í™•ì¸í•˜ë©´ í•„ë“œëª…ì´ stageê°€ ì•„ë‹Œ stagesì„ì„ ì•Œ ìˆ˜ ìˆìŒ

# 3. í•´ê²° ë°©ì•ˆ

- ìŠ¤í¬ë¦½íŠ¸ì˜ stageë¥¼ stagesë¡œ ë³€ê²½

# ğŸ“ ë¬¸ì œ 2 : k6 í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œ request failed

# 1. í˜„ìƒ

```
WARN[0050] Request Failed                                error="Get \"https://localhost:8080\": http: server gave HTTP response to HTTPS client"
```

# 2. ì›ì¸

- í˜„ì¬ ë¡œì»¬í˜¸ìŠ¤íŠ¸ í¬íŠ¸ëŠ” httpsê°€ ì•„ë‹Œ http í†µì‹ ì„ ìˆ˜í–‰í•˜ë¯€ë¡œ ë°œìƒí•˜ëŠ” ì˜¤ë¥˜

# 3. í•´ê²° ë°©ì•ˆ

- k6 ìŠ¤í¬ë¦½íŠ¸ì˜ ìš”ì²­ ì£¼ì†Œë¥¼ httpë¡œ ë³€ê²½

# ğŸ“ ë¬¸ì œ 3 : k6 í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œ reference error

# 1. í˜„ìƒ

```
ERRO[0008] ReferenceError: check is not defined
running at file:///home/ubuntu/k6_practice/sprint_k6_test/stress_test.js:36:10(12)  executor=ramping-vus scenario=default source=stacktrace
```

# 2. ì›ì¸

- checkì´ ì •ì˜ë˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì—

# 3. í•´ê²° ë°©ì•ˆ

- check ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ checkì„ import í•´ì£¼ì–´ì•¼ í•¨