---
date: 2023-06-07 00:00:00
layout: post
title: DevOps&#91;ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ì„œë¹„ìŠ¤ ëª¨ë‹ˆí„°ë§&#93; / [Sprint]
subtitle: 'aì„±ëŠ¥ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ì„œë¹„ìŠ¤ ëª¨ë‹ˆí„°ë§ (advanced)'
description: ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ì„œë¹„ìŠ¤ ëª¨ë‹ˆí„°ë§ (advanced)
image: /thumbnail/Monitoring.png
optimized_image: /thumbnail/Monitoring.png
category: Sprint
tags:
  - aws
  - EC2
  - k6
  - ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
  - Prometheus
  - Grafana
  - DevOps BootCamp
author: teddy-woo

---

# #í•™ìŠµ ëª©í‘œ

> - Prometheusì™€ GrafanaëŠ” ì˜¤í”ˆì†ŒìŠ¤ë¡œ ì œê³µë˜ëŠ” ëª¨ë‹ˆí„°ë§ ì„œë¹„ìŠ¤ë¡œì„œ ë§ì€ ê°œë°œìë“¤ì—ê²Œ í° ì¸ê¸°ë¥¼ ì–»ê³  ìˆìŒ.
> 
- ê¸°ë³¸ì ì¸ K6 ì„±ëŠ¥í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±
- K6 output ë° output ì„ ìœ„í•œ k6 extentionì„ ì´í•´
- K6 ouputì„ ìœ„í•œ ë„êµ¬ë¡œ í”„ë¡œë©”í…Œìš°ìŠ¤ë¥¼ ì‚¬ìš©í•˜ë©´ì„œ í”„ë¡œë©”í…Œìš°ìŠ¤ë¥¼ ìµí˜
- k6ë¡œë¶€í„° ë‚˜ì˜¨ outputì„ ê·¸ë¼íŒŒë‚˜ë¡œ ì‹œê°í™”

# #ê³¼ì œ í•­ëª©ë³„ ì§„í–‰ ìƒí™©

# **âœï¸Â Â Set up & Preparation**

# Step 1 :Â [k6í™•ì¥ ë¦¬í¬ì§€í† ë¦¬ë¥¼ clone](https://github.com/grafana/xk6-output-prometheus-remote)

```
# ssh ì ‘ì†ìœ¼ë¡œ clone
$ git clone git@github.com:grafana/xk6-output-prometheus-remote.git

# HTTPS ì ‘ì†ìœ¼ë¡œ clone
$ git clone https://github.com/grafana/xk6-output-prometheus-remote.git
```

# Step 2 : ì„±ëŠ¥í…ŒìŠ¤íŠ¸ë¥¼Â ìœ„í•œÂ testsÂ í´ë”ë¥¼Â cloneí•´Â ì˜¨Â í´ë”Â ì•ˆì—Â ìƒì„±

```
$ cd xk6-output-prometheus-remote
$ mkdir tests
```

# Step 3 : tests í´ë” ì•ˆì— k6 ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ basic_k6_test.js íŒŒì¼ì„ ìƒì„±

```jsx
// basic_k6_test.js

import http from 'k6/http';
import { describe } from 'https://jslib.k6.io/expect/0.0.4/index.js';
import { check, sleep } from 'k6';

export default function () {
    describe('Basic k6 test', () => {
        let res = http.get('https://test.k6.io');
        check(res, {
            'is status 200': (r) => r.status === 200
        });
        sleep(1);
    });
}
```

# Step 4 :Â ìƒìœ„ í´ë”ë¡œ ëŒì•„ê°€ Dockerfile í™•ì¸

```yaml
# Multi-stage build to generate custom k6 with extension
FROM golang:1.20-alpine as builder # ë³„ì¹­ì„ builderë¡œ
WORKDIR $GOPATH/src/go.k6.io/k6
COPY . .
RUN apk --no-cache add git=~2 # apk : alpineì˜ íŒ¨í‚¤ì§€ ë§¤ë‹ˆì €
RUN CGO_ENABLED=0 go install go.k6.io/xk6/cmd/xk6@latest  \
    && CGO_ENABLED=0 xk6 build \
    --with github.com/grafana/xk6-output-prometheus-remote=. \
    --output /tmp/k6

# Create image for running k6 with output for Prometheus Remote Write
FROM alpine:3.17

# hadolint ignore=DL3018
RUN apk add --no-cache ca-certificates && \
    adduser -D -u 12345 -g 12345 k6
COPY --from=builder /tmp/k6 /usr/bin/k6

USER 12345
WORKDIR /home/k6

ENTRYPOINT ["k6"]
```

![](https://blog.kakaocdn.net/dn/QzLHe/btsi2Gv6fJc/uoeVUkpdRtlZ3Nu858wwCK/img.png)

- ë„ì»¤ íŒŒì¼ ë‚´ìš© ì°¸ê³  :Â [ë„ì»¤í—ˆë¸Œ,](https://docs.docker.com/engine/reference/builder/)Â [k6 ê³µì‹ì‚¬ì´íŠ¸](https://k6.io/docs/extensions/#xk6-makes-custom-binaries)

# Step 5 :Â docker-compose.yaml íŒŒì¼ ì‘ì„±

```yaml
version: '3.8'
volumes: # ë¡œì»¬ì— ìƒì„±í•  volumes
  prometheus-data:
  grafana-data-storage:

networks:
  k6:
  grafana:
  prometheus:

services:
  prometheus:
    image: prom/prometheus:v2.42.0
    command:
      - --web.enable-remote-write-receiver
      - --enable-feature=native-histograms
      - --config.file=/etc/prometheus/prometheus.yml
      - --enable-feature=remote-write-receiver --config.file=/etc/prometheus/prometheus.yaml
    networks:
      - k6
      - grafana
      - prometheus
    ports:
      - "9090:9090"
    depends_on:
      - grafana
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yaml
      - prometheus-data:/prometheus

  grafana:
    image: grafana/grafana:9.4.7
    networks:
      - grafana
      - prometheus
    ports:
      - "3000:3000"
    environment:
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_BASIC_ENABLED=false
    volumes:
      - ./grafana:/etc/grafana/provisioning/
      - grafana-data-storage:/var/lib/grafana

  k6:
    build: .
    networks:
      - k6
    ports:
      - "6565:6565"
    environment:
      - K6_PROMETHEUS_RW_SERVER_URL=http://prometheus:9090/api/v1/write
      - K6_PROMETHEUS_RW_TREND_AS_NATIVE_HISTOGRAM=true
      - K6_OUT=xk6-prometheus-rw
    depends_on:
      - prometheus
      - grafana
    volumes:
      - ./samples:/scripts
      - .:/app:delegated
    # k6 ê¸°ë™ì‹œ ì‘ì„±í–ˆë˜ basic_k6_test.js íŒŒì¼ì´ ì‹¤í–‰ë˜ë„ë¡ ì»¤ë§¨ë“œ ì‹¤í–‰
    command: run --vus 150 --duration 30s -o xk6-prometheus-rw /app/tests/basic_k6_test.js
```

# Step 6 :Â prometheus.yaml íŒŒì¼ ì‘ì„±

```yaml
# prometheus.yml
global:
  scrape_interval: 30s
  scrape_timeout: 10s
scrape_configs:
  - job_name: services
    metrics_path: /metrics
    static_configs:
      - targets:
          - 'prometheus:9090'
```

# **âœï¸ í”„ë¡œë©”í…Œìš°ìŠ¤ì™€ ê·¸ë¼íŒŒë‚˜ì—ì„œ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ë‚´ì—­ í™•ì¸**

# Step 1 : ë„ì»¤ ì‹¤í–‰

```
$ docker compose up

# ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰ì‹œ
$ docker compose up -d

# ì¼ë¶€ë§Œ ì‹¤í–‰í•  ì‹œ
$ docker compose up prometheus grafana
$ docker compose up k6
```

- k6 í…ŒìŠ¤íŠ¸ ìˆ˜í–‰ ë¡œê·¸

ë”ë³´ê¸°

# Step 2 :Â í”„ë¡œë©”í…Œìš°ìŠ¤ ì—°ê²° - http://localhost:9090

- í”„ë¡œë©”í…Œìš°ìŠ¤ì—ì„œ íƒ€ê¹ƒì„ ì¡°ì‚¬í•´ ë³´ë©´ k6ì— ê´€í•œ ë©”íŠ¸ë¦­ì´ í‘œì‹œë˜ë©°Â **add Panal í‚¤**ì™€ Execute ë²„íŠ¼ìœ¼ë¡œ ë‚´ìš©ì„ ì¶”ê°€ ê°€ëŠ¥

ë”ë³´ê¸°

# Step 3 :Â ê·¸ë¼íŒŒë‚˜ ì ‘ì†Â [http://localhost:3000](http://localhost:4000/)

- ìµœì´ˆ ì ‘ì† ì‹œ id/pwëŠ” ëª¨ë‘ admin

1) configuration(í†±ë‹ˆë°”í€´ ëª¨ì–‘) ì°¾ì•„ì„œ ë°ì´í„° ì†ŒìŠ¤ ì°¾ì•„ prometheus ì¶”ê°€

![](https://blog.kakaocdn.net/dn/cjc7pi/btsi2MprjDh/sBJgSftsmXlwJz3kkucKZk/img.png)

2) ë°˜ë“œì‹œ URLì„Â [http://prometheus:9090ìœ¼ë¡œ](http://prometheus:9090%EC%9C%BC%EB%A1%9C/)Â ì‘ì„±

![](https://blog.kakaocdn.net/dn/2szzm/btsiZWylH14/29EfPoYm74Yl7JPhTVME61/img.png)

# Step 4 : ê·¸ë¼íŒŒë‚˜ ëŒ€ì‹œë³´ë“œ í™•ì¸

- ì´ë¯¸Â [ì»¤ë®¤ë‹ˆí‹°ì— ì‘ì„±ëœ ëŒ€ì‹œë³´ë“œ](https://grafana.com/grafana/dashboards/16543-k6-load-testing-results-prometheus/)Â export ë˜í•œ ê°€ëŠ¥

![](https://blog.kakaocdn.net/dn/lALP5/btsi3qlXRAK/NPaXWaOia5ZCWATKDSb031/img.png)

# # TROUBLE SHOOTING LOG

# ğŸ“ ë¬¸ì œ 1 : docker compose up ì‹œ exit code 0ê³¼ í•¨ê»˜ k6ê°€ exited

# 1. í˜„ìƒ

```jsx
xk6-output-prometheus-remote-k6-1 exited with code 0
```

# 2. ì›ì¸

- docker-compose.yaml íŒŒì¼ì˜ k6ì— test ìŠ¤í¬ë¦½íŠ¸ ìˆ˜í–‰ commandë¥¼ ì…ë ¥í•˜ì§€ ì•Šì•„ ë°œìƒ

# 3. í•´ê²° ë°©ì•ˆ

- docker-compose.yaml íŒŒì¼ì— ì‘ì„±í•œ test ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë³¼ë¥¨ìœ¼ë¡œ ì¶”ê°€í•˜ê³ , command ìˆ˜í–‰í•˜ë„ë¡ ìˆ˜ì •

```yaml
  k6:
    build: . # í˜„ì¬ Dockerfileì„ buildí•˜ê² ë‹¤ëŠ” ì˜ë¯¸
    networks:
      - k6
    ports:
      - "6565:6565"
    environment:
      - K6_PROMETHEUS_RW_SERVER_URL=http://prometheus:9090/api/v1/write
      - K6_PROMETHEUS_RW_TREND_AS_NATIVE_HISTOGRAM=true
      - K6_OUT=xk6-prometheus-rw
    depends_on:
      - prometheus
      - grafana
    volumes:
      - ./samples:/scripts
      - .:/app:delegated #
    command: run --vus 150 --duration 30s -o xk6-prometheus-rw /app/tests/basic_k6_test.js
```

![](https://blog.kakaocdn.net/dn/d6WtiO/btsi2eT84h2/JxNdiP2wkiM0Pgt5y2r6P0/img.png)